<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Intelligence - Ops WH2 Premium</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Google Fonts: Outfit (Modern) + IBM Plex Sans Thai -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800;900&family=IBM+Plex+Sans+Thai:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-warm: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-cold: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-success: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --gradient-gold: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            --shadow-soft: 0 8px 32px -8px rgba(0, 0, 0, 0.12);
            --shadow-medium: 0 16px 48px -8px rgba(0, 0, 0, 0.18);
            --shadow-strong: 0 24px 64px -12px rgba(0, 0, 0, 0.24);
            --blur-glass: blur(16px);
        }

        * {
            box-sizing: border-box;
        }

        body { 
            font-family: 'IBM Plex Sans Thai', 'Outfit', sans-serif; 
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 50%, #1e3a8a 100%);
            background-attachment: fixed;
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            font-size: 16px;
            position: relative;
        }

        /* Animated Background Particles */
        body::before {
            content: '';
            position: fixed;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
                radial-gradient(circle at 40% 80%, rgba(236, 72, 153, 0.1) 0%, transparent 50%);
            animation: float 20s ease-in-out infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.1); }
            66% { transform: translate(-30px, 30px) scale(0.9); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        /* Sidebar Design with Glassmorphism */
        .sidebar { 
            width: 300px; 
            background: rgba(15, 23, 42, 0.85);
            backdrop-filter: var(--blur-glass);
            -webkit-backdrop-filter: var(--blur-glass);
            color: white; 
            flex-shrink: 0; 
            display: flex; 
            flex-direction: column; 
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); 
            overflow: hidden;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: var(--shadow-strong);
            position: relative;
            z-index: 10;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 300px;
            background: radial-gradient(circle at 50% 0%, rgba(251, 191, 36, 0.15), transparent);
            pointer-events: none;
        }

        .sidebar.collapsed { 
            width: 0; 
            padding: 0; 
            opacity: 0; 
            border-right: none;
        }
        
        .main-content { 
            flex-grow: 1; 
            overflow-y: auto; 
            display: flex; 
            flex-direction: column; 
            transition: all 0.4s ease;
            position: relative;
            z-index: 1;
        }
        
        /* Nav Styling with Modern Hover Effects */
        .nav-item { 
            padding: 1.25rem 1.75rem; 
            cursor: pointer; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            border-left: 4px solid transparent; 
            font-size: 15px; 
            font-weight: 600; 
            color: #cbd5e1; 
            display: flex; 
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.2), transparent);
            transition: width 0.3s ease;
        }

        .nav-item:hover::before {
            width: 100%;
        }

        .nav-item:hover { 
            background: rgba(30, 41, 59, 0.6); 
            color: #fbbf24;
            transform: translateX(8px);
        }

        .nav-item.active { 
            background: linear-gradient(90deg, rgba(251, 191, 36, 0.2) 0%, transparent 100%);
            color: #fbbf24; 
            border-left-color: #fbbf24; 
            font-weight: 800;
            transform: translateX(8px);
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: 20px;
            width: 8px;
            height: 8px;
            background: #fbbf24;
            border-radius: 50%;
            box-shadow: 0 0 12px #fbbf24;
            animation: pulse 2s ease-in-out infinite;
        }
        
        /* Modern Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { 
            width: 8px; 
            height: 8px; 
        }
        .custom-scrollbar::-webkit-scrollbar-track { 
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb { 
            background: linear-gradient(180deg, #fbbf24, #f59e0b);
            border-radius: 10px;
            transition: all 0.3s;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #fcd34d, #fbbf24);
        }
        
        /* Card Styling with Glass Effect */
        .stat-card { 
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-radius: 28px; 
            padding: 2.25rem; 
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: slideIn 0.6s ease-out;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
            transform: rotate(45deg);
            transition: all 0.6s;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card:hover { 
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-medium);
            border-color: rgba(251, 191, 36, 0.3);
        }

        /* Glass button effects */
        .glass-button {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .filter-menu { 
            display: none; 
            position: absolute; 
            top: 110%; 
            left: 0; 
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(16px);
            border-radius: 16px; 
            box-shadow: var(--shadow-medium);
            min-width: 240px; 
            z-index: 100; 
            padding: 12px; 
            border: 1px solid rgba(0, 0, 0, 0.08);
            animation: slideIn 0.3s ease-out;
        }
        .filter-menu.active { display: block; }
        .tab-content.hidden { display: none; }

        /* Enhanced loading spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Gradient text effect */
        .gradient-text {
            background: linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24);
            background-size: 200% 200%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: shimmer 3s ease-in-out infinite;
        }

        /* Status dot animation */
        @keyframes status-pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.1);
            }
        }

        .status-dot {
            animation: status-pulse 2s ease-in-out infinite;
        }

        /* Chart containers */
        .chart-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(12px);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            border: 1px solid rgba(0, 0, 0, 0.06);
            transition: all 0.3s;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-medium);
        }

        /* Premium header gradient */
        .header-gradient {
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
        }

        /* Stagger animation for cards */
        .stat-card:nth-child(1) { animation-delay: 0s; }
        .stat-card:nth-child(2) { animation-delay: 0.1s; }
        .stat-card:nth-child(3) { animation-delay: 0.2s; }
        .stat-card:nth-child(4) { animation-delay: 0.3s; }

        /* Progress bar animation */
        @keyframes progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(0); }
        }

        #progress-bar {
            animation: progress 1.5s ease-out;
        }

        /* Accent line decorations */
        .accent-line {
            height: 4px;
            background: linear-gradient(90deg, #fbbf24, transparent);
            border-radius: 2px;
        }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside id="main-sidebar" class="sidebar">
        <div class="p-8 border-b border-white/10 text-center relative">
            <h1 class="text-3xl font-black uppercase tracking-tighter">
                <span class="gradient-text">Ops</span> 
                <span class="text-white">WH2</span>
            </h1>
            <div class="text-[9px] font-bold text-slate-400 uppercase tracking-widest mt-1">Premium Intelligence</div>
            <div class="flex items-center justify-center mt-4">
                <div id="status-dot" class="status-dot w-3 h-3 bg-emerald-400 rounded-full mr-2 shadow-lg shadow-emerald-400/50"></div>
                <div id="load-status" class="text-[11px] text-slate-400 uppercase font-bold tracking-widest">System Ready</div>
            </div>
        </div>

        <nav class="flex-grow py-6 space-y-1.5 overflow-y-auto custom-scrollbar">
            <div onclick="switchTab('weight')" id="tab-weight" class="nav-item active">‚öñÔ∏è WEIGHT ANALYSIS</div>
            <div onclick="switchTab('shipment')" id="tab-shipment" class="nav-item">üöö SHIPMENT OPERATIONS</div>
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">üì¶ PRODUCT & CUSTOMER</div>
            <div onclick="switchTab('loading')" id="tab-loading" class="nav-item">‚è±Ô∏è LOADING TIME</div>
            <div onclick="switchTab('milkrun')" id="tab-milkrun" class="nav-item">üõª MILK RUN</div>
        </nav>

        <div class="p-6 space-y-4 border-t border-white/10 bg-black/20">
            <button onclick="fetchEverything()" class="w-full bg-gradient-to-r from-amber-400 to-amber-600 hover:from-amber-500 hover:to-amber-700 text-slate-900 text-xs font-black py-4 rounded-2xl transition-all shadow-xl hover:shadow-2xl active:scale-95 hover:scale-105">
                üîÑ REFRESH ALL DATA
            </button>
            <div class="space-y-2.5 text-[11px] font-bold text-slate-400 uppercase tracking-tight">
                <div class="flex justify-between items-center p-2 bg-white/5 rounded-xl">
                    <span>FG Records:</span> 
                    <span id="fg-count" class="text-white font-black text-base">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-white/5 rounded-xl">
                    <span>Milk Run:</span> 
                    <span id="mr-count" class="text-cyan-400 font-black text-base">0</span>
                </div>
            </div>
            <div class="w-full bg-slate-800/50 h-2 rounded-full overflow-hidden backdrop-blur">
                <div id="progress-bar" class="bg-gradient-to-r from-amber-400 to-amber-600 h-full w-0 transition-all duration-300 shadow-lg shadow-amber-500/50"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- LOADING POPUP -->
        <div id="loading-modal" class="fixed inset-0 bg-slate-900/80 z-50 hidden flex items-center justify-center backdrop-blur-md">
            <div class="bg-white rounded-[3rem] p-12 shadow-2xl max-w-sm w-full text-center border border-slate-200">
                <div class="spinner w-20 h-20 border-4 border-slate-100 border-t-amber-500 rounded-full mx-auto mb-6"></div>
                <h3 class="text-2xl font-black text-slate-800 mb-3 tracking-tight">Syncing Data</h3>
                <p id="modal-status" class="text-slate-500 text-sm mb-6 font-medium">Processing records...</p>
                <div class="w-full bg-slate-100 h-2.5 rounded-full overflow-hidden mb-4">
                    <div id="modal-progress" class="bg-gradient-to-r from-amber-400 to-amber-600 h-full w-0 transition-all shadow-lg"></div>
                </div>
                <div id="modal-log" class="text-[10px] font-mono text-slate-400 text-left h-24 overflow-y-auto bg-slate-50 p-3 rounded-2xl custom-scrollbar border border-slate-200"></div>
            </div>
        </div>
        
        <!-- HEADER -->
        <header class="header-gradient border-b border-white/20 px-8 py-6 sticky top-0 z-40 flex justify-between items-center shadow-lg">
            <div class="flex items-center space-x-6">
                <button onclick="toggleSidebar()" class="glass-button p-3 rounded-2xl text-slate-600 hover:text-slate-900 transition-all">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
                <div id="filters-container" class="flex items-center space-x-3"></div>
                <button onclick="clearAllFilters()" class="glass-button px-4 py-2 rounded-xl text-[11px] font-black text-slate-600 hover:text-amber-600 uppercase tracking-widest transition-all">
                    Reset
                </button>
            </div>
            <div class="flex items-center space-x-5">
                <div class="text-right">
                    <div id="tab-title" class="text-2xl font-black text-slate-800 uppercase tracking-tighter bg-gradient-to-r from-slate-800 to-slate-600 bg-clip-text">Weight Analysis</div>
                    <div class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Warehouse Intelligence</div>
                </div>
                <div id="title-bar" class="w-2 h-12 bg-gradient-to-b from-amber-400 to-amber-600 rounded-full shadow-lg shadow-amber-500/50"></div>
            </div>
        </header>

        <div id="content-body" class="p-8 md:p-12 space-y-12 pb-24 custom-scrollbar">
            
            <!-- SECTION: WEIGHT -->
            <div id="section-weight" class="tab-content space-y-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="stat-card border-l-8 border-amber-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Weight Out</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-out-w">0.00</span> <small class="text-base font-bold text-slate-400">Tons</small></div>
                        <div class="accent-line mt-4"></div>
                    </div>
                    <div class="stat-card border-l-8 border-emerald-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Weight In</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-in-w">0.00</span> <small class="text-base font-bold text-slate-400">Tons</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #10b981, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-rose-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Net Balance</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-balance">0.00</span> <small class="text-base font-bold text-slate-400">Tons</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #f43f5e, transparent);"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <canvas id="chartWeightOut" style="max-height: 350px;"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartWeightIn" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartShipToOut" style="max-height: 380px;"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="chartBinLocIn" style="max-height: 380px;"></canvas>
                </div>
            </div>

            <!-- SECTION: SHIPMENT -->
            <div id="section-shipment" class="tab-content hidden space-y-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="stat-card border-l-8 border-violet-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">DO Count</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-shipment-do">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #8b5cf6, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-blue-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">SKU Count</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-shipment-sku">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #3b82f6, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-cyan-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Shipments</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-shipment-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #06b6d4, transparent);"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <canvas id="chartShipTo" style="max-height: 350px;"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartDOStatus" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartSKUWeight" style="max-height: 380px;"></canvas>
                </div>
            </div>

            <!-- SECTION: PRODUCT -->
            <div id="section-product" class="tab-content hidden space-y-12">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="stat-card border-l-8 border-pink-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Products</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-product-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #ec4899, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-orange-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Customers</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-customer-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #f97316, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-indigo-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Invoices</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-invoice-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #6366f1, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-teal-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Total Weight</div>
                        <div class="text-4xl font-black text-slate-900"><span id="card-product-weight">0.00</span> <small class="text-sm font-bold text-slate-400">Tons</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #14b8a6, transparent);"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <canvas id="chartTopProducts" style="max-height: 400px;"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartTopCustomers" style="max-height: 400px;"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartProductWeight" style="max-height: 380px;"></canvas>
                </div>
            </div>

            <!-- SECTION: LOADING -->
            <div id="section-loading" class="tab-content hidden space-y-12">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
                    <div class="stat-card border-l-8 border-red-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Avg Time</div>
                        <div class="text-4xl font-black text-slate-900"><span id="card-loading-avg">0</span> <small class="text-sm font-bold text-slate-400">min</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #ef4444, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-green-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Min Time</div>
                        <div class="text-4xl font-black text-slate-900"><span id="card-loading-min">0</span> <small class="text-sm font-bold text-slate-400">min</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #22c55e, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-yellow-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Max Time</div>
                        <div class="text-4xl font-black text-slate-900"><span id="card-loading-max">0</span> <small class="text-sm font-bold text-slate-400">min</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #eab308, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-purple-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Total Loads</div>
                        <div class="text-5xl font-black text-slate-900"><span id="card-loading-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #a855f7, transparent);"></div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="chartLoadingTime" style="max-height: 400px;"></canvas>
                </div>
            </div>

            <!-- SECTION: MILK RUN -->
            <div id="section-milkrun" class="tab-content hidden space-y-12">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="stat-card border-l-8 border-sky-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Total Trips</div>
                        <div class="text-5xl font-black text-slate-900"><span id="mr-card-count">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #0ea5e9, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-lime-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Total Weight</div>
                        <div class="text-4xl font-black text-slate-900"><span id="mr-card-weight">0.00</span> <small class="text-sm font-bold text-slate-400">Tons</small></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #84cc16, transparent);"></div>
                    </div>
                    <div class="stat-card border-l-8 border-fuchsia-500">
                        <div class="text-[11px] font-black text-slate-400 uppercase mb-3 tracking-wider">Unique DOs</div>
                        <div class="text-5xl font-black text-slate-900"><span id="mr-card-do">0</span></div>
                        <div class="accent-line mt-4" style="background: linear-gradient(90deg, #d946ef, transparent);"></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="chart-container">
                        <canvas id="chartMilkRunTime" style="max-height: 350px;"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="chartDepositorCombo" style="max-height: 350px;"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="stat-card">
                        <div class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Check Capacity</div>
                        <div id="list-check-cap" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Depositor</div>
                        <div id="list-depositor" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Details</div>
                        <div id="list-details" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar"></div>
                    </div>
                    <div class="stat-card">
                        <div class="text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">Truck Type</div>
                        <div id="list-tt" class="space-y-2 max-h-80 overflow-y-auto custom-scrollbar"></div>
                    </div>
                </div>

                <div id="sap-analysis-container" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </div>
    </main>

    <script>
        const supabaseUrl = 'https://ydbqifkwefvjgdvlunfv.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlkYnFpZmt3ZWZ2amdkdmx1bmZ2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzU4MjA0MDMsImV4cCI6MjA1MTM5NjQwM30.x0p7pu9kLy5i6gx8iqYsObCLj1_xQZLBHwf19wC22xY';
        const sb = supabase.createClient(supabaseUrl, supabaseKey);

        const filters = { io: null, st: null, bl: null, c: null, dep: null };
        let fg = [], mr = [], sap = [];
        const activeCharts = {};
        Chart.register(ChartDataLabels);

        function showLoading(show) {
            document.getElementById('loading-modal').style.display = show ? 'flex' : 'none';
        }

        function updateLoadStatus(text, progress = 0) {
            document.getElementById('modal-status').innerText = text;
            document.getElementById('modal-progress').style.width = progress + '%';
            const log = document.getElementById('modal-log');
            const time = new Date().toLocaleTimeString();
            log.innerHTML += `<div>${time}: ${text}</div>`;
            log.scrollTop = log.scrollHeight;
        }

        async function fetchEverything() {
            showLoading(true);
            updateLoadStatus('Starting sync...', 0);
            const ds = document.getElementById('status-dot');
            const ls = document.getElementById('load-status');
            ds.className = 'status-dot w-3 h-3 bg-yellow-400 rounded-full mr-2 shadow-lg shadow-yellow-400/50';
            ls.innerText = 'Syncing...';

            try {
                updateLoadStatus('Fetching FG records...', 20);
                const r1 = await sb.from('vw_op_fg').select('*');
                if (r1.error) throw r1.error;
                fg = r1.data || [];

                updateLoadStatus('Fetching Milk Run data...', 50);
                const r2 = await sb.from('vw_op_mr').select('*');
                if (r2.error) throw r2.error;
                mr = r2.data || [];

                updateLoadStatus('Fetching SAP validation...', 70);
                const r3 = await sb.from('vw_sap_validation').select('*');
                if (r3.error) throw r3.error;
                sap = r3.data || [];

                updateLoadStatus('Processing data...', 90);
                document.getElementById('fg-count').innerText = f2(fg.length);
                document.getElementById('mr-count').innerText = f2(mr.length);
                runEngine();

                updateLoadStatus('Complete!', 100);
                setTimeout(() => {
                    showLoading(false);
                    ds.className = 'status-dot w-3 h-3 bg-emerald-400 rounded-full mr-2 shadow-lg shadow-emerald-400/50';
                    ls.innerText = 'System Ready';
                    document.getElementById('progress-bar').style.width = '100%';
                }, 500);
            } catch (err) {
                console.error(err);
                updateLoadStatus('Error: ' + err.message, 100);
                ds.className = 'status-dot w-3 h-3 bg-red-400 rounded-full mr-2 shadow-lg shadow-red-400/50';
                ls.innerText = 'Error';
                setTimeout(() => showLoading(false), 2000);
            }
        }

        function getVal(r, keys) { for (let k of keys) if (r[k] != null) return r[k]; return null; }
        function f2(n) { return parseFloat(n || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }

        function clearAllFilters() {
            filters.io = filters.st = filters.bl = filters.c = filters.dep = null;
            runEngine();
        }

        function runEngine() {
            let d = fg;
            if (filters.io) d = d.filter(r => getVal(r, ['In/Out', 'InOut']) === filters.io);
            if (filters.st) d = d.filter(r => getVal(r, ['Ship To', 'ShipTo']) === filters.st);
            if (filters.bl) d = d.filter(r => getVal(r, ['Bin Location', 'BinLocation']) === filters.bl);
            if (filters.c) d = d.filter(r => getVal(r, ['Customer', 'customer']) === filters.c);
            
            renderFilters();
            renderWeight(d);
            renderShipment(d);
            renderProduct(d);
            renderLoading(d);

            let md = mr;
            if (filters.dep) md = md.filter(r => getVal(r, ['Depositor', 'depositor']) === filters.dep);
            renderMilkRun(md);
        }

        function renderFilters() {
            const fc = document.getElementById('filters-container');
            fc.innerHTML = Object.entries(filters).filter(([k, v]) => v !== null).map(([k, v]) => `
                <div class="glass-button px-4 py-2.5 rounded-xl text-xs font-bold text-slate-700 flex items-center space-x-2 shadow-md">
                    <span class="uppercase tracking-wide">${k}: ${v}</span>
                    <button onclick="filters.${k}=null; runEngine()" class="ml-2 text-rose-500 hover:text-rose-700 font-black transition-colors">‚úï</button>
                </div>
            `).join('');
        }

        function renderWeight(d) {
            const out = d.filter(r => getVal(r, ['In/Out', 'InOut']) === 'Out');
            const inp = d.filter(r => getVal(r, ['In/Out', 'InOut']) === 'In');
            const wOut = out.reduce((s, r) => s + parseFloat(getVal(r, ['Weight', 'weight']) || 0), 0);
            const wIn = inp.reduce((s, r) => s + parseFloat(getVal(r, ['Weight', 'weight']) || 0), 0);
            const bal = wOut - wIn;

            document.getElementById('card-out-w').innerText = f2(wOut / 1000);
            document.getElementById('card-in-w').innerText = f2(wIn / 1000);
            document.getElementById('card-balance').innerText = f2(bal / 1000);

            const customerOut = {}, shipToOut = {}, productOut = {};
            out.forEach(r => {
                const c = getVal(r, ['Customer', 'customer']) || 'Unknown';
                const st = getVal(r, ['Ship To', 'ShipTo']) || 'Unknown';
                const p = getVal(r, ['Product', 'product']) || 'Unknown';
                const w = parseFloat(getVal(r, ['Weight', 'weight']) || 0);
                customerOut[c] = (customerOut[c] || 0) + w;
                shipToOut[st] = (shipToOut[st] || 0) + w;
                productOut[p] = (productOut[p] || 0) + w;
            });

            const binLocIn = {}, productIn = {};
            inp.forEach(r => {
                const bl = getVal(r, ['Bin Location', 'BinLocation']) || 'Unknown';
                const p = getVal(r, ['Product', 'product']) || 'Unknown';
                const w = parseFloat(getVal(r, ['Weight', 'weight']) || 0);
                binLocIn[bl] = (binLocIn[bl] || 0) + w;
                productIn[p] = (productIn[p] || 0) + w;
            });

            draw('chartWeightOut', 'pie', customerOut, wOut, 'Weight Out by Customer');
            draw('chartWeightIn', 'pie', productIn, wIn, 'Weight In by Product');
            draw('chartShipToOut', 'bar', shipToOut, wOut, 'Weight Out by Ship To');
            draw('chartBinLocIn', 'bar', binLocIn, wIn, 'Weight In by Bin Location');
        }

        function renderShipment(d) {
            const shipTo = {}, doStatus = {}, skuWeight = {};
            const doSet = new Set(), skuSet = new Set();

            d.forEach(r => {
                const st = getVal(r, ['Ship To', 'ShipTo']) || 'Unknown';
                const dos = getVal(r, ['DO Status', 'DOStatus']) || 'Unknown';
                const sku = getVal(r, ['SKU', 'sku']) || 'Unknown';
                const w = parseFloat(getVal(r, ['Weight', 'weight']) || 0);
                const doNo = getVal(r, ['DO No', 'DONo']) || '';

                shipTo[st] = (shipTo[st] || 0) + 1;
                doStatus[dos] = (doStatus[dos] || 0) + 1;
                skuWeight[sku] = (skuWeight[sku] || 0) + w;
                if (doNo) doSet.add(doNo);
                if (sku) skuSet.add(sku);
            });

            document.getElementById('card-shipment-do').innerText = f2(doSet.size);
            document.getElementById('card-shipment-sku').innerText = f2(skuSet.size);
            document.getElementById('card-shipment-count').innerText = f2(d.length);

            const totalWeight = Object.values(skuWeight).reduce((s, v) => s + v, 0);
            draw('chartShipTo', 'pie', shipTo, d.length, 'Shipments by Ship To', true);
            draw('chartDOStatus', 'pie', doStatus, d.length, 'DO Status Distribution', true);
            draw('chartSKUWeight', 'bar', skuWeight, totalWeight, 'Weight by SKU');
        }

        function renderProduct(d) {
            const products = {}, customers = {}, invoices = {};
            let totalW = 0;

            d.forEach(r => {
                const p = getVal(r, ['Product', 'product']) || 'Unknown';
                const c = getVal(r, ['Customer', 'customer']) || 'Unknown';
                const inv = getVal(r, ['Invoice', 'invoice']) || 'Unknown';
                const w = parseFloat(getVal(r, ['Weight', 'weight']) || 0);

                products[p] = (products[p] || 0) + w;
                customers[c] = (customers[c] || 0) + w;
                invoices[inv] = (invoices[inv] || 0) + 1;
                totalW += w;
            });

            document.getElementById('card-product-count').innerText = f2(Object.keys(products).length);
            document.getElementById('card-customer-count').innerText = f2(Object.keys(customers).length);
            document.getElementById('card-invoice-count').innerText = f2(Object.keys(invoices).length);
            document.getElementById('card-product-weight').innerText = f2(totalW / 1000);

            const topP = Object.entries(products).sort((a, b) => b[1] - a[1]).slice(0, 10).reduce((o, [k, v]) => ({ ...o, [k]: v }), {});
            const topC = Object.entries(customers).sort((a, b) => b[1] - a[1]).slice(0, 10).reduce((o, [k, v]) => ({ ...o, [k]: v }), {});

            draw('chartTopProducts', 'bar', topP, totalW, 'Top 10 Products by Weight');
            draw('chartTopCustomers', 'bar', topC, totalW, 'Top 10 Customers by Weight');
            draw('chartProductWeight', 'bar', products, totalW, 'All Products Weight Distribution');
        }

        function renderLoading(d) {
            const times = d.map(r => parseFloat(getVal(r, ['Loading Time', 'LoadingTime']) || 0)).filter(t => t > 0);
            if (times.length === 0) {
                document.getElementById('card-loading-avg').innerText = '0';
                document.getElementById('card-loading-min').innerText = '0';
                document.getElementById('card-loading-max').innerText = '0';
                document.getElementById('card-loading-count').innerText = '0';
                return;
            }

            const avg = times.reduce((s, t) => s + t, 0) / times.length;
            const min = Math.min(...times);
            const max = Math.max(...times);

            document.getElementById('card-loading-avg').innerText = f2(avg);
            document.getElementById('card-loading-min').innerText = f2(min);
            document.getElementById('card-loading-max').innerText = f2(max);
            document.getElementById('card-loading-count').innerText = f2(times.length);

            const buckets = { '0-30': 0, '30-60': 0, '60-90': 0, '90-120': 0, '120+': 0 };
            times.forEach(t => {
                if (t < 30) buckets['0-30']++;
                else if (t < 60) buckets['30-60']++;
                else if (t < 90) buckets['60-90']++;
                else if (t < 120) buckets['90-120']++;
                else buckets['120+']++;
            });

            draw('chartLoadingTime', 'bar', buckets, times.length, 'Loading Time Distribution (minutes)', true);
        }

        function renderMilkRun(d) {
            const tp = new Set(), dst = {}, dpt = {}, dtl = {}, tt = {}, st = { comp: {}, canc: {} };
            let tw = 0, tdo = 0;
            const perf = {};

            d.forEach(r => {
                const id = getVal(r, ['ID Trip', 'IDTrip']) || Math.random();
                tp.add(id);
                const cap = getVal(r, ['Check Capacity', 'CheckCapacity']) || 'Unknown';
                const dep = getVal(r, ['Depositor', 'Depositor']) || 'Unknown';
                const det = getVal(r, ['Details', 'Details']) || 'Unknown';
                const truck = getVal(r, ['TT', 'TT']) || 'Unknown';
                const w = parseFloat(getVal(r, ['Weight', 'Weight']) || 0);
                const ct = getVal(r, ['Completion Time Slot', 'CompletionTimeSlot']) || 'Unknown';
                const stat = getVal(r, ['Status', 'Status']) || 'Unknown';
                const doCnt = parseInt(getVal(r, ['DO Count', 'DOCount']) || 0);

                dst[cap] = (dst[cap] || 0) + 1;
                dpt[dep] = (dpt[dep] || 0) + 1;
                dtl[det] = (dtl[det] || 0) + 1;
                tt[truck] = (tt[truck] || 0) + 1;
                tw += w;
                tdo += doCnt;

                if (!perf[dep]) perf[dep] = { w: 0, do: 0 };
                perf[dep].w += w;
                perf[dep].do += doCnt;

                if (stat === 'Completed') st.comp[ct] = (st.comp[ct] || 0) + 1;
                else if (stat === 'Cancelled') st.canc[ct] = (st.canc[ct] || 0) + 1;
            });
            document.getElementById('mr-card-count').innerText = f2(tp.size);
            document.getElementById('mr-card-weight').innerText = f2(tw);
            document.getElementById('mr-card-do').innerText = f2(tdo);
            
            const fill = (id, map, isF=false) => {
                const s = Object.entries(map).sort((a,b)=>b[1]-a[1]);
                document.getElementById(id).innerHTML = s.map(([k,v]) => `
                    <div class="flex justify-between items-center p-3 bg-gradient-to-r from-slate-50 to-white rounded-xl text-xs shadow-sm hover:shadow-md transition-all ${isF?'cursor-pointer hover:from-amber-50 hover:to-amber-100':''}" ${isF?`onclick="filters.dep='${k}';runEngine()"`:''}>
                        <span class="truncate font-bold w-4/5 text-slate-700" title="${k}">${k}</span>
                        <span class="font-black text-slate-900 bg-white px-2 py-1 rounded-lg shadow-sm">${v}</span>
                    </div>`).join('');
            };
            fill('list-check-cap', dst); fill('list-depositor', dpt, true); fill('list-details', dtl); fill('list-tt', tt);

            const slots = Array.from(new Set([...Object.keys(st.comp), ...Object.keys(st.canc)])).sort();
            const ctxT = document.getElementById('chartMilkRunTime');
            if (activeCharts['mrT']) activeCharts['mrT'].destroy();
            activeCharts['mrT'] = new Chart(ctxT, {
                type: 'bar',
                data: { labels: slots, datasets: [
                    { label: 'Completed', data: slots.map(s=>st.comp[s]||0), backgroundColor: '#10b981', borderRadius: 8 },
                    { label: 'Cancelled', data: slots.map(s=>st.canc[s]||0), backgroundColor: '#ef4444', borderRadius: 8 }
                ]},
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { 
                        title: { display: true, text: 'Trips by Completion Time Slot', font: { size: 16, weight: 'bold' } },
                        datalabels: { color: '#fff', font: { weight: 'bold', size: 11 }, formatter: v => v > 0 ? v : '' }
                    },
                    scales: { x:{stacked:true}, y:{stacked:true} } 
                }
            });

            const depL = Object.keys(perf).sort();
            const ctxD = document.getElementById('chartDepositorCombo');
            if (activeCharts['mrD']) activeCharts['mrD'].destroy();
            activeCharts['mrD'] = new Chart(ctxD, {
                type: 'bar',
                data: { labels: depL, datasets: [
                    { label: 'DO Count', data: depL.map(l=>perf[l].do), type:'line', borderColor:'#3b82f6', yAxisID:'y1', pointRadius:5, borderWidth: 3, tension: 0.3 },
                    { label: 'Weight (Tons)', data: depL.map(l=>perf[l].w), backgroundColor: '#f59e0b', yAxisID:'y', borderRadius:8 }
                ]},
                options: { 
                    maintainAspectRatio: false, 
                    plugins: { 
                        title: { display: true, text: 'Depositor Productivity Analysis', font: { size: 16, weight: 'bold' } },
                        datalabels: { display: true, anchor: 'end', align: 'top', font: { weight: 'bold', size: 10 }, formatter: (v, ctx) => ctx.dataset.type === 'line' ? '' : f2(v) }
                    },
                    scales: { y1:{position:'right', grid:{display:false}} }
                }
            });

            const sapG = {}; sap.forEach(r => { const s=getVal(r, ['Check Milk Run', 'CheckMilkRun'])||'Unknown'; sapG[s]=(sapG[s]||0)+1; });
            document.getElementById('sap-analysis-container').innerHTML = Object.entries(sapG).map(([k,v]) => `
                <div class="stat-card border-t-8 border-pink-500">
                    <div class="text-[11px] font-black text-slate-400 uppercase mb-2 tracking-wider">SAP Validation</div>
                    <div class="text-sm font-bold text-slate-800 mb-3 truncate">${k}</div>
                    <div class="text-5xl font-black text-slate-900">${f2(v)}</div>
                    <div class="accent-line mt-4" style="background: linear-gradient(90deg, #ec4899, transparent);"></div>
                </div>`).join('');
        }

        function draw(id, type, map, total, title, isC=false) {
            const ctx = document.getElementById(id); if (!ctx) return;
            if (activeCharts[id]) activeCharts[id].destroy();
            const s = Object.entries(map).sort((a,b)=>b[1]-a[1]);
            const l = s.map(x=>x[0]);
            const d = s.map(x=> isC ? x[1] : x[1]/1000);
            
            const colors = ['#f59e0b','#3b82f6','#10b981','#f43f5e','#8b5cf6','#6366f1', '#06b6d4', '#ec4899', '#14b8a6'];

            activeCharts[id] = new Chart(ctx, {
                type, 
                data: { labels: l, datasets: [{ data: d, backgroundColor: colors, borderRadius: type==='bar' ? 10 : 0, borderWidth: type==='pie' ? 2 : 0, borderColor: '#fff' }] },
                options: {
                    indexAxis: type==='bar'?'y':'x',
                    maintainAspectRatio: false,
                    plugins: { 
                        title: { display: true, text: title, font: { size: 18, weight: 'bold' }, padding: { top: 12, bottom: 24 } },
                        legend: { display: type==='pie', position: 'bottom', labels: { boxWidth: 14, padding: 24, font: { weight: 'bold', size: 11 } } },
                        datalabels: { 
                            display: true,
                            color: type==='pie' ? '#1e293b' : '#fff', 
                            anchor: type === 'bar' ? 'center' : 'center',
                            align: type === 'bar' ? 'center' : 'center',
                            offset: 0,
                            font: { weight: 'bold', size: 11 },
                            backgroundColor: type === 'pie' ? 'rgba(255,255,255,0.85)' : 'transparent',
                            borderRadius: 6,
                            padding: 6,
                            formatter: (v) => {
                                const realTotal = isC ? total : total/1000;
                                const pct = realTotal > 0 ? (v / realTotal * 100).toFixed(1) : 0;
                                if (type==='pie') {
                                    return pct > 3 ? `${f2(v)}\n(${pct}%)` : '';
                                }
                                return `${f2(v)} (${pct}%)`;
                            }
                        }
                    },
                    scales: {
                        x: { display: type==='bar' ? false : true, grid: { display: false }, ticks: { font: { weight: 'bold' } } },
                        y: { display: type==='bar' ? true : false, grid: { display: false }, ticks: { font: { weight: 'bold' } } }
                    }
                }
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`section-${t}`).classList.remove('hidden');
            document.getElementById(`tab-${t}`).classList.add('active');
            const titles = { weight: 'Weight Analysis', shipment: 'Shipment Operations', product: 'Product & Customer', loading: 'Loading Time', milkrun: 'Milk Run Analysis' };
            document.getElementById('tab-title').innerText = titles[t];
        }

        function toggleSidebar() { document.getElementById('main-sidebar').classList.toggle('collapsed'); }

        window.onload = fetchEverything;
    </script>
</body>
</html>
