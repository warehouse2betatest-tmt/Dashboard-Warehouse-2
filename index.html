<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Warehouse Intelligence - Sarabun Edition</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; }
        .sidebar.collapsed { width: 0; padding: 0; opacity: 0; }
        
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; }
        
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; white-space: nowrap; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chart-scroll-container::-webkit-scrollbar { height: 8px; }
        .chart-scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .chart-scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chart-scroll-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .max-w-\[200px\] { max-width: 200px; }
        .whitespace-nowrap { white-space: nowrap; }
    </style>
</head>
<body>
    <noscript>
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #1e293b; color: white; display: flex; align-items: center; justify-content: center; z-index: 9999; font-family: 'Sarabun', sans-serif;">
            <div style="text-align: center; padding: 2rem;">
                <h1 style="font-size: 3rem; margin-bottom: 1rem;">‚ö†Ô∏è</h1>
                <h2 style="font-size: 1.5rem; margin-bottom: 0.5rem;">JavaScript Required</h2>
                <p style="color: #94a3b8;">Please enable JavaScript to use this application.</p>
            </div>
        </div>
    </noscript>

    <!-- SIDEBAR -->
    <aside id="main-sidebar" class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic whitespace-nowrap">Ops <span class="text-white">WH2</span></h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest whitespace-nowrap">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1 overflow-y-auto custom-scrollbar">
            <div data-tab="weight" class="nav-item active">
                <span class="mr-2">‚öñÔ∏è</span> WEIGHT ANALYSIS
            </div>
            <div data-tab="shipment" class="nav-item">
                <span class="mr-2">üöö</span> SHIPMENT OPERATIONS
            </div>
            <div data-tab="product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT & CUSTOMER
            </div>
            <div data-tab="loading" class="nav-item">
                <span class="mr-2">‚è±Ô∏è</span> LOADING TIME
            </div>
            <div data-tab="milkrun" class="nav-item">
                <span class="mr-2">üõª</span> MILK RUN
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button id="refresh-btn" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-4 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">FG In-Out Rows</span>
                <span id="data-count-info" class="text-sm text-white font-mono font-bold">0</span>
            </div>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">LoadingTime Rows</span>
                <span id="loading-count-info" class="text-sm text-emerald-400 font-mono font-bold">0</span>
            </div>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">Milk Run Rows</span>
                <span id="milkrun-count-info" class="text-sm text-blue-400 font-mono font-bold">0</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- LOADING POPUP -->
        <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-md w-full mx-4 text-center">
                <div class="mb-6 flex justify-center">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin"></div>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-3" id="modal-title">Loading Data</h3>
                <p class="text-slate-600 font-medium mb-2" id="modal-subtitle">Synchronizing databases...</p>
                
                <div class="mt-6 space-y-2 text-left text-sm font-medium">
                    <div class="flex justify-between items-center"><span>üîπ FG In-Out Data</span><span id="status-inout" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ LoadingTime Data</span><span id="status-loading" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ Milk Run Data</span><span id="status-milkrun" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ SKU Master Data</span><span id="status-sku" class="text-slate-400">Pending...</span></div>
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <header class="bg-white shadow-sm p-6 sticky top-0 z-40">
            <div class="flex justify-between items-center">
                <h2 id="page-title" class="text-3xl font-black text-slate-800 uppercase tracking-wide">‚öñÔ∏è Weight Analysis</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase">Last Updated</div>
                        <div id="last-updated" class="text-sm text-slate-800 font-mono font-bold">Never</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- FILTERS -->
        <section id="filter-section" class="bg-gradient-to-r from-slate-50 to-slate-100 p-6 shadow-sm sticky top-[100px] z-30">
            <div class="grid grid-cols-3 gap-4">
                
                <div class="relative">
                    <button id="filter-btn-month" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üìÖ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Month</span><span id="label-month" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-month" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Month</div>
                        <div id="list-month" class="filter-list space-y-1"></div>
                    </div>
                </div>

                <div class="relative">
                    <button id="filter-btn-flow" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üîÑ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Flow</span><span id="label-flow" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-flow" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Flow</div>
                        <div id="list-flow" class="filter-list space-y-1"></div>
                    </div>
                </div>

                <div class="relative">
                    <button id="filter-btn-transporter" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üöõ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Transporter</span><span id="label-transporter" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-transporter" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Transporter</div>
                        <div id="list-transporter" class="filter-list space-y-1"></div>
                    </div>
                </div>

            </div>
        </section>

        <!-- CONTENT TABS -->
        <div class="flex-grow p-6 space-y-6">

            <!-- TAB: WEIGHT ANALYSIS -->
            <div id="content-weight" class="tab-content">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Weight (In)</div>
                        <div id="sum-weight-in" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Weight (Out)</div>
                        <div id="sum-weight-out" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Combined Total</div>
                        <div id="sum-weight-total" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üîµ Weight by Month (In)</h3>
                        <div class="h-[360px]"><canvas id="chart-month-in"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üî¥ Weight by Month (Out)</h3>
                        <div class="h-[360px]"><canvas id="chart-month-out"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üü¢ Weight by Day (In)</h3>
                        <div class="h-[360px]"><canvas id="chart-day-in"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üü† Weight by Day (Out)</h3>
                        <div class="h-[360px]"><canvas id="chart-day-out"></canvas></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                    <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üîµüî¥ Combined In + Out by Month</h3>
                    <div class="h-[400px]"><canvas id="chart-month-combined"></canvas></div>
                </div>
            </div>

            <!-- Other tabs placeholder -->
            <div id="content-shipment" class="tab-content hidden">
                <div class="bg-white p-10 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-slate-600">üöö Shipment Operations</p>
                    <p class="text-slate-400 mt-2">Tab content will load after data is fetched</p>
                </div>
            </div>

            <div id="content-product" class="tab-content hidden">
                <div class="bg-white p-10 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-slate-600">üì¶ Product & Customer</p>
                    <p class="text-slate-400 mt-2">Tab content will load after data is fetched</p>
                </div>
            </div>

            <div id="content-loading" class="tab-content hidden">
                <div class="bg-white p-10 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-slate-600">‚è±Ô∏è Loading Time</p>
                    <p class="text-slate-400 mt-2">Tab content will load after data is fetched</p>
                </div>
            </div>

            <div id="content-milkrun" class="tab-content hidden">
                <div class="bg-white p-10 rounded-2xl shadow-lg text-center">
                    <p class="text-2xl font-bold text-slate-600">üõª Milk Run</p>
                    <p class="text-slate-400 mt-2">Tab content will load after data is fetched</p>
                </div>
            </div>

        </div>
    </main>

    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

    <script>
        console.log('Script loading...');
        
        // Utility Functions
        const sanitizeHTML = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };

        const safeParseFloat = (val) => {
            const parsed = parseFloat(val);
            return isNaN(parsed) ? 0 : parsed;
        };

        const safeParsDate = (dateStr) => {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        };

        // Supabase Configuration
        const SUPABASE_URL = 'https://nqnqcctqdfdbizfdgtjk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xbnFjY3RxZGZkYml6ZmRndGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxNzE2NzcsImV4cCI6MjA1MTc0NzY3N30.AhLr1yp1j-xq3LJ1OZSh1r0LoqoQFZKy7zZsMpHhzHs';
        
        let supabase;
        let isSupabaseReady = false;

        const initSupabase = () => {
            try {
                if (typeof window.supabase === 'undefined') {
                    console.error('Supabase library not loaded');
                    return false;
                }
                
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                console.log('‚úì Supabase initialized');
                return true;
            } catch (error) {
                console.error('‚úó Supabase init failed:', error);
                return false;
            }
        };

        // State Management
        const appState = {
            rawData: [],
            loadingData: [],
            milkrunData: [],
            skuData: [],
            filters: { month: 'All', flow: 'All', transporter: 'All' },
            activeTab: 'weight',
            isLoading: false,
            lastUpdate: null
        };

        const activeCharts = {};

        // Error Handling
        const showError = (message) => {
            console.error(message);
            const modal = document.getElementById('loading-modal');
            if (modal) {
                modal.classList.remove('hidden');
                const title = document.getElementById('modal-title');
                const subtitle = document.getElementById('modal-subtitle');
                const spinner = document.getElementById('loading-spinner');
                
                if (title) title.textContent = '‚ö†Ô∏è Error';
                if (subtitle) subtitle.textContent = sanitizeHTML(message);
                if (spinner) {
                    spinner.classList.remove('animate-spin');
                    spinner.innerHTML = '<div class="text-6xl">‚ö†Ô∏è</div>';
                    spinner.className = 'text-red-500';
                }
            }
            updateConnectionStatus(false);
        };

        // Data Fetching
        const fetchEverything = async () => {
            if (appState.isLoading) {
                console.log('Already loading...');
                return;
            }
            
            if (!isSupabaseReady) {
                console.log('Initializing Supabase...');
                isSupabaseReady = initSupabase();
                if (!isSupabaseReady) {
                    showError('Cannot connect to database. Please refresh.');
                    return;
                }
            }
            
            appState.isLoading = true;
            const modal = document.getElementById('loading-modal');
            if (modal) modal.classList.remove('hidden');

            const updateStatus = (id, text, isSuccess = false) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = text;
                    el.className = isSuccess ? 'text-emerald-500 font-bold' : 'text-amber-500';
                }
            };

            try {
                let progress = 0;
                const updateProgress = () => {
                    progress += 25;
                    const bar = document.getElementById('progress-bar');
                    if (bar) bar.style.width = `${Math.min(progress, 100)}%`;
                };

                // Fetch with timeout
                const fetchWithTimeout = async (promise, timeout = 30000) => {
                    return Promise.race([
                        promise,
                        new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('Timeout')), timeout)
                        )
                    ]);
                };

                // FG In-Out
                updateStatus('status-inout', 'Loading...');
                try {
                    const { data, error } = await fetchWithTimeout(
                        supabase.from('WH2_FG_InOut').select('*').order('Date_Time', { ascending: false }).limit(5000)
                    );
                    if (error) throw error;
                    appState.rawData = data || [];
                    updateStatus('status-inout', `‚úì ${appState.rawData.length}`, true);
                    console.log('‚úì FG In-Out:', appState.rawData.length);
                } catch (e) {
                    console.error('‚úó FG In-Out:', e);
                    updateStatus('status-inout', '‚úó Failed', false);
                }
                updateProgress();

                // LoadingTime
                updateStatus('status-loading', 'Loading...');
                try {
                    const { data, error } = await fetchWithTimeout(
                        supabase.from('WH2_LoadingTime').select('*').order('LoadingDate', { ascending: false }).limit(5000)
                    );
                    if (error) throw error;
                    appState.loadingData = data || [];
                    updateStatus('status-loading', `‚úì ${appState.loadingData.length}`, true);
                    console.log('‚úì LoadingTime:', appState.loadingData.length);
                } catch (e) {
                    console.error('‚úó LoadingTime:', e);
                    updateStatus('status-loading', '‚úó Failed', false);
                }
                updateProgress();

                // Milk Run
                updateStatus('status-milkrun', 'Loading...');
                try {
                    const { data, error } = await fetchWithTimeout(
                        supabase.from('WH2_MILK_RUN').select('*').order('Date', { ascending: false }).limit(5000)
                    );
                    if (error) throw error;
                    appState.milkrunData = data || [];
                    updateStatus('status-milkrun', `‚úì ${appState.milkrunData.length}`, true);
                    console.log('‚úì Milk Run:', appState.milkrunData.length);
                } catch (e) {
                    console.error('‚úó Milk Run:', e);
                    updateStatus('status-milkrun', '‚úó Failed', false);
                }
                updateProgress();

                // SKU Master
                updateStatus('status-sku', 'Loading...');
                try {
                    const { data, error } = await fetchWithTimeout(
                        supabase.from('Master_data_SKU').select('*').limit(5000)
                    );
                    if (error) throw error;
                    appState.skuData = data || [];
                    updateStatus('status-sku', `‚úì ${appState.skuData.length}`, true);
                    console.log('‚úì SKU Master:', appState.skuData.length);
                } catch (e) {
                    console.error('‚úó SKU Master:', e);
                    updateStatus('status-sku', '‚úó Failed', false);
                }
                updateProgress();

                // Update UI
                appState.lastUpdate = new Date();
                updateDataCountUI();
                updateLastUpdatedUI();
                buildFilters();
                redrawAll();

                setTimeout(() => {
                    if (modal) modal.classList.add('hidden');
                    updateConnectionStatus(true);
                }, 1000);

            } catch (error) {
                console.error('Fetch error:', error);
                showError(error.message || 'Failed to load data');
            } finally {
                appState.isLoading = false;
            }
        };

        // UI Updates
        const updateDataCountUI = () => {
            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val.toLocaleString();
            };
            set('data-count-info', appState.rawData.length);
            set('loading-count-info', appState.loadingData.length);
            set('milkrun-count-info', appState.milkrunData.length);
        };

        const updateLastUpdatedUI = () => {
            const el = document.getElementById('last-updated');
            if (el && appState.lastUpdate) {
                el.textContent = appState.lastUpdate.toLocaleTimeString('th-TH');
            }
        };

        const updateConnectionStatus = (connected) => {
            const dot = document.getElementById('status-dot');
            const status = document.getElementById('load-status');
            if (dot) dot.className = `w-3 h-3 rounded-full mr-2 ${connected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`;
            if (status) {
                status.textContent = connected ? 'Connected' : 'Disconnected';
                status.className = `text-xs uppercase font-bold tracking-widest whitespace-nowrap ${connected ? 'text-emerald-400' : 'text-red-400'}`;
            }
        };

        // Filtering
        const extractMonth = (dateStr) => {
            const date = safeParsDate(dateStr);
            if (!date) return null;
            return date.toLocaleString('en-US', { year: 'numeric', month: 'short' });
        };

        const buildFilters = () => {
            const monthSet = new Set();
            [...appState.rawData, ...appState.loadingData, ...appState.milkrunData].forEach(r => {
                const m = extractMonth(r.Date_Time || r.LoadingDate || r.Date);
                if (m) monthSet.add(m);
            });
            populateFilter('month', Array.from(monthSet).sort());

            const flowSet = new Set();
            appState.rawData.forEach(r => { if (r.FLOW) flowSet.add(r.FLOW.trim()); });
            populateFilter('flow', Array.from(flowSet).sort());

            const transSet = new Set();
            [...appState.rawData, ...appState.loadingData].forEach(r => {
                if (r.Transporter) transSet.add(r.Transporter.trim());
            });
            populateFilter('transporter', Array.from(transSet).sort());
        };

        const populateFilter = (type, values) => {
            const list = document.getElementById(`list-${type}`);
            if (!list) return;
            const items = ['All', ...values];
            list.innerHTML = items.map(val => {
                const safe = sanitizeHTML(val);
                return `<div class="filter-item px-3 py-2 rounded-lg hover:bg-slate-100 cursor-pointer transition text-sm font-medium text-slate-700" data-type="${type}" data-value="${safe}">${safe}</div>`;
            }).join('');
        };

        const applyFilters = () => {
            return appState.rawData.filter(row => {
                const monthMatch = appState.filters.month === 'All' || extractMonth(row.Date_Time) === appState.filters.month;
                const flowMatch = appState.filters.flow === 'All' || (row.FLOW && row.FLOW.trim() === appState.filters.flow);
                const transMatch = appState.filters.transporter === 'All' || (row.Transporter && row.Transporter.trim() === appState.filters.transporter);
                return monthMatch && flowMatch && transMatch;
            });
        };

        // Tab Switching
        const switchTab = (tab) => {
            if (appState.activeTab === tab) return;
            appState.activeTab = tab;

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-tab') === tab) item.classList.add('active');
            });

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            const activeContent = document.getElementById(`content-${tab}`);
            if (activeContent) activeContent.classList.remove('hidden');

            const titles = {
                weight: '‚öñÔ∏è Weight Analysis',
                shipment: 'üöö Shipment Operations',
                product: 'üì¶ Product & Customer',
                loading: '‚è±Ô∏è Loading Time',
                milkrun: 'üõª Milk Run'
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.textContent = titles[tab] || '';

            redrawAll();
        };

        // Chart Drawing
        const redrawAll = () => {
            const filtered = applyFilters();
            if (appState.activeTab === 'weight') {
                drawWeightTab(filtered);
            }
        };

        const drawWeightTab = (data) => {
            const inData = data.filter(r => r.FLOW === 'IN');
            const outData = data.filter(r => r.FLOW === 'OUT');

            const sumIn = inData.reduce((sum, r) => sum + safeParseFloat(r.Weight), 0);
            const sumOut = outData.reduce((sum, r) => sum + safeParseFloat(r.Weight), 0);

            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val;
            };

            set('sum-weight-in', (sumIn / 1000).toFixed(2));
            set('sum-weight-out', (sumOut / 1000).toFixed(2));
            set('sum-weight-total', ((sumIn + sumOut) / 1000).toFixed(2));

            // Draw simple charts (Chart.js required)
            if (typeof Chart !== 'undefined') {
                drawSimpleChart('chart-month-in', groupByMonth(inData), '#3b82f6');
                drawSimpleChart('chart-month-out', groupByMonth(outData), '#ef4444');
                drawSimpleChart('chart-day-in', groupByDay(inData), '#10b981');
                drawSimpleChart('chart-day-out', groupByDay(outData), '#f59e0b');
                drawCombinedChart('chart-month-combined', groupByMonth(inData), groupByMonth(outData));
            } else {
                console.warn('Chart.js not available');
            }
        };

        const groupByMonth = (data) => {
            const groups = {};
            data.forEach(r => {
                const month = extractMonth(r.Date_Time);
                if (!month) return;
                groups[month] = (groups[month] || 0) + safeParseFloat(r.Weight);
            });
            return groups;
        };

        const groupByDay = (data) => {
            const groups = {};
            data.forEach(r => {
                const date = safeParsDate(r.Date_Time);
                if (!date) return;
                const day = date.toISOString().split('T')[0];
                groups[day] = (groups[day] || 0) + safeParseFloat(r.Weight);
            });
            return groups;
        };

        const drawSimpleChart = (id, groups, color) => {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const sorted = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1] / 1000);

            const canvas = document.getElementById(id);
            if (!canvas) return;

            try {
                activeCharts[id] = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: dataVals,
                            borderColor: color,
                            backgroundColor: color + '20',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (val) => val.toFixed(1) + ' T' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Chart error:', error);
            }
        };

        const drawCombinedChart = (id, inGroups, outGroups) => {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const allMonths = new Set([...Object.keys(inGroups), ...Object.keys(outGroups)]);
            const labels = Array.from(allMonths).sort();
            const inVals = labels.map(m => (inGroups[m] || 0) / 1000);
            const outVals = labels.map(m => (outGroups[m] || 0) / 1000);

            const canvas = document.getElementById(id);
            if (!canvas) return;

            try {
                activeCharts[id] = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'IN', data: inVals, backgroundColor: '#3b82f6' },
                            { label: 'OUT', data: outVals, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (val) => val.toFixed(1) + ' T' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Chart error:', error);
            }
        };

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM loaded');

            // Tab switching
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', () => {
                    const tab = item.getAttribute('data-tab');
                    if (tab) switchTab(tab);
                });
            });

            // Refresh button
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) refreshBtn.addEventListener('click', debounce(fetchEverything, 500));

            // Filter buttons
            ['month', 'flow', 'transporter'].forEach(type => {
                const btn = document.getElementById(`filter-btn-${type}`);
                const menu = document.getElementById(`menu-${type}`);
                if (btn && menu) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.filter-menu').forEach(m => {
                            if (m !== menu) m.classList.remove('active');
                        });
                        menu.classList.toggle('active');
                    });
                }
            });

            // Filter items
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-item')) {
                    const type = e.target.getAttribute('data-type');
                    const value = e.target.getAttribute('data-value');
                    appState.filters[type] = value;
                    const label = document.getElementById(`label-${type}`);
                    if (label) label.textContent = value;
                    const menu = document.getElementById(`menu-${type}`);
                    if (menu) menu.classList.remove('active');
                    redrawAll();
                }
            });

            // Close menus
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-menu') && !e.target.closest('[id^="filter-btn-"]')) {
                    document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
                }
            });

            // Wait for libraries then fetch
            const checkLibraries = () => {
                const chartReady = typeof Chart !== 'undefined';
                const supabaseReady = typeof window.supabase !== 'undefined';
                console.log('Libraries:', { chartReady, supabaseReady });
                
                if (chartReady && supabaseReady) {
                    console.log('Starting fetch...');
                    fetchEverything();
                } else {
                    console.log('Waiting...');
                    setTimeout(checkLibraries, 500);
                }
            };
            
            setTimeout(checkLibraries, 1000);
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                    delete activeCharts[key];
                }
            });
        });
    </script>
</body>
</html>
