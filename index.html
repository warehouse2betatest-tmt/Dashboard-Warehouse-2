<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Intelligence - Sarabun Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* Navigation Styles */
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        /* Filter Styles */
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic">Ops <span class="text-white">WH2</span></h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1">
            <div onclick="switchTab('weight')" id="tab-weight" class="nav-item active">
                <span class="mr-2">‚öñÔ∏è</span> WEIGHT ANALYSIS
            </div>
            <div onclick="switchTab('shipment')" id="tab-shipment" class="nav-item">
                <span class="mr-2">üöö</span> SHIPMENT OPERATIONS
            </div>
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT RANKING
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button onclick="fetchEverything()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-4 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase">Database Rows</span>
                <span id="data-count-info" class="text-sm text-white font-mono font-bold">0</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- HEADER & FILTER -->
        <header class="bg-white border-b px-10 py-5 sticky top-0 z-40 flex justify-between items-center shadow-sm">
            <div class="flex items-center space-x-3">
                <!-- Filter Month -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-month')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        MONTH <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-month" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." onkeyup="searchSub('list-month', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-month" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Week -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-week')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        WEEK <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-week" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå..." onkeyup="searchSub('list-week', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-week" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Sloc -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-sloc')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        SLOC. <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-sloc" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Sloc..." onkeyup="searchSub('list-sloc', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-sloc" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-slate-300 mx-2"></div>
                
                <button onclick="clearAllFilters()" class="text-xs font-bold text-slate-400 hover:text-amber-500 px-2 transition-colors uppercase tracking-wider">
                    RESET ALL
                </button>
            </div>
            
            <div class="flex items-center">
                <div class="text-right mr-4">
                    <div id="tab-title" class="text-lg font-black text-slate-800 uppercase tracking-wider">Weight Analysis</div>
                    <div class="text-xs text-slate-400 font-medium">Real-time Dashboard</div>
                </div>
                <div class="w-1.5 h-10 bg-amber-500 rounded-full"></div>
            </div>
        </header>

        <div id="content-body" class="p-10 space-y-10">
            
            <!-- SECTION 1: WEIGHT ANALYSIS -->
            <div id="section-weight" class="tab-content space-y-10">
                <!-- Weight Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-gradient-to-br from-amber-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-amber-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                            <h4 class="text-xs font-black text-amber-600 uppercase tracking-widest">Weight Out</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-out-w">0.00</span> <span class="text-2xl text-slate-400 font-medium">t</span></div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-emerald-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-emerald-500 rounded-full shadow-lg shadow-emerald-200"></div>
                            <h4 class="text-xs font-black text-emerald-600 uppercase tracking-widest">Weight In</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-in-w">0.00</span> <span class="text-2xl text-slate-400 font-medium">t</span></div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-blue-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-blue-500 rounded-full shadow-lg shadow-blue-200"></div>
                            <h4 class="text-xs font-black text-blue-600 uppercase tracking-widest">Total Weight</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-total-w">0.00</span> <span class="text-2xl text-slate-400 font-medium">t</span></div>
                    </div>
                </div>

                <!-- Weight Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Weight by Shipment Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Shipment Type</h4>
                        <div class="relative" style="height: 420px">
                            <canvas id="chartWType"></canvas>
                        </div>
                        <div id="legendWType" class="mt-6 space-y-2"></div>
                    </div>
                    <!-- Chart Weight by Truck Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Truck Type</h4>
                        <div class="relative" style="height: 420px">
                            <canvas id="chartWTruck"></canvas>
                        </div>
                        <div id="legendWTruck" class="mt-6 space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: SHIPMENT OPERATIONS -->
            <div id="section-shipment" class="tab-content hidden space-y-10">
                <!-- Shipment Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-purple-500 rounded-full shadow-lg shadow-purple-200"></div>
                            <h4 class="text-xs font-black text-purple-600 uppercase tracking-widest">Shipping Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-shipping">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-pink-500 rounded-full shadow-lg shadow-pink-200"></div>
                            <h4 class="text-xs font-black text-pink-600 uppercase tracking-widest">Pickup Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-pickup">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-cyan-500 rounded-full shadow-lg shadow-cyan-200"></div>
                            <h4 class="text-xs font-black text-cyan-600 uppercase tracking-widest">Inbound Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-inbound">0</span></div>
                    </div>
                </div>

                <!-- Shipment Chart -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Shipment Count by Truck Type</h4>
                    <div class="relative" style="height: 420px">
                        <canvas id="chartCTruck"></canvas>
                    </div>
                    <div id="legendCTruck" class="mt-6 space-y-2"></div>
                </div>
            </div>

            <!-- SECTION 3: PRODUCT ANALYSIS -->
            <div id="section-product" class="tab-content hidden space-y-10">
                <!-- Product Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Group Sale -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Group Sale</h4>
                        <div id="container-GroupSale" class="w-full relative" style="min-height: 500px">
                            <canvas id="chartGroupSale"></canvas>
                        </div>
                    </div>
                    <!-- Chart Product Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Product Type</h4>
                        <div id="container-ProdType" class="w-full relative" style="min-height: 500px">
                            <canvas id="chartProdType"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ranking Table -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex items-center space-x-4 mb-8 pb-4 border-b border-slate-100">
                        <div class="w-3 h-8 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                        <h4 class="text-lg font-black text-slate-800 uppercase tracking-wide">Material Performance Ranking</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-extrabold tracking-wider">
                                <tr>
                                    <th class="px-6 py-5 text-center rounded-l-xl">Rank</th>
                                    <th class="px-6 py-5">Material Description</th>
                                    <th class="px-6 py-5 text-right">Qty</th>
                                    <th class="px-6 py-5 text-right rounded-r-xl">Weight (Tons)</th>
                                </tr>
                            </thead>
                            <tbody id="top-product-list" class="text-sm font-medium divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Config Setup
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = '#64748b';

        // ========== PERFORMANCE: Fixed naming conflict ==========
        const PROJECT_URL = 'https://gkkboducoidzusriylsq.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdra2JvZHVjb2lkenVzcml5bHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTgwODEsImV4cCI6MjA4NTUzNDA4MX0.-wdysRXN-YGzAjQgi3mc50WY91VjsZJlXAe7a65MjXw';
        const _db = window.supabase.createClient(PROJECT_URL, ANON_KEY);

        let masterData = [];
        let activeCharts = {};
        let isLoading = false; // ========== PERFORMANCE: Prevent multiple fetches ==========
        let searchTimeout = null; // ========== PERFORMANCE: Debounce search ==========

        // --- COLOR GENERATOR ---
        function generateColors(count) {
            const baseColors = [
                '#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#d946ef', '#f43f5e', '#a855f7', '#22c55e',
                '#0ea5e9', '#eab308', '#ef4444', '#64748b', '#78716c'
            ];
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        // --- UI LOGIC ---
        function toggleFilter(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const isActive = el.classList.contains('active');
            document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            if (!isActive) el.classList.add('active');
        }

        // ========== PERFORMANCE: Added debounce to search ==========
        function searchSub(id, q) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const labels = document.querySelectorAll(`#${id} label`);
                const query = q.toLowerCase();
                for (let i = 0; i < labels.length; i++) {
                    labels[i].style.display = labels[i].innerText.toLowerCase().includes(query) ? 'flex' : 'none';
                }
            }, 200);
        }

        // Close filter menus when clicking outside
        window.onclick = (e) => { 
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            }
        };

        // --- DATA FETCHING ---
        async function fetchEverything() {
            // ========== PERFORMANCE: Prevent multiple simultaneous fetches ==========
            if (isLoading) {
                console.log('Already loading data...');
                return;
            }

            isLoading = true;
            masterData = [];
            let from = 0, to = 999, isEnd = false;
            
            const statusDot = document.getElementById('status-dot');
            const loadStatus = document.getElementById('load-status');
            const progressBar = document.getElementById('progress-bar');
            const dataCountInfo = document.getElementById('data-count-info');

            statusDot.className = "w-3 h-3 bg-amber-500 rounded-full mr-2 animate-pulse";
            loadStatus.innerText = "Syncing...";
            progressBar.style.width = '0%';

            try {
                const { count } = await _db.from('FG In-Out').select('*', { count: 'exact', head: true });
                
                while (!isEnd) {
                    const { data, error } = await _db
                        .from('FG In-Out')
                        .select('Month, Week, "Shipment type", "Gross weight", Shipment, "Type Truck", "Sloc.", Material, "Delivery quantity", "Group Sale", "Product Type"')
                        .range(from, to);
                    
                    if (error) throw error;
                    
                    masterData = [...masterData, ...data];
                    progressBar.style.width = Math.round((masterData.length / count) * 100) + '%';
                    dataCountInfo.innerText = masterData.length.toLocaleString();
                    
                    if (data.length < 1000) {
                        isEnd = true;
                    } else {
                        from += 1000;
                        to += 1000;
                    }
                }
                
                statusDot.className = "w-3 h-3 bg-emerald-500 rounded-full mr-2";
                loadStatus.innerText = "Online";
                initDashboard();
                
            } catch (err) {
                console.error('Fetch error:', err);
                statusDot.className = "w-3 h-3 bg-red-500 rounded-full mr-2";
                loadStatus.innerText = "Error";
                alert("Connection Error: " + err.message);
            } finally {
                isLoading = false; // ========== PERFORMANCE: Reset loading flag ==========
            }
        }

        function initDashboard() {
            generateFiltersUI();
            refreshAllCharts(masterData);
        }

        function generateFiltersUI() {
            const months = new Set();
            const weeks = new Set();
            const slocs = new Set();

            // ========== PERFORMANCE: Use for loop instead of forEach ==========
            for (let i = 0; i < masterData.length; i++) {
                const d = masterData[i];
                if (d.Month) months.add(d.Month);
                if (d.Week) weeks.add(d.Week);
                if (d['Sloc.']) slocs.add(d['Sloc.']);
            }

            const renderList = (id, set) => {
                const vals = Array.from(set).sort();
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = vals.map(v => 
                    `<label class="flex items-center space-x-3 p-2 hover:bg-slate-50 rounded-lg cursor-pointer text-sm font-bold text-slate-600">
                        <input type="checkbox" value="${v}" onchange="runFilterEngine()" class="filter-${id} w-4 h-4 rounded text-amber-500 border-slate-300 focus:ring-amber-500">
                        <span>${v}</span>
                    </label>`
                ).join('');
            };
            
            renderList('list-month', months); 
            renderList('list-week', weeks); 
            renderList('list-sloc', slocs);
        }

        function runFilterEngine() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-month');
            const w = getChecked('list-week');
            const s = getChecked('list-sloc');
            
            // ========== PERFORMANCE: Optimized filter function ==========
            const filtered = masterData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (s.length > 0 && !s.includes(item['Sloc.'])) return false;
                return true;
            });
            
            refreshAllCharts(filtered);
        }

        function refreshAllCharts(data) {
            try {
                renderWeightPart(data);
                renderShipmentPart(data);
                renderProductPart(data);
            } catch (err) {
                console.error('Error refreshing charts:', err);
            }
        }

        // --- RENDER PARTS ---
        function renderWeightPart(data) {
            let outW = 0, inW = 0;
            const gType = {};
            const gTruck = {};
            
            // ========== PERFORMANCE: Use for loop for better performance ==========
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const type = r['Shipment type'] || 'Unknown';
                const truck = r['Type Truck'] || 'Unknown';
                
                if (type === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' || type === '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á') {
                    outW += w;
                } else if (type === '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO') {
                    inW += w;
                }
                
                gType[type] = (gType[type] || 0) + w; 
                gTruck[truck] = (gTruck[truck] || 0) + w;
            }
            
            const fmt = (v) => (v / 1000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('card-out-w').innerText = fmt(outW);
            document.getElementById('card-in-w').innerText = fmt(inW);
            document.getElementById('card-total-w').innerText = fmt(outW + inW);

            drawPie('chartWType', 'legendWType', gType, outW + inW);
            drawPie('chartWTruck', 'legendWTruck', gTruck, outW + inW);
        }

        function renderShipmentPart(data) {
            const shipMap = {
                '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': 'cnt-shipping',
                '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á': 'cnt-pickup',
                '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO': 'cnt-inbound'
            };
            
            Object.keys(shipMap).forEach(k => {
                const set = new Set();
                for (let i = 0; i < data.length; i++) {
                    if (data[i]['Shipment type'] === k) {
                        set.add(data[i].Shipment);
                    }
                }
                const el = document.getElementById(shipMap[k]);
                if (el) el.innerText = set.size.toLocaleString();
            });

            const gCTruck = {};
            for (let i = 0; i < data.length; i++) {
                const tr = data[i]['Type Truck'] || 'Unknown';
                if (!gCTruck[tr]) gCTruck[tr] = new Set();
                gCTruck[tr].add(data[i].Shipment);
            }
            
            const finalC = {};
            let sumC = 0;
            Object.keys(gCTruck).forEach(k => {
                finalC[k] = gCTruck[k].size;
                sumC += gCTruck[k].size;
            });
            
            drawPie('chartCTruck', 'legendCTruck', finalC, sumC, true);
        }

        function renderProductPart(data) {
            const gSale = {};
            const gProd = {};
            const gMat = {};
            
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const q = parseFloat(r['Delivery quantity']) || 0;
                const sale = r['Group Sale'] || 'N/A';
                const pType = r['Product Type'] || 'N/A';
                const mat = r.Material || 'Unknown';
                
                gSale[sale] = (gSale[sale] || 0) + w; 
                gProd[pType] = (gProd[pType] || 0) + w;
                
                if (!gMat[mat]) gMat[mat] = { w: 0, q: 0 };
                gMat[mat].w += w;
                gMat[mat].q += q;
            }

            drawBar('chartGroupSale', 'container-GroupSale', gSale);
            drawBar('chartProdType', 'container-ProdType', gProd);

            const sorted = Object.entries(gMat).sort((a, b) => b[1].w - a[1].w).slice(0, 10);
            const listEl = document.getElementById('top-product-list');
            if (listEl) {
                listEl.innerHTML = sorted.map(([name, val], i) => `
                    <tr class="hover:bg-slate-50 transition-all border-b border-slate-100 last:border-0 group">
                        <td class="px-6 py-5 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-black ${i < 3 ? 'bg-amber-500 text-white shadow-md' : 'bg-slate-200 text-slate-500'}">
                                #${i+1}
                            </span>
                        </td>
                        <td class="px-6 py-5 font-bold text-slate-700 group-hover:text-amber-600 transition-colors uppercase">${name}</td>
                        <td class="px-6 py-5 text-right font-bold text-slate-400">${val.q.toLocaleString()}</td>
                        <td class="px-6 py-5 text-right font-black text-slate-800 text-lg tracking-tighter">${(val.w/1000).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                    </tr>
                `).join('');
            }
        }

        // --- ENHANCED CHART ENGINE ---
        function drawPie(id, legId, group, total, isCount = false) {
            // ========== PERFORMANCE: Properly destroy old chart ==========
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }
            
            const sortedEntries = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const dataVals = sortedEntries.map(e => isCount ? e[1] : e[1] / 1000);
            const colors = generateColors(labels.length);

            // Custom Plugin for Leader Lines
            const leaderLinePlugin = {
                id: 'leaderLine',
                afterDraw: (chart) => {
                    const { ctx } = chart;
                    ctx.save();
                    const meta = chart.getDatasetMeta(0);
                    
                    if (!meta || !meta.data) {
                        ctx.restore();
                        return;
                    }
                    
                    meta.data.forEach((element, index) => {
                        if (element.hidden) return; 
                        
                        const val = dataVals[index];
                        const ratio = val / (isCount ? total : total / 1000);
                        const pct = ratio * 100;
                        
                        if (pct <= 4) return;

                        const model = element;
                        const midAngle = model.startAngle + (model.endAngle - model.startAngle) / 2;
                        const r = model.outerRadius;
                        
                        const startX = model.x + Math.cos(midAngle) * (r - 2);
                        const startY = model.y + Math.sin(midAngle) * (r - 2);
                        const endX = model.x + Math.cos(midAngle) * (r + 15);
                        const endY = model.y + Math.sin(midAngle) * (r + 15);
                        
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.strokeStyle = '#cbd5e1';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });
                    ctx.restore();
                }
            };

            const canvas = document.getElementById(id);
            if (!canvas) return;

            activeCharts[id] = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data: dataVals,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                plugins: [leaderLinePlugin],
                options: {
                    maintainAspectRatio: false,
                    layout: { padding: 40 },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'end',
                            offset: 20,
                            formatter: (value, ctx) => {
                                const pct = ((isCount ? value : value * 1000) / total * 100).toFixed(1);
                                return pct > 4 ? `${value.toLocaleString(undefined, {minimumFractionDigits: isCount ? 0 : 2})} ${isCount ? '' : 't'}\n(${pct}%)` : '';
                            },
                            font: { size: 12, weight: 'bold', family: 'Sarabun' },
                            textAlign: 'center'
                        },
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => {
                                    const val = ctx.raw; 
                                    const pct = (val / (isCount ? total : total / 1000) * 100).toFixed(1);
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: isCount ? 0 : 2})} ${isCount ? '' : 't'} (${pct}%)`;
                                } 
                            } 
                        }
                    }
                }
            });

            // Custom Legend
            const legendEl = document.getElementById(legId);
            if (legendEl) {
                legendEl.innerHTML = labels.map((l, i) => {
                    const val = dataVals[i];
                    const pct = ((isCount ? val : val * 1000) / total * 100).toFixed(1);
                    return `<div class="flex justify-between items-center text-xs p-2.5 bg-slate-50 rounded-xl border border-slate-100 hover:border-amber-200 transition-colors">
                        <div class="flex items-center font-bold text-slate-600">
                            <span class="w-3 h-3 rounded-full mr-2 shadow-sm" style="background:${colors[i]}"></span> ${l}
                        </div>
                        <div class="font-black text-slate-800">${val.toLocaleString(undefined, {minimumFractionDigits: isCount ? 0 : 2})} <span class="text-slate-400 font-medium ml-1">(${pct}%)</span></div>
                    </div>`;
                }).join('');
            }
        }

        function drawBar(id, containerId, group) {
            // ========== PERFORMANCE: Properly destroy old chart ==========
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const sorted = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1] / 1000);
            const total = dataVals.reduce((a, b) => a + b, 0);
            const colors = generateColors(labels.length);

            const container = document.getElementById(containerId);
            if (!container) return;

            const dynamicHeight = Math.max(400, labels.length * 50);
            container.style.height = dynamicHeight + 'px';

            const canvas = document.getElementById(id);
            if (!canvas) return;

            activeCharts[id] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: dataVals,
                        backgroundColor: colors,
                        borderRadius: 6,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    layout: { padding: { right: 80 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'right',
                            color: '#334155',
                            formatter: (value) => {
                                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                return `${value.toLocaleString(undefined, {minimumFractionDigits: 2})}t (${pct}%)`;
                            },
                            font: { size: 12, weight: 'bold', family: 'Sarabun' }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { 
                            grid: { display: false }, 
                            ticks: {
                                font: { size: 12, weight: '600', family: 'Sarabun' },
                                color: '#475569'
                            } 
                        }
                    }
                }
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById('section-' + t);
            const tab = document.getElementById('tab-' + t);
            const title = document.getElementById('tab-title');
            
            if (section) section.classList.remove('hidden');
            if (tab) tab.classList.add('active');
            if (title) {
                title.innerText = t === 'weight' ? 'Weight Analysis' : 
                                 t === 'shipment' ? 'Shipment Operations' : 
                                 'Product Analysis';
            }
        }

        function clearAllFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            runFilterEngine();
        }

        // ========== PERFORMANCE: Cleanup on page unload to prevent memory leaks ==========
        window.addEventListener('beforeunload', () => {
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                    delete activeCharts[key];
                }
            });
        });

        // Initialize on load
        window.onload = fetchEverything;
    </script>
</body>
</html>
