<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Intelligence - Sarabun Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* Navigation Styles */
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        /* Filter Styles */
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Chart Label Improvements */
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .max-w-\[200px\] { max-width: 200px; }
        .whitespace-nowrap { white-space: nowrap; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic">Ops <span class="text-white">WH2</span></h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1">
            <div onclick="switchTab('weight')" id="tab-weight" class="nav-item active">
                <span class="mr-2">‚öñÔ∏è</span> WEIGHT ANALYSIS
            </div>
            <div onclick="switchTab('shipment')" id="tab-shipment" class="nav-item">
                <span class="mr-2">üöö</span> SHIPMENT OPERATIONS
            </div>
            <!-- Updated Menu Name -->
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT & CUSTOMER
            </div>
            <!-- New Tab: Loading Time -->
            <div onclick="switchTab('loading')" id="tab-loading" class="nav-item">
                <span class="mr-2">‚è±Ô∏è</span> LOADING TIME
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button onclick="fetchEverything()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-4 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase">FG In-Out Rows</span>
                <span id="data-count-info" class="text-sm text-white font-mono font-bold">0</span>
            </div>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase">LoadingTime Rows</span>
                <span id="loading-count-info" class="text-sm text-emerald-400 font-mono font-bold">0</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- ========== LOADING POPUP ========== -->
        <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-md w-full mx-4 text-center">
                <!-- Spinner -->
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin"></div>
                </div>
                
                <!-- Status -->
                <h3 class="text-2xl font-black text-slate-800 mb-3" id="modal-title">Loading Data</h3>
                <p class="text-slate-600 font-medium mb-2" id="modal-subtitle">Please wait...</p>
                
                <!-- Sheet Name -->
                <div class="bg-slate-50 rounded-xl p-4 mb-4">
                    <div class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-1">Current Task</div>
                    <div class="text-lg font-black text-amber-600" id="modal-sheet-name">Initializing</div>
                </div>
                
                <!-- Progress Info -->
                <div class="space-y-3">
                    <div class="flex justify-between text-sm">
                        <span class="font-bold text-slate-600">Rows Loaded:</span>
                        <span class="font-black text-slate-800" id="modal-count">0</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div class="w-full bg-slate-200 h-3 rounded-full overflow-hidden">
                        <div id="modal-progress" class="bg-gradient-to-r from-amber-400 to-amber-600 h-full w-0 transition-all duration-300"></div>
                    </div>
                    
                    <div class="text-xs font-bold text-slate-400" id="modal-percent">0%</div>
                </div>
            </div>
        </div>
        
        <!-- HEADER & FILTER -->
        <header class="bg-white border-b px-10 py-5 sticky top-0 z-40 flex justify-between items-center shadow-sm">
            <div class="flex items-center space-x-3">
                <!-- Filter Month -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-month')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        MONTH <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-month" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." onkeyup="searchSub('list-month', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-month" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Week -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-week')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        WEEK <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-week" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå..." onkeyup="searchSub('list-week', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-week" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Sloc -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-sloc')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        SLOC. <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-sloc" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Sloc..." onkeyup="searchSub('list-sloc', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-sloc" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-slate-300 mx-2"></div>
                
                <button onclick="clearAllFilters()" class="text-xs font-bold text-slate-400 hover:text-amber-500 px-2 transition-colors uppercase tracking-wider">
                    RESET ALL
                </button>
            </div>
            
            <div class="flex items-center">
                <div class="text-right mr-4">
                    <div id="tab-title" class="text-lg font-black text-slate-800 uppercase tracking-wider">Weight Analysis</div>
                    <div class="text-xs text-slate-400 font-medium">Real-time Dashboard</div>
                </div>
                <div class="w-1.5 h-10 bg-amber-500 rounded-full"></div>
            </div>
        </header>

        <div id="content-body" class="p-10 space-y-10">
            
            <!-- SECTION 1: WEIGHT ANALYSIS -->
            <div id="section-weight" class="tab-content space-y-10">
                <!-- Weight Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-gradient-to-br from-amber-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-amber-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                            <h4 class="text-xs font-black text-amber-600 uppercase tracking-widest">Weight Out</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-out-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-emerald-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-emerald-500 rounded-full shadow-lg shadow-emerald-200"></div>
                            <h4 class="text-xs font-black text-emerald-600 uppercase tracking-widest">Weight In</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-in-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-blue-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-blue-500 rounded-full shadow-lg shadow-blue-200"></div>
                            <h4 class="text-xs font-black text-blue-600 uppercase tracking-widest">Total Weight</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-total-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                    </div>
                </div>

                <!-- Weight Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Weight by Shipment Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Shipment Type</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartWType"></canvas>
                        </div>
                        <div id="legendWType" class="mt-6 space-y-2"></div>
                    </div>
                    <!-- Chart Weight by Truck Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Truck Type</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartWTruck"></canvas>
                        </div>
                        <div id="legendWTruck" class="mt-6 space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: SHIPMENT OPERATIONS -->
            <div id="section-shipment" class="tab-content hidden space-y-10">
                <!-- Shipment Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-purple-500 rounded-full shadow-lg shadow-purple-200"></div>
                            <h4 class="text-xs font-black text-purple-600 uppercase tracking-widest">Shipping Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-shipping">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-pink-500 rounded-full shadow-lg shadow-pink-200"></div>
                            <h4 class="text-xs font-black text-pink-600 uppercase tracking-widest">Pickup Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-pickup">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-cyan-500 rounded-full shadow-lg shadow-cyan-200"></div>
                            <h4 class="text-xs font-black text-cyan-600 uppercase tracking-widest">Inbound Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-inbound">0</span></div>
                    </div>
                </div>

                <!-- Shipment Chart -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Shipment Count by Truck Type</h4>
                    <div class="relative" style="height: 480px">
                        <canvas id="chartCTruck"></canvas>
                    </div>
                    <div id="legendCTruck" class="mt-6 space-y-2"></div>
                </div>
            </div>

            <!-- SECTION 3: PRODUCT & CUSTOMER ANALYSIS -->
            <div id="section-product" class="tab-content hidden space-y-10">
                <!-- Product Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Group Sale -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Group Sale</h4>
                        <div id="container-GroupSale" class="w-full relative" style="min-height: 600px">
                            <canvas id="chartGroupSale"></canvas>
                        </div>
                    </div>
                    <!-- Chart Product Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Product Type</h4>
                        <div id="container-ProdType" class="w-full relative" style="min-height: 600px">
                            <canvas id="chartProdType"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ranking Table -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex items-center space-x-4 mb-8 pb-4 border-b border-slate-100">
                        <div class="w-3 h-8 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                        <h4 class="text-lg font-black text-slate-800 uppercase tracking-wide">Material Performance Ranking</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-extrabold tracking-wider">
                                <tr>
                                    <th class="px-6 py-5 text-center rounded-l-xl">Rank</th>
                                    <th class="px-6 py-5">Material Description</th>
                                    <th class="px-6 py-5 text-right">Qty</th>
                                    <th class="px-6 py-5 text-right rounded-r-xl">Weight (Tons)</th>
                                </tr>
                            </thead>
                            <tbody id="top-product-list" class="text-sm font-medium divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- NEW: CUSTOMER ANALYSIS SECTION -->
                <div class="flex items-center space-x-4 pt-10 border-t border-slate-200">
                    <div class="w-3 h-8 bg-indigo-500 rounded-full shadow-lg shadow-indigo-200"></div>
                    <h4 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Customer Analysis</h4>
                </div>

                <!-- Group Customer Pie Chart -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Group Customer</h4>
                    <div class="relative" style="height: 480px">
                        <canvas id="chartGroupCust"></canvas>
                    </div>
                    <div id="legendGroupCust" class="mt-6 space-y-2"></div>
                </div>

                <!-- Top 10 Customer Bar Chart with Filter -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h4 class="text-sm font-black text-slate-500 uppercase tracking-widest text-center md:text-left mb-4 md:mb-0">Top 10 Customers (Weight)</h4>
                        
                        <!-- Customer Group Filter -->
                        <div class="flex items-center space-x-2 bg-slate-50 rounded-xl px-4 py-2 border border-slate-200">
                            <span class="text-xs font-bold text-slate-400 uppercase">Filter Group:</span>
                            <select id="filter-group-cust" class="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer">
                                <option value="ALL">All Groups</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="container-TopCustomer" class="w-full relative" style="min-height: 500px">
                        <canvas id="chartTopCustomer"></canvas>
                    </div>
                </div>

            </div>

            <!-- SECTION 4: LOADING TIME (New) -->
            <div id="section-loading" class="tab-content hidden space-y-10">
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100 text-center py-20">
                    <div class="inline-flex items-center justify-center w-20 h-20 bg-emerald-100 rounded-full mb-6">
                        <svg class="w-10 h-10 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    </div>
                    <h2 class="text-3xl font-black text-slate-800 mb-4">Loading Time Data Connected</h2>
                    <p class="text-slate-500 text-lg mb-8 max-w-lg mx-auto">
                        Data from <span class="font-bold text-slate-700">"LoadingTime"</span> table has been successfully fetched and stored in memory.
                    </p>
                    <div class="inline-block bg-slate-50 px-6 py-3 rounded-xl border border-slate-200">
                        <span class="text-slate-500 font-bold uppercase text-xs tracking-wider mr-2">Records Available:</span>
                        <span id="loading-display-count" class="text-xl font-black text-emerald-600">0</span>
                    </div>
                    <div class="mt-8">
                        <p class="text-slate-400 text-sm italic">Waiting for further instructions...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        // Config Setup
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = '#64748b';

        const PROJECT_URL = 'https://gkkboducoidzusriylsq.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdra2JvZHVjb2lkenVzcml5bHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTgwODEsImV4cCI6MjA4NTUzNDA4MX0.-wdysRXN-YGzAjQgi3mc50WY91VjsZJlXAe7a65MjXw';
        const _db = window.supabase.createClient(PROJECT_URL, ANON_KEY);

        let masterData = [];
        let loadingData = []; // New Variable for LoadingTime Table
        let activeCharts = {};
        let isLoading = false;
        let searchTimeout = null;

        // --- COLOR GENERATOR ---
        function generateColors(count) {
            const baseColors = [
                '#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#d946ef', '#f43f5e', '#a855f7', '#22c55e',
                '#0ea5e9', '#eab308', '#ef4444', '#64748b', '#78716c'
            ];
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        // --- UI LOGIC ---
        function toggleFilter(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const isActive = el.classList.contains('active');
            document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            if (!isActive) el.classList.add('active');
        }

        function searchSub(id, q) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const labels = document.querySelectorAll(`#${id} label`);
                const query = q.toLowerCase();
                for (let i = 0; i < labels.length; i++) {
                    labels[i].style.display = labels[i].innerText.toLowerCase().includes(query) ? 'flex' : 'none';
                }
            }, 200);
        }

        window.onclick = (e) => { 
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            }
        };

        // --- DATA FETCHING (UPDATED) ---
        async function fetchEverything() {
            if (isLoading) {
                console.log('Already loading data...');
                return;
            }

            isLoading = true;
            masterData = [];
            loadingData = []; // Reset Loading Data
            
            // UI Elements
            const modal = document.getElementById('loading-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const modalSheetName = document.getElementById('modal-sheet-name');
            const modalCount = document.getElementById('modal-count');
            const modalProgress = document.getElementById('modal-progress');
            const modalPercent = document.getElementById('modal-percent');
            
            const statusDot = document.getElementById('status-dot');
            const loadStatus = document.getElementById('load-status');
            const progressBar = document.getElementById('progress-bar');
            const dataCountInfo = document.getElementById('data-count-info');
            const loadingCountInfo = document.getElementById('loading-count-info');

            // Initial UI State
            if (modal) {
                modal.classList.remove('hidden');
                modal.classList.add('flex');
            }
            if (modalTitle) modalTitle.innerText = 'Syncing Data';
            if (modalProgress) modalProgress.style.width = '0%';
            if (modalPercent) modalPercent.innerText = '0%';
            
            statusDot.className = "w-3 h-3 bg-amber-500 rounded-full mr-2 animate-pulse";
            loadStatus.innerText = "Syncing...";
            progressBar.style.width = '0%';

            try {
                // ============================================
                // STEP 1: FETCH FG In-Out
                // ============================================
                if (modalSheetName) modalSheetName.innerText = 'FG In-Out';
                if (modalSubtitle) modalSubtitle.innerText = 'Fetching FG In-Out records...';

                let from = 0, to = 999, isEnd = false;
                const { count: countFG } = await _db.from('FG In-Out').select('*', { count: 'exact', head: true });
                
                while (!isEnd) {
                    // Added "Group Customer" and Customer to selection
                    const { data, error } = await _db
                        .from('FG In-Out')
                        .select('Month, Week, "Shipment type", "Gross weight", Shipment, "Type Truck", "Sloc.", Material, "Delivery quantity", "Group Sale", "Product Type", "Group Customer", Customer')
                        .range(from, to);
                    
                    if (error) throw error;
                    
                    masterData = [...masterData, ...data];
                    const percent = countFG ? Math.round((masterData.length / countFG) * 50) : 50; // First half of progress
                    
                    if (modalCount) modalCount.innerText = masterData.length.toLocaleString();
                    if (modalProgress) modalProgress.style.width = percent + '%';
                    if (modalPercent) modalPercent.innerText = percent + '%';
                    if (dataCountInfo) dataCountInfo.innerText = masterData.length.toLocaleString();
                    
                    if (data.length < 1000) {
                        isEnd = true;
                    } else {
                        from += 1000;
                        to += 1000;
                    }
                }

                // ============================================
                // STEP 2: FETCH LoadingTime (New)
                // ============================================
                if (modalSheetName) modalSheetName.innerText = 'LoadingTime';
                if (modalSubtitle) modalSubtitle.innerText = 'Fetching LoadingTime records...';

                from = 0; to = 999; isEnd = false;
                // Just fetch all columns since we don't know schema yet, or specify if known
                const { count: countLoad } = await _db.from('LoadingTime').select('*', { count: 'exact', head: true });
                
                while (!isEnd) {
                    const { data, error } = await _db
                        .from('LoadingTime')
                        .select('*')
                        .range(from, to);
                    
                    if (error) {
                        console.warn('LoadingTime fetch error (might not exist yet):', error);
                        isEnd = true; // Stop loop if error
                    } else {
                        loadingData = [...loadingData, ...data];
                        const basePercent = 50; // Start from 50%
                        const percent = countLoad ? basePercent + Math.round((loadingData.length / countLoad) * 50) : 100;
                        
                        if (modalCount) modalCount.innerText = loadingData.length.toLocaleString();
                        if (modalProgress) modalProgress.style.width = percent + '%';
                        if (modalPercent) modalPercent.innerText = percent + '%';
                        if (loadingCountInfo) loadingCountInfo.innerText = loadingData.length.toLocaleString();

                        if (data.length < 1000) {
                            isEnd = true;
                        } else {
                            from += 1000;
                            to += 1000;
                        }
                    }
                }

                // ============================================
                // COMPLETION
                // ============================================
                if (modalTitle) modalTitle.innerText = 'Success!';
                if (modalSubtitle) modalSubtitle.innerText = 'All databases synchronized';
                
                statusDot.className = "w-3 h-3 bg-emerald-500 rounded-full mr-2";
                loadStatus.innerText = "Online";
                
                // Update display in the LoadingTime tab
                const dispCount = document.getElementById('loading-display-count');
                if (dispCount) dispCount.innerText = loadingData.length.toLocaleString();

                setTimeout(() => {
                    if (modal) {
                        modal.classList.add('hidden');
                        modal.classList.remove('flex');
                    }
                    initDashboard();
                }, 1000);
                
            } catch (err) {
                console.error('Fetch error:', err);
                if (modalTitle) modalTitle.innerText = 'Error!';
                if (modalSubtitle) modalSubtitle.innerText = err.message || 'Failed to load data';
                statusDot.className = "w-3 h-3 bg-red-500 rounded-full mr-2";
                loadStatus.innerText = "Error";
                setTimeout(() => { console.error("Connection Error: " + err.message); }, 3000);
            } finally {
                isLoading = false;
            }
        }

        function initDashboard() {
            generateFiltersUI();
            refreshAllCharts(masterData);
        }

        function generateFiltersUI() {
            const months = new Set();
            const weeks = new Set();
            const slocs = new Set();

            for (let i = 0; i < masterData.length; i++) {
                const d = masterData[i];
                if (d.Month) months.add(d.Month);
                if (d.Week) weeks.add(d.Week);
                if (d['Sloc.']) slocs.add(d['Sloc.']);
            }

            const renderList = (id, set) => {
                const vals = Array.from(set).sort();
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = vals.map(v => 
                    `<label class="flex items-center space-x-3 p-2 hover:bg-slate-50 rounded-lg cursor-pointer text-sm font-bold text-slate-600">
                        <input type="checkbox" value="${v}" onchange="runFilterEngine()" class="filter-${id} w-4 h-4 rounded text-amber-500 border-slate-300 focus:ring-amber-500">
                        <span>${v}</span>
                    </label>`
                ).join('');
            };
            
            renderList('list-month', months); 
            renderList('list-week', weeks); 
            renderList('list-sloc', slocs);
        }

        function runFilterEngine() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-month');
            const w = getChecked('list-week');
            const s = getChecked('list-sloc');
            
            const filtered = masterData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (s.length > 0 && !s.includes(item['Sloc.'])) return false;
                return true;
            });
            
            refreshAllCharts(filtered);
        }

        function refreshAllCharts(data) {
            try {
                renderWeightPart(data);
                renderShipmentPart(data);
                renderProductPart(data);
            } catch (err) {
                console.error('Error refreshing charts:', err);
            }
        }

        // --- RENDER PARTS ---
        function renderWeightPart(data) {
            let outW = 0, inW = 0;
            const gType = {};
            const gTruck = {};
            
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const type = r['Shipment type'] || 'Unknown';
                const truck = r['Type Truck'] || 'Unknown';
                
                if (type === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' || type === '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á') {
                    outW += w;
                } else if (type === '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO') {
                    inW += w;
                }
                
                gType[type] = (gType[type] || 0) + w; 
                gTruck[truck] = (gTruck[truck] || 0) + w;
            }
            
            const fmt = (v) => (v / 1000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('card-out-w').innerText = fmt(outW);
            document.getElementById('card-in-w').innerText = fmt(inW);
            document.getElementById('card-total-w').innerText = fmt(outW + inW);

            drawPie('chartWType', 'legendWType', gType, outW + inW);
            drawPie('chartWTruck', 'legendWTruck', gTruck, outW + inW);
        }

        function renderShipmentPart(data) {
            const shipMap = {
                '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': 'cnt-shipping',
                '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á': 'cnt-pickup',
                '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO': 'cnt-inbound'
            };
            
            Object.keys(shipMap).forEach(k => {
                const set = new Set();
                for (let i = 0; i < data.length; i++) {
                    if (data[i]['Shipment type'] === k) {
                        set.add(data[i].Shipment);
                    }
                }
                const el = document.getElementById(shipMap[k]);
                if (el) el.innerText = set.size.toLocaleString();
            });

            const gCTruck = {};
            for (let i = 0; i < data.length; i++) {
                const tr = data[i]['Type Truck'] || 'Unknown';
                if (!gCTruck[tr]) gCTruck[tr] = new Set();
                gCTruck[tr].add(data[i].Shipment);
            }
            
            const finalC = {};
            let sumC = 0;
            Object.keys(gCTruck).forEach(k => {
                finalC[k] = gCTruck[k].size;
                sumC += gCTruck[k].size;
            });
            
            drawPie('chartCTruck', 'legendCTruck', finalC, sumC, true);
        }

        // Updated function to handle Customer Analysis
        function renderProductPart(data) {
            const gSale = {};
            const gProd = {};
            const gMat = {};
            const gCustGroup = {}; // For Group Customer Pie Chart
            
            // Collect all unique Group Customers for the Filter Dropdown
            const uniqueGroups = new Set();

            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const q = parseFloat(r['Delivery quantity']) || 0;
                const sale = r['Group Sale'] || 'N/A';
                const pType = r['Product Type'] || 'N/A';
                const mat = r.Material || 'Unknown';
                const custGroup = r['Group Customer'] || 'Others';
                
                gSale[sale] = (gSale[sale] || 0) + w; 
                gProd[pType] = (gProd[pType] || 0) + w;
                gCustGroup[custGroup] = (gCustGroup[custGroup] || 0) + w;
                
                if (!gMat[mat]) gMat[mat] = { w: 0, q: 0 };
                gMat[mat].w += w;
                gMat[mat].q += q;

                if (custGroup) uniqueGroups.add(custGroup);
            }

            drawBar('chartGroupSale', 'container-GroupSale', gSale);
            drawBar('chartProdType', 'container-ProdType', gProd);

            // Calculate Material Ranking
            const sorted = Object.entries(gMat).sort((a, b) => b[1].w - a[1].w).slice(0, 10);
            const listEl = document.getElementById('top-product-list');
            if (listEl) {
                listEl.innerHTML = sorted.map(([name, val], i) => {
                    const displayName = name.length > 50 ? name.substring(0, 47) + '...' : name;
                    return `
                    <tr class="hover:bg-slate-50 transition-all border-b border-slate-100 last:border-0 group">
                        <td class="px-6 py-5 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-black ${i < 3 ? 'bg-amber-500 text-white shadow-md' : 'bg-slate-200 text-slate-500'}">
                                #${i+1}
                            </span>
                        </td>
                        <td class="px-6 py-5 font-bold text-slate-700 group-hover:text-amber-600 transition-colors uppercase" title="${name}">${displayName}</td>
                        <td class="px-6 py-5 text-right font-bold text-slate-400">${val.q.toLocaleString()}</td>
                        <td class="px-6 py-5 text-right font-black text-slate-800 text-lg tracking-tighter">${(val.w/1000).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                    </tr>
                `;
                }).join('');
            }

            // --- CUSTOMER ANALYSIS LOGIC ---
            
            // 1. Draw Group Customer Pie Chart
            const totalCustW = Object.values(gCustGroup).reduce((a,b)=>a+b,0);
            drawPie('chartGroupCust', 'legendGroupCust', gCustGroup, totalCustW);

            // 2. Populate Dropdown (Only if not already populated to avoid resetting on simple refresh)
            const dropdown = document.getElementById('filter-group-cust');
            // Store current selection if refreshing data
            const currentSelection = dropdown.value; 
            
            // Clear existing except ALL
            dropdown.innerHTML = '<option value="ALL">All Groups</option>';
            
            Array.from(uniqueGroups).sort().forEach(g => {
                const opt = document.createElement('option');
                opt.value = g;
                opt.innerText = g;
                dropdown.appendChild(opt);
            });
            
            // Restore selection if possible, otherwise default to ALL
            if (Array.from(dropdown.options).some(o => o.value === currentSelection)) {
                dropdown.value = currentSelection;
            }

            // 3. Render Top 10 Customer Bar Chart
            // Attach event listener to dropdown
            dropdown.onchange = () => renderTopCustomers(data);
            
            // Initial render of Top 10 Customers
            renderTopCustomers(data);
        }

        // Dedicated function for Top 10 Customer Chart to handle filtering locally
        function renderTopCustomers(data) {
            const dropdown = document.getElementById('filter-group-cust');
            const selectedGroup = dropdown.value;
            
            const gCustomer = {};

            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const custName = r.Customer || 'Unknown';
                const custGroup = r['Group Customer'] || 'Others';

                // Filter Logic
                if (selectedGroup !== 'ALL' && custGroup !== selectedGroup) {
                    continue; // Skip if doesn't match selected group
                }

                gCustomer[custName] = (gCustomer[custName] || 0) + w;
            }

            // Pick Top 10
            const sortedCust = Object.entries(gCustomer)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            // Convert back to object for drawBar
            const top10Obj = Object.fromEntries(sortedCust);

            drawBar('chartTopCustomer', 'container-TopCustomer', top10Obj);
        }

        // --- ENHANCED CHART ENGINE ---
        function drawPie(id, legId, group, total, isCount = false) {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }
            
            const sortedEntries = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const dataVals = sortedEntries.map(e => isCount ? e[1] : e[1] / 1000);
            const colors = generateColors(labels.length);

            const leaderLinePlugin = {
                id: 'leaderLine',
                afterDraw: (chart) => {
                    const { ctx } = chart;
                    ctx.save();
                    const meta = chart.getDatasetMeta(0);
                    
                    if (!meta || !meta.data) {
                        ctx.restore();
                        return;
                    }
                    
                    meta.data.forEach((element, index) => {
                        if (element.hidden) return; 
                        
                        const val = dataVals[index];
                        const ratio = val / (isCount ? total : total / 1000);
                        const pct = ratio * 100;
                        
                        // Show label only if > 3%
                        if (pct <= 3) return;

                        const model = element;
                        const midAngle = model.startAngle + (model.endAngle - model.startAngle) / 2;
                        const r = model.outerRadius;
                        
                        // Updated for smaller radius
                        const startX = model.x + Math.cos(midAngle) * (r - 2);
                        const startY = model.y + Math.sin(midAngle) * (r - 2);
                        const endX = model.x + Math.cos(midAngle) * (r + 20); // Shorter line
                        const endY = model.y + Math.sin(midAngle) * (r + 20);
                        
                        ctx.beginPath();
                        ctx.moveTo(startX, startY);
                        ctx.lineTo(endX, endY);
                        ctx.strokeStyle = '#cbd5e1';
                        ctx.lineWidth = 2;
                        ctx.stroke();
                    });
                    ctx.restore();
                }
            };

            const canvas = document.getElementById(id);
            if (!canvas) return;

            activeCharts[id] = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels,
                    datasets: [{
                        data: dataVals,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff',
                    }]
                },
                plugins: [leaderLinePlugin],
                options: {
                    maintainAspectRatio: false,
                    // ========== CHANGE: Reduced Radius and Increased Padding ==========
                    layout: { 
                        padding: 30 
                    },
                    // Manually control radius to be smaller (default is 100% of available space)
                    // We set it to 65% to leave room for outer labels
                    radius: '65%', 
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b',
                            anchor: 'end',
                            align: 'end',
                            offset: 15, // Adjusted offset for smaller chart
                            formatter: (value, ctx) => {
                                const pct = ((isCount ? value : value * 1000) / total * 100).toFixed(1);
                                if (pct <= 3) return '';
                                const displayVal = value.toLocaleString(undefined, {
                                    minimumFractionDigits: isCount ? 0 : 1,
                                    maximumFractionDigits: isCount ? 0 : 1
                                });
                                return `${displayVal} ${isCount ? '' : 'Tons'}\n(${pct}%)`;
                            },
                            font: { size: 11, weight: 'bold', family: 'Sarabun' },
                            textAlign: 'center',
                            padding: 4
                        },
                        tooltip: { 
                            callbacks: { 
                                label: (ctx) => {
                                    const val = ctx.raw; 
                                    const pct = (val / (isCount ? total : total / 1000) * 100).toFixed(1);
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: isCount ? 0 : 2})} ${isCount ? '' : 'Tons'} (${pct}%)`;
                                } 
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold', family: 'Sarabun' },
                            bodyFont: { size: 12, family: 'Sarabun' },
                            displayColors: true,
                            boxWidth: 15,
                            boxHeight: 15
                        }
                    },
                    animation: {
                        duration: 500,
                        animateRotate: true,
                        animateScale: false
                    }
                }
            });

            // Custom Legend
            const legendEl = document.getElementById(legId);
            if (legendEl) {
                legendEl.innerHTML = labels.map((l, i) => {
                    const val = dataVals[i];
                    const pct = ((isCount ? val : val * 1000) / total * 100).toFixed(1);
                    const displayVal = val.toLocaleString(undefined, {
                        minimumFractionDigits: isCount ? 0 : 2,
                        maximumFractionDigits: isCount ? 0 : 2
                    });
                    return `<div class="flex justify-between items-center text-xs p-2.5 bg-slate-50 rounded-xl border border-slate-100 hover:border-amber-200 transition-colors">
                        <div class="flex items-center font-bold text-slate-600">
                            <span class="w-3 h-3 rounded-full mr-2 shadow-sm" style="background:${colors[i]}"></span> 
                            <span class="truncate max-w-[200px]" title="${l}">${l}</span>
                        </div>
                        <div class="font-black text-slate-800 whitespace-nowrap">${displayVal} ${isCount ? '' : 'Tons.'} <span class="text-slate-400 font-medium ml-1">(${pct}%)</span></div>
                    </div>`;
                }).join('');
            }
        }

        function drawBar(id, containerId, group) {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const sorted = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1] / 1000);
            const total = dataVals.reduce((a, b) => a + b, 0);
            const colors = generateColors(labels.length);

            const container = document.getElementById(containerId);
            if (!container) return;

            const dynamicHeight = Math.max(500, labels.length * 60);
            container.style.height = dynamicHeight + 'px';

            const canvas = document.getElementById(id);
            if (!canvas) return;

            activeCharts[id] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        data: dataVals,
                        backgroundColor: colors,
                        borderRadius: 6,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    layout: { padding: { right: 120, left: 10 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#334155',
                            formatter: (value) => {
                                const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                const displayVal = value.toLocaleString(undefined, {
                                    minimumFractionDigits: 1,
                                    maximumFractionDigits: 1
                                });
                                return `${displayVal} Tons (${pct}%)`;
                            },
                            font: { size: 11, weight: 'bold', family: 'Sarabun' },
                            clip: false,
                            offset: 8
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const val = ctx.raw;
                                    const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons (${pct}%)`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold', family: 'Sarabun' },
                            bodyFont: { size: 12, family: 'Sarabun' },
                            displayColors: true,
                            boxWidth: 15,
                            boxHeight: 15
                        }
                    },
                    scales: {
                        x: { 
                            display: false,
                            grace: '5%'
                        },
                        y: { 
                            grid: { display: false },
                            ticks: {
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    if (!label) return '';
                                    return label.length > 30 ? label.substring(0, 27) + '...' : label;
                                },
                                font: { size: 11, weight: '600', family: 'Sarabun' },
                                color: '#475569',
                                padding: 8
                            } 
                        }
                    },
                    animation: {
                        duration: 500
                    }
                }
            });
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById('section-' + t);
            const tab = document.getElementById('tab-' + t);
            const title = document.getElementById('tab-title');
            
            if (section) section.classList.remove('hidden');
            if (tab) tab.classList.add('active');
            if (title) {
                title.innerText = t === 'weight' ? 'Weight Analysis' : 
                                 t === 'shipment' ? 'Shipment Operations' : 
                                 t === 'product' ? 'Product & Customer Analysis' :
                                 'Loading Time Analysis';
            }
        }

        function clearAllFilters() {
            document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
            runFilterEngine();
        }

        window.addEventListener('beforeunload', () => {
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                    delete activeCharts[key];
                }
            });
        });

        window.onload = fetchEverything;
    </script>
</body>
</html>
