<!DOCTYPE html>
<!-- CACHE BUSTER: v2.0.1 - 2025-02-06 17:30 - Fixed filter logic -->
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WAREHOUSE 2 EFFICIENCY</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        
        /* Sidebar Transition */
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; }
        .sidebar.collapsed { width: 0; padding: 0; opacity: 0; }
        
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; }
        
        /* Navigation Styles */
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; white-space: nowrap; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        /* Filter Styles */
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Horizontal Scrollbar for Chart */
        .chart-scroll-container::-webkit-scrollbar { height: 8px; }
        .chart-scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .chart-scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chart-scroll-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Chart Label Improvements */
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .max-w-\[200px\] { max-width: 200px; }
        .whitespace-nowrap { white-space: nowrap; }

        /* Editable Table Styles */
        .editable-cell { cursor: pointer; padding: 8px; border-radius: 6px; transition: background 0.2s; }
        .editable-cell:hover { background-color: #fef3c7; }
        .editable-input { width: 100%; padding: 6px; border: 2px solid #f59e0b; border-radius: 6px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside id="main-sidebar" class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic leading-tight">
                WAREHOUSE 2<br>
                <span class="text-white">EFFICIENCY</span>
            </h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest whitespace-nowrap">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1 overflow-y-auto custom-scrollbar">
            <div onclick="switchTab('loading-efficiency')" id="tab-loading-efficiency" class="nav-item active">
                <span class="mr-2">‚ö°</span> LOADING EFFICIENCY
            </div>
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT & CUSTOMER
            </div>
            <div onclick="switchTab('milkrun')" id="tab-milkrun" class="nav-item">
                <span class="mr-2">üõª</span> MILK RUN
            </div>
            <div onclick="switchTab('tonshead')" id="tab-tonshead" class="nav-item">
                <span class="mr-2">üìä</span> TONS/HEAD
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button onclick="fetchEverything()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-4 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- ========== LOADING POPUP ========== -->
        <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-lg w-full mx-4">
                <div class="mb-6 flex justify-center">
                    <div class="w-16 h-16 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin"></div>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-2 text-center">Loading Data</h3>
                <p class="text-slate-600 font-medium mb-6 text-center">Loading <span id="modal-table-count">6</span> tables...</p>
                
                <!-- Table Progress Bars -->
                <div class="space-y-3 mb-6 max-h-96 overflow-y-auto custom-scrollbar">
                    <!-- FG IN-OUT -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">FG IN-OUT</span>
                            <span class="text-xs font-black text-slate-500" id="progress-fginout-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-fginout" class="bg-gradient-to-r from-blue-400 to-blue-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <!-- LOADINGTIME -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">LOADINGTIME</span>
                            <span class="text-xs font-black text-slate-500" id="progress-loadingtime-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-loadingtime" class="bg-gradient-to-r from-emerald-400 to-emerald-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <!-- M_WMS -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">M_WMS</span>
                            <span class="text-xs font-black text-slate-500" id="progress-mwms-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-mwms" class="bg-gradient-to-r from-indigo-400 to-indigo-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <!-- M_SAP -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">M_SAP</span>
                            <span class="text-xs font-black text-slate-500" id="progress-msap-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-msap" class="bg-gradient-to-r from-pink-400 to-pink-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <!-- HEAD -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">HEAD</span>
                            <span class="text-xs font-black text-slate-500" id="progress-head-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-head" class="bg-gradient-to-r from-purple-400 to-purple-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                    
                    <!-- EMPLOYEE -->
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-xs font-bold text-slate-700">EMPLOYEE</span>
                            <span class="text-xs font-black text-slate-500" id="progress-employee-percent">0%</span>
                        </div>
                        <div class="w-full bg-slate-200 h-2 rounded-full overflow-hidden">
                            <div id="progress-employee" class="bg-gradient-to-r from-orange-400 to-orange-600 h-full w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Overall Progress -->
                <div class="pt-4 border-t border-slate-200">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-black text-slate-800">Overall Progress</span>
                        <span class="text-sm font-black text-amber-600" id="modal-overall-percent">0%</span>
                    </div>
                    <div class="w-full bg-slate-200 h-3 rounded-full overflow-hidden">
                        <div id="modal-progress" class="bg-gradient-to-r from-amber-400 to-amber-600 h-full w-0 transition-all duration-500"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- HEADER & FILTER -->
        <header class="bg-white border-b px-6 py-4 sticky top-0 z-40 flex justify-between items-center shadow-sm">
            
            <div class="flex items-center space-x-4">
                <!-- Sidebar Toggle Button -->
                <button onclick="toggleSidebar()" class="p-2 rounded-lg text-slate-500 hover:bg-slate-100 hover:text-amber-500 transition-all focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>

                <!-- Filter Group 1: Main (Updated with Shipment Type) -->
                <div id="filters-main" class="flex items-center space-x-3">
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-month')" class="bg-slate-100 hover:bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-700 flex items-center transition-all">
                            MONTH <span class="ml-2 text-slate-400">‚ñº</span>
                        </button>
                        <div id="menu-month" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-month', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-month" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-week')" class="bg-slate-100 hover:bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-700 flex items-center transition-all">
                            WEEK <span class="ml-2 text-slate-400">‚ñº</span>
                        </button>
                        <div id="menu-week" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-week', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-week" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-sloc')" class="bg-slate-100 hover:bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-700 flex items-center transition-all">
                            SLOC. <span class="ml-2 text-slate-400">‚ñº</span>
                        </button>
                        <div id="menu-sloc" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-sloc', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-sloc" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <!-- New Shipment Type Filter -->
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-ship-type')" class="bg-slate-100 hover:bg-white border border-slate-200 px-4 py-2 rounded-xl text-xs font-bold text-slate-700 flex items-center transition-all">
                            TYPE <span class="ml-2 text-slate-400">‚ñº</span>
                        </button>
                        <div id="menu-ship-type" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-ship-type', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-ship-type" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>

                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    <button onclick="clearAllFilters('main')" class="text-[10px] font-bold text-slate-400 hover:text-amber-500 px-2 transition-colors uppercase tracking-wider">RESET</button>
                </div>

                <!-- Filter Group 2: Loading Time -->
                <div id="filters-loading" class="hidden flex items-center space-x-3">
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-l-month')" class="bg-emerald-50 hover:bg-white border border-emerald-200 px-4 py-2 rounded-xl text-xs font-bold text-emerald-700 flex items-center transition-all">
                            MONTH <span class="ml-2 text-emerald-400">‚ñº</span>
                        </button>
                        <div id="menu-l-month" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-l-month', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-l-month" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-l-week')" class="bg-emerald-50 hover:bg-white border border-emerald-200 px-4 py-2 rounded-xl text-xs font-bold text-emerald-700 flex items-center transition-all">
                            WEEK <span class="ml-2 text-emerald-400">‚ñº</span>
                        </button>
                        <div id="menu-l-week" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-l-week', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-l-week" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-l-factory')" class="bg-emerald-50 hover:bg-white border border-emerald-200 px-4 py-2 rounded-xl text-xs font-bold text-emerald-700 flex items-center transition-all">
                            FACTORY <span class="ml-2 text-emerald-400">‚ñº</span>
                        </button>
                        <div id="menu-l-factory" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-l-factory', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-l-factory" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                     <!-- New Date Filter -->
                     <div class="relative group">
                        <button onclick="toggleFilter('menu-l-date')" class="bg-emerald-50 hover:bg-white border border-emerald-200 px-4 py-2 rounded-xl text-xs font-bold text-emerald-700 flex items-center transition-all">
                            DATE <span class="ml-2 text-emerald-400">‚ñº</span>
                        </button>
                        <div id="menu-l-date" class="filter-menu">
                            <input type="text" placeholder="Search Date..." onkeyup="searchSub('list-l-date', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-l-date" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    <button onclick="clearAllFilters('loading')" class="text-[10px] font-bold text-slate-400 hover:text-emerald-500 px-2 transition-colors uppercase tracking-wider">RESET</button>
                </div>

                <!-- Filter Group 3: Milk Run -->
                <div id="filters-milkrun" class="hidden flex items-center space-x-3">
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-m-month')" class="bg-blue-50 hover:bg-white border border-blue-200 px-4 py-2 rounded-xl text-xs font-bold text-blue-700 flex items-center transition-all">
                            MONTH <span class="ml-2 text-blue-400">‚ñº</span>
                        </button>
                        <div id="menu-m-month" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-m-month', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-m-month" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-m-week')" class="bg-blue-50 hover:bg-white border border-blue-200 px-4 py-2 rounded-xl text-xs font-bold text-blue-700 flex items-center transition-all">
                            WEEK <span class="ml-2 text-blue-400">‚ñº</span>
                        </button>
                        <div id="menu-m-week" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-m-week', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-m-week" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-m-date')" class="bg-blue-50 hover:bg-white border border-blue-200 px-4 py-2 rounded-xl text-xs font-bold text-blue-700 flex items-center transition-all">
                            DATE <span class="ml-2 text-blue-400">‚ñº</span>
                        </button>
                        <div id="menu-m-date" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-m-date', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-m-date" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    <button onclick="clearAllFilters('milkrun')" class="text-[10px] font-bold text-slate-400 hover:text-blue-500 px-2 transition-colors uppercase tracking-wider">RESET</button>
                </div>

                <!-- Filter Group 4: Tons/Head -->
                <div id="filters-tonshead" class="hidden flex items-center space-x-3">
                    <div class="relative group">
                        <button onclick="toggleFilter('menu-th-month')" class="bg-purple-50 hover:bg-white border border-purple-200 px-4 py-2 rounded-xl text-xs font-bold text-purple-700 flex items-center transition-all">
                            MONTH <span class="ml-2 text-purple-400">‚ñº</span>
                        </button>
                        <div id="menu-th-month" class="filter-menu">
                            <input type="text" placeholder="Search..." onkeyup="searchSub('list-th-month', this.value)" class="w-full text-xs p-2 mb-2 border-b outline-none">
                            <div id="list-th-month" class="filter-list custom-scrollbar space-y-1"></div>
                        </div>
                    </div>
                    <div class="h-6 w-px bg-slate-300 mx-2"></div>
                    <button onclick="clearAllFilters('tonshead')" class="text-[10px] font-bold text-slate-400 hover:text-purple-500 px-2 transition-colors uppercase tracking-wider">RESET</button>
                </div>

            </div>
            
            <div class="flex items-center">
                <div class="text-right mr-4 hidden md:block">
                    <div id="tab-title" class="text-lg font-black text-slate-800 uppercase tracking-wider">Weight Analysis</div>
                    <div class="text-xs text-slate-400 font-medium">Real-time Dashboard</div>
                </div>
                <div id="title-bar" class="w-1.5 h-10 bg-amber-500 rounded-full transition-colors duration-300"></div>
            </div>
        </header>

        <div id="content-body" class="p-6 md:p-10 space-y-10" style="flex: 1; width: 100%;">
            
            <!-- ========== LOADING EFFICIENCY SECTION (‡∏£‡∏ß‡∏° 3 Parts) ========== -->
            <div id="section-loading-efficiency" class="tab-content hidden space-y-12" style="display: none;">
                
                <!-- ========== PART 1: LOADING TIME ========== -->
                <div>
                    <div class="flex items-center space-x-4 border-b pb-4 border-slate-200 mb-8">
                        <div class="w-10 h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-xl">‚è±Ô∏è</div>
                        <div>
                            <h3 class="text-2xl font-black text-slate-800 uppercase">Loading Time</h3>
                            <p class="text-sm text-slate-500">Time efficiency analysis</p>
                        </div>
                    </div>

                    <!-- 4 Summary Cards Row -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <!-- Total Weight -->
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Total Weight</div>
                            <div class="text-2xl font-black text-slate-800" id="loading-total-weight">0.00</div>
                            <div class="text-xs text-emerald-500 font-bold mt-1">Tons</div>
                        </div>
                        <!-- Peak Daily Weight -->
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Max Daily Weight</div>
                            <div class="text-2xl font-black text-slate-800" id="loading-peak-weight">0.00</div>
                            <div class="text-xs text-blue-500 font-bold mt-1">Tons (Max/Day)</div>
                        </div>
                        <!-- Latest Time Out -->
                        <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Latest Time Out</div>
                            <div class="text-2xl font-black text-red-500" id="loading-max-time">--:--</div>
                            <div class="text-xs text-red-300 font-bold mt-1">Hrs.</div>
                        </div>
                         <!-- Average Time Out (New) -->
                         <div class="bg-white p-6 rounded-[2rem] shadow-sm border border-slate-100">
                            <div class="text-xs text-slate-400 font-bold uppercase tracking-widest mb-1">Average Max Time</div>
                            <div class="text-2xl font-black text-indigo-500" id="loading-avg-time">--:--</div>
                            <div class="text-xs text-indigo-300 font-bold mt-1">Avg of Daily Maxes</div>
                        </div>
                    </div>

                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 space-y-3 md:space-y-0">
                            <div>
                                <h4 class="text-xl font-black text-emerald-700 uppercase tracking-wide">Loading Analysis</h4>
                                <p class="text-sm text-slate-400 mt-1">Target Time: <span class="font-bold text-red-500">20:30</span> | Bar: Weight, Line: Max Time</p>
                            </div>
                            <div class="flex items-center space-x-3">
                                <!-- View Switcher -->
                                <div class="bg-slate-100 p-1 rounded-xl flex items-center">
                                    <button onclick="setLoadingViewMode('daily')" id="btn-view-daily" class="px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white text-emerald-600 shadow-sm">Daily</button>
                                    <button onclick="setLoadingViewMode('monthly')" id="btn-view-monthly" class="px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600">Monthly Avg</button>
                                </div>
                                <div class="text-xs font-bold text-slate-400 bg-slate-50 px-3 py-2 rounded-lg border border-slate-100">
                                    <span class="mr-1">‚ÜîÔ∏è</span> Scroll
                                </div>
                            </div>
                        </div>
                        
                        <!-- Scrollable Container -->
                        <div class="chart-scroll-container overflow-x-auto w-full pb-4">
                            <!-- Inner Container for dynamic width -->
                            <div id="loading-chart-container" class="relative h-[500px] w-full min-w-full">
                                <canvas id="chartLoadingTime"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- ========== END PART 1 ========== -->

                <!-- ========== SHIPMENT ANALYSIS (‡∏£‡∏ß‡∏° Part 2 & 3) ========== -->
                <div>
                    <div class="flex items-center space-x-4 border-b pb-4 border-slate-200 mb-8">
                        <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-purple-500 rounded-xl flex items-center justify-center text-xl">üìä</div>
                        <div>
                            <h3 class="text-2xl font-black text-slate-800 uppercase">Shipment Analysis</h3>
                            <p class="text-sm text-slate-500">Weight distribution, shipment count, and operations</p>
                        </div>
                    </div>

                <!-- Weight Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-gradient-to-br from-amber-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-amber-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                            <h4 class="text-xs font-black text-amber-600 uppercase tracking-widest">Outbound</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-out-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                    </div>
                    <div class="bg-gradient-to-br from-emerald-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-emerald-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-emerald-500 rounded-full shadow-lg shadow-emerald-200"></div>
                            <h4 class="text-xs font-black text-emerald-600 uppercase tracking-widest">Inbound</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-in-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                        <div class="text-xs text-emerald-500 font-bold mt-2">Includes: ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO, ‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤, ‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-blue-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-blue-500 rounded-full shadow-lg shadow-blue-200"></div>
                            <h4 class="text-xs font-black text-blue-600 uppercase tracking-widest">Total Weight</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="card-total-w">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons.</span></div>
                    </div>
                </div>

                <!-- Weight Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Chart Weight by Shipment Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Shipment Type</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartWType"></canvas>
                        </div>
                        <div id="legendWType" class="mt-6 space-y-2"></div>
                    </div>
                    <!-- Chart Weight by Truck Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Truck Type</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartWTruck"></canvas>
                        </div>
                        <div id="legendWTruck" class="mt-6 space-y-2"></div>
                    </div>
                </div>

                <!-- Shipment Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-8">
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-purple-500 rounded-full shadow-lg shadow-purple-200"></div>
                            <h4 class="text-xs font-black text-purple-600 uppercase tracking-widest">Shipping Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-shipping">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-pink-500 rounded-full shadow-lg shadow-pink-200"></div>
                            <h4 class="text-xs font-black text-pink-600 uppercase tracking-widest">Pickup Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-pickup">0</span></div>
                    </div>
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <div class="flex items-center space-x-3 mb-4">
                            <div class="w-3 h-10 bg-cyan-500 rounded-full shadow-lg shadow-cyan-200"></div>
                            <h4 class="text-xs font-black text-cyan-600 uppercase tracking-widest">Inbound Count</h4>
                        </div>
                        <div class="text-5xl font-black text-slate-900 mb-2"><span id="cnt-inbound">0</span></div>
                    </div>
                </div>

                <!-- Shipment Chart -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Shipment Count by Truck Type</h4>
                    <div class="relative" style="height: 480px">
                        <canvas id="chartCTruck"></canvas>
                    </div>
                    <div id="legendCTruck" class="mt-6 space-y-2"></div>
                </div>
            </div>
            <!-- ========== END SHIPMENT ANALYSIS ========== -->
            
            </div>
            <!-- ========== END LOADING EFFICIENCY SECTION ========== -->

            <!-- SECTION: PRODUCT & CUSTOMER ANALYSIS -->
            <div id="section-product" class="tab-content hidden space-y-10" style="display: none;">
                <!-- Product Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Chart Group Sale -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Group Sale</h4>
                        <div id="container-GroupSale" class="w-full relative" style="min-height: 600px">
                            <canvas id="chartGroupSale"></canvas>
                        </div>
                    </div>
                    <!-- Chart Product Type -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Product Type</h4>
                        <div id="container-ProdType" class="w-full relative" style="min-height: 600px">
                            <canvas id="chartProdType"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Ranking Table -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex items-center space-x-4 mb-8 pb-4 border-b border-slate-100">
                        <div class="w-3 h-8 bg-amber-500 rounded-full shadow-lg shadow-amber-200"></div>
                        <h4 class="text-lg font-black text-slate-800 uppercase tracking-wide">Material Performance Ranking</h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-slate-50 text-xs uppercase text-slate-500 font-extrabold tracking-wider">
                                <tr>
                                    <th class="px-6 py-5 text-center rounded-l-xl">Rank</th>
                                    <th class="px-6 py-5">Material Description</th>
                                    <th class="px-6 py-5 text-right">Qty</th>
                                    <th class="px-6 py-5 text-right rounded-r-xl">Weight (Tons)</th>
                                </tr>
                            </thead>
                            <tbody id="top-product-list" class="text-sm font-medium divide-y divide-slate-50"></tbody>
                        </table>
                    </div>
                </div>

                <!-- CUSTOMER ANALYSIS SECTION -->
                <div class="flex items-center space-x-4 pt-10 border-t border-slate-200">
                    <div class="w-3 h-8 bg-indigo-500 rounded-full shadow-lg shadow-indigo-200"></div>
                    <h4 class="text-2xl font-black text-slate-800 uppercase tracking-tight">Customer Analysis</h4>
                </div>

                <!-- Group Customer Pie Chart -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight by Group Customer</h4>
                    <div class="relative" style="height: 480px">
                        <canvas id="chartGroupCust"></canvas>
                    </div>
                    <div id="legendGroupCust" class="mt-6 space-y-2"></div>
                </div>

                <!-- Top 10 Customer Bar Chart with Filter -->
                <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                    <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                        <h4 class="text-sm font-black text-slate-500 uppercase tracking-widest text-center md:text-left mb-4 md:mb-0">Top 10 Customers (Weight)</h4>
                        <div class="flex items-center space-x-2 bg-slate-50 rounded-xl px-4 py-2 border border-slate-200">
                            <span class="text-xs font-bold text-slate-400 uppercase">Filter Group:</span>
                            <select id="filter-group-cust" class="bg-transparent text-sm font-bold text-slate-700 outline-none cursor-pointer">
                                <option value="ALL">All Groups</option>
                            </select>
                        </div>
                    </div>
                    <div id="container-TopCustomer" class="w-full relative" style="min-height: 500px">
                        <canvas id="chartTopCustomer"></canvas>
                    </div>
                </div>
            </div>

            <!-- SECTION: MILK RUN (Split into Part 1 & Part 2) -->
            <div id="section-milkrun" class="tab-content hidden space-y-12" style="display: none;">
                
                <!-- Part 1 Header -->
                <div class="flex items-center space-x-4 border-b pb-4 border-slate-200">
                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center text-xl">1Ô∏è‚É£</div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 uppercase">Part 1: WMS Analysis</h3>
                        <p class="text-sm text-slate-500">Data Source: Table <span class="font-bold font-mono text-blue-600">M_WMS</span></p>
                    </div>
                </div>

                <!-- Part 1 Content (Existing WMS Logic) -->
                <div class="space-y-10">
                    <!-- 3 Summary Cards Row -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <!-- Milk Run No. Count -->
                        <div class="bg-gradient-to-br from-blue-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-blue-100">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-3 h-10 bg-blue-500 rounded-full shadow-lg shadow-blue-200"></div>
                                <h4 class="text-xs font-black text-blue-600 uppercase tracking-widest">Milk Run Trips</h4>
                            </div>
                            <div class="text-5xl font-black text-slate-900 mb-2"><span id="mr-card-count">0</span></div>
                            <div class="text-xs text-slate-400 font-bold uppercase mt-2">Unique Trips (M_WMS)</div>
                        </div>
                        <!-- Total Weight -->
                        <div class="bg-gradient-to-br from-purple-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-purple-100">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-3 h-10 bg-purple-500 rounded-full shadow-lg shadow-purple-200"></div>
                                <h4 class="text-xs font-black text-purple-600 uppercase tracking-widest">Total Weight</h4>
                            </div>
                            <div class="text-5xl font-black text-slate-900 mb-2"><span id="mr-card-weight">0.00</span> <span class="text-xl text-slate-400 font-medium">Tons</span></div>
                        </div>
                        <!-- Total DO/Item -->
                        <div class="bg-gradient-to-br from-orange-50 to-white p-10 rounded-[2.5rem] shadow-sm border border-orange-100">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-3 h-10 bg-orange-500 rounded-full shadow-lg shadow-orange-200"></div>
                                <h4 class="text-xs font-black text-orange-600 uppercase tracking-widest">Total DO/Item</h4>
                            </div>
                            <div class="text-5xl font-black text-slate-900 mb-2"><span id="mr-card-do">0</span></div>
                        </div>
                    </div>


                    <!-- Completed vs Cancel Charts -->
                    <!-- ‡∏Å‡∏£‡∏≤‡∏ü 1: Over Time (‡πÅ‡∏Å‡∏ô X = ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà) -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Completed vs Cancelled Over Time</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartMilkRunTime"></canvas>
                        </div>
                    </div>
                    
                    <!-- ‡∏Å‡∏£‡∏≤‡∏ü 2: By Time Value (‡πÅ‡∏Å‡∏ô X = ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤) -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Completed vs Cancelled by Time Value</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartMilkRunByValue"></canvas>
                        </div>
                    </div>
                    
                    <!-- ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà: Weight & DO/Item by ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Weight & DO/Item by ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å</h4>
                        <div class="relative" style="height: 480px">
                            <canvas id="chartWeightDOByDepositor"></canvas>
                        </div>
                    </div>
                    
                    <!-- ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å & ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Analysis (‡∏Ñ‡∏π‡πà‡∏Å‡∏±‡∏ô) -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Analysis Chart -->
                        <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                            <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Analysis</h4>
                            <div id="container-Depositor" class="relative" style="min-height: 400px">
                                <canvas id="chartDepositor"></canvas>
                            </div>
                        </div>
                        
                        <!-- ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Analysis Chart (Fac ‚Üí ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å) -->
                        <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                            <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Analysis (Fac. Breakdown)</h4>
                            <div id="container-Receiver" class="relative" style="min-height: 400px">
                                <canvas id="chartReceiver"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check Cap Analysis Chart -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Check Cap Analysis</h4>
                        <div id="container-CheckCap" class="relative" style="min-height: 400px">
                            <canvas id="chartCheckCap"></canvas>
                        </div>
                    </div>
                    
                    <!-- ‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å (TT-04, TT-05) Cards - Enhanced Design -->
                    <div class="space-y-6">
                        <div class="flex items-center space-x-4">
                            <div class="bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl p-3 shadow-lg">
                                <span class="text-3xl">üöö</span>
                            </div>
                            <div>
                                <h4 class="text-2xl font-black text-slate-800 uppercase">‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å Analysis</h4>
                                <p class="text-sm text-slate-500">Vehicle Time Analysis (TT-04 & TT-05)</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- TT-04 Card - Enhanced -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-indigo-50 via-white to-purple-50 p-8 rounded-[2.5rem] shadow-lg border-2 border-indigo-100 hover:border-indigo-300 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
                                <!-- Background Pattern -->
                                <div class="absolute top-0 right-0 opacity-5 text-indigo-500">
                                    <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                    </svg>
                                </div>
                                
                                <!-- Header -->
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-4">
                                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-2xl p-4 shadow-lg shadow-indigo-200 group-hover:scale-110 transition-transform duration-300">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="text-xl font-black text-indigo-700 uppercase tracking-tight">TT-04</h5>
                                            <p class="text-xs text-indigo-400 font-semibold">Time Tracking</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-indigo-100 hover:bg-indigo-50 transition-colors duration-200">
                                        <div class="text-xs text-indigo-500 font-bold mb-2 uppercase tracking-wider">Count</div>
                                        <div class="text-3xl font-black bg-gradient-to-br from-indigo-600 to-purple-600 bg-clip-text text-transparent" id="tt04-count">0</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-indigo-100 hover:bg-indigo-50 transition-colors duration-200">
                                        <div class="text-xs text-indigo-500 font-bold mb-2 uppercase tracking-wider">Min</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt04-min">--:--</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-indigo-100 hover:bg-indigo-50 transition-colors duration-200">
                                        <div class="text-xs text-indigo-500 font-bold mb-2 uppercase tracking-wider">Avg</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt04-avg">--:--</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-indigo-100 hover:bg-indigo-50 transition-colors duration-200">
                                        <div class="text-xs text-indigo-500 font-bold mb-2 uppercase tracking-wider">Max</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt04-max">--:--</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TT-05 Card - Enhanced -->
                            <div class="group relative overflow-hidden bg-gradient-to-br from-orange-50 via-white to-amber-50 p-8 rounded-[2.5rem] shadow-lg border-2 border-orange-100 hover:border-orange-300 transition-all duration-300 hover:shadow-xl hover:-translate-y-1">
                                <!-- Background Pattern -->
                                <div class="absolute top-0 right-0 opacity-5 text-orange-500">
                                    <svg class="w-32 h-32" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                        <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1V5a1 1 0 00-1-1H3zM14 7a1 1 0 00-1 1v6.05A2.5 2.5 0 0115.95 16H17a1 1 0 001-1v-5a1 1 0 00-.293-.707l-2-2A1 1 0 0015 7h-1z"/>
                                    </svg>
                                </div>
                                
                                <!-- Header -->
                                <div class="flex items-center justify-between mb-6">
                                    <div class="flex items-center space-x-4">
                                        <div class="bg-gradient-to-br from-orange-500 to-orange-600 rounded-2xl p-4 shadow-lg shadow-orange-200 group-hover:scale-110 transition-transform duration-300">
                                            <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <h5 class="text-xl font-black text-orange-700 uppercase tracking-tight">TT-05</h5>
                                            <p class="text-xs text-orange-400 font-semibold">Time Tracking</p>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Stats Grid -->
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-orange-100 hover:bg-orange-50 transition-colors duration-200">
                                        <div class="text-xs text-orange-500 font-bold mb-2 uppercase tracking-wider">Count</div>
                                        <div class="text-3xl font-black bg-gradient-to-br from-orange-600 to-amber-600 bg-clip-text text-transparent" id="tt05-count">0</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-orange-100 hover:bg-orange-50 transition-colors duration-200">
                                        <div class="text-xs text-orange-500 font-bold mb-2 uppercase tracking-wider">Min</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt05-min">--:--</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-orange-100 hover:bg-orange-50 transition-colors duration-200">
                                        <div class="text-xs text-orange-500 font-bold mb-2 uppercase tracking-wider">Avg</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt05-avg">--:--</div>
                                    </div>
                                    <div class="bg-white/80 backdrop-blur-sm p-4 rounded-2xl border border-orange-100 hover:bg-orange-50 transition-colors duration-200">
                                        <div class="text-xs text-orange-500 font-bold mb-2 uppercase tracking-wider">Max</div>
                                        <div class="text-2xl font-black text-slate-800" id="tt05-max">--:--</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Part 2 Header -->
                <div class="flex items-center space-x-4 border-b pb-4 border-slate-200 pt-8">
                    <div class="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center text-xl">2Ô∏è‚É£</div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 uppercase">Part 2: SAP Analysis</h3>
                        <p class="text-sm text-slate-500">Data Source: Table <span class="font-bold font-mono text-pink-600">M_SAP</span></p>
                    </div>
                </div>

                <!-- Part 2 Content (New SAP Logic) -->
                <div class="space-y-10">
                    <!-- SAP Cards Container -->
                    <div id="sap-analysis-container">
                        <!-- Dynamic Cards will be inserted here -->
                    </div>
                    
                    <!-- Sloc Analysis Chart -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Sloc Analysis (Storage Location)</h4>
                        <div id="container-Sloc" class="relative" style="min-height: 400px">
                            <canvas id="chartSloc"></canvas>
                        </div>
                    </div>
                    
                    <!-- Customer Analysis Chart -->
                    <div class="bg-white p-10 rounded-[2.5rem] shadow-sm border border-slate-100">
                        <h4 class="text-sm font-black text-slate-500 uppercase mb-6 tracking-widest text-center">Customer Analysis</h4>
                        <div id="container-Customer" class="relative" style="min-height: 400px">
                            <canvas id="chartCustomer"></canvas>
                        </div>
                    </div>
                </div>

            </div>
            <!-- ========== END SECTION: MILK RUN ========== -->
            
            <!-- ========== TONS/HEAD SECTION ========== -->
            <div id="section-tonshead" class="tab-content hidden space-y-8" style="display: none; padding: 2rem; min-height: 800px;">
                    
                    <!-- Header -->
                    <div class="flex items-center justify-between border-b pb-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl flex items-center justify-center text-2xl shadow-lg">üë•</div>
                            <div>
                                <h3 class="text-3xl font-black text-slate-800 uppercase">Tons per Head</h3>
                                <p class="text-sm text-slate-500">Productivity Analysis by Factory</p>
                            </div>
                        </div>
                    </div>

                    <!-- KPI Cards - Two Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <!-- Card 1: Tons per Month -->
                        <div class="bg-gradient-to-br from-purple-500 to-purple-700 p-10 rounded-3xl shadow-2xl text-white">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-3 h-10 bg-white/30 rounded-full shadow-lg"></div>
                                <h4 class="text-sm font-black uppercase tracking-widest opacity-90">Tons per Month</h4>
                            </div>
                            <div class="text-5xl font-black mb-3"><span id="th-tons-per-month">0.00</span></div>
                            <div class="text-base font-bold opacity-75 mb-6">Tons/Month</div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div class="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl">
                                    <div class="text-xs font-bold uppercase tracking-wider opacity-75">Total Tons</div>
                                    <div class="text-xl font-black"><span id="th-total-tons">0.00</span></div>
                                </div>
                                <div class="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl">
                                    <div class="text-xs font-bold uppercase tracking-wider opacity-75">Working Days</div>
                                    <div class="text-xl font-black"><span id="th-total-days">0</span></div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Card 2: Tons per Month per Head -->
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-700 p-10 rounded-3xl shadow-2xl text-white">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-3 h-10 bg-white/30 rounded-full shadow-lg"></div>
                                <h4 class="text-sm font-black uppercase tracking-widest opacity-90">Tons per Month per Head</h4>
                            </div>
                            <div class="text-5xl font-black mb-3"><span id="th-tons-per-day">0.00</span></div>
                            <div class="text-base font-bold opacity-75 mb-6">Tons/Month/Head</div>
                            
                            <div class="bg-white/10 backdrop-blur-sm px-4 py-3 rounded-xl">
                                <div class="text-xs font-bold uppercase tracking-wider opacity-75">Total People</div>
                                <div class="text-xl font-black"><span id="th-total-people">0</span></div>
                            </div>
                        </div>
                        
                    </div>

                    <!-- Chart Section 1: Tons/Month by Month -->
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200" style="width: 100%; min-width: 600px;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h4 class="text-xl font-black text-slate-800">Tons/Month by Month</h4>
                                <p class="text-sm text-slate-500">Monthly productivity breakdown</p>
                            </div>
                        </div>
                        <div id="th-month-chart-container" style="height: 500px; width: 100%; position: relative; min-width: 500px;">
                            <canvas id="th-month-chart"></canvas>
                        </div>
                    </div>

                    <!-- Chart Section 2: Tons/Head by Factory -->
                    <div class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200" style="width: 100%; min-width: 600px;">
                        <div class="flex items-center justify-between mb-6">
                            <div>
                                <h4 class="text-xl font-black text-slate-800">Tons/Head by Factory</h4>
                                <p class="text-sm text-slate-500">Productivity comparison across factories</p>
                            </div>
                        </div>
                        <div id="th-chart-container" style="height: 600px; width: 100%; position: relative; min-width: 500px;">
                            <canvas id="th-chart"></canvas>
                        </div>
                    </div>

            </div>

        </div>
    </main>

    <script>
        // Config Setup
        Chart.register(ChartDataLabels);
        Chart.defaults.font.family = "'Sarabun', sans-serif";
        Chart.defaults.font.size = 14;
        Chart.defaults.color = '#64748b';

        const PROJECT_URL = 'https://gkkboducoidzusriylsq.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdra2JvZHVjb2lkenVzcml5bHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTgwODEsImV4cCI6MjA4NTUzNDA4MX0.-wdysRXN-YGzAjQgi3mc50WY91VjsZJlXAe7a65MjXw';
        const _db = supabase.createClient(PROJECT_URL, ANON_KEY);

        let masterData = [];
        let masterDataOriginal = []; // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏±‡∏ö Shipment
        let loadingData = []; 
        let milkRunWMS = []; 
        let milkRunSAP = []; 
        let milkRunCombined = [];
        let headData = []; // NEW: Store Head table data
        let employeeData = []; // NEW: Store Employee table data (Factory, ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô)
        let headDataCache = {}; // NEW: Performance cache
        let activeCharts = {};
        let isLoading = false;
        let searchTimeout = null;
        let loadingViewMode = 'daily'; 

        // --- COLOR GENERATOR ---
        function generateColors(count) {
            const baseColors = [
                '#f59e0b', '#3b82f6', '#10b981', '#ef4444', '#8b5cf6', 
                '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1',
                '#14b8a6', '#d946ef', '#f43f5e', '#a855f7', '#22c55e',
                '#0ea5e9', '#eab308', '#ef4444', '#64748b', '#78716c'
            ];
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(baseColors[i % baseColors.length]);
            }
            return colors;
        }

        // --- UI LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
            }
        }

        function toggleFilter(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const isActive = el.classList.contains('active');
            document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            if (!isActive) el.classList.add('active');
        }

        function searchSub(id, q) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const labels = document.querySelectorAll(`#${id} label`);
                const query = q.toLowerCase();
                for (let i = 0; i < labels.length; i++) {
                    labels[i].style.display = labels[i].innerText.toLowerCase().includes(query) ? 'flex' : 'none';
                }
            }, 200);
        }

        window.onclick = (e) => { 
            if (!e.target.closest('.relative')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            }
        };

        function switchTab(t) {
            console.log('üîÑ Switching to tab:', t);
            
            // ‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å section
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('hidden');
                el.style.display = 'none';
            });
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            const section = document.getElementById('section-' + t);
            const tab = document.getElementById('tab-' + t);
            const title = document.getElementById('tab-title');
            const bar = document.getElementById('title-bar');
            
            console.log('üìç Section element:', section ? '‚úÖ Found' : '‚ùå Not found');
            
            if (section) {
                section.classList.remove('hidden');
                section.style.display = 'block';
                section.style.width = '100%';
                section.style.minHeight = '800px';
                
                // Force layout
                void section.offsetHeight;
                
                console.log('‚úÖ Section visible with forced dimensions');
                
                // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å set style
                setTimeout(() => {
                    const computedStyle = window.getComputedStyle(section);
                    console.log('üìê Section dimensions:', {
                        width: section.offsetWidth,
                        height: section.offsetHeight,
                        scrollHeight: section.scrollHeight,
                        display: computedStyle.display,
                        visibility: computedStyle.visibility
                    });
                    
                    // Debug parent chain
                    let parent = section.parentElement;
                    let level = 0;
                    while (parent && level < 3) {
                        const pStyle = window.getComputedStyle(parent);
                        console.log(`üìê Parent ${level} (${parent.id || parent.tagName}):`, {
                            width: parent.offsetWidth,
                            height: parent.offsetHeight,
                            display: pStyle.display
                        });
                        parent = parent.parentElement;
                        level++;
                    }
                }, 100);
            } else {
                console.error('‚ùå Section "section-' + t + '" not found!');
            }
            
            if (tab) tab.classList.add('active');
            
            const mainFilters = document.getElementById('filters-main');
            const loadFilters = document.getElementById('filters-loading');
            const milkFilters = document.getElementById('filters-milkrun');
            const thFilters = document.getElementById('filters-tonshead');

            // LOADING EFFICIENCY (‡∏£‡∏ß‡∏° Weight + Shipment + Loading Time)
            if (t === 'loading-efficiency') {
                if (loadFilters) loadFilters.classList.add('hidden');
                if (milkFilters) milkFilters.classList.add('hidden');
                if (thFilters) thFilters.classList.add('hidden');
                if (mainFilters) {
                    mainFilters.classList.remove('hidden');
                    mainFilters.classList.add('flex');
                }
                if (title) title.innerText = 'Loading Efficiency';
                if (bar) {
                    bar.className = 'w-1.5 h-10 bg-amber-500 rounded-full transition-colors duration-300';
                }
                // Render loading efficiency data - ‡πÉ‡∏ä‡πâ runFilterEngine ‡πÄ‡∏û‡∏∑‡πà‡∏≠ filter ‡∏ó‡∏±‡πâ‡∏á 3 parts
                console.log('üéØ Calling runFilterEngine for all 3 parts...');
                runFilterEngine();
            } else if (t === 'product') {
                if (loadFilters) loadFilters.classList.add('hidden');
                if (milkFilters) milkFilters.classList.add('hidden');
                if (thFilters) thFilters.classList.add('hidden');
                if (mainFilters) {
                    mainFilters.classList.remove('hidden');
                    mainFilters.classList.add('flex');
                }
                if (title) title.innerText = 'Product & Customer Analysis';
                if (bar) {
                    bar.className = 'w-1.5 h-10 bg-purple-500 rounded-full transition-colors duration-300';
                }
                // Render the product data
                console.log('üéØ Calling renderProductPart...');
                renderProductPart();
            } else if (t === 'milkrun') {
                if (mainFilters) mainFilters.classList.add('hidden');
                if (loadFilters) loadFilters.classList.add('hidden');
                if (thFilters) thFilters.classList.add('hidden');
                if (milkFilters) {
                    milkFilters.classList.remove('hidden');
                    milkFilters.classList.add('flex');
                }
                if (title) title.innerText = 'Milk Run Analysis';
                if (bar) {
                    bar.className = 'w-1.5 h-10 bg-blue-500 rounded-full transition-colors duration-300';
                }
                // Render milk run data
                console.log('üéØ Calling renderMilkRunPart...');
                runMilkRunFilterEngine();
            } else if (t === 'tonshead') {
                if (mainFilters) mainFilters.classList.add('hidden');
                if (loadFilters) loadFilters.classList.add('hidden');
                if (milkFilters) milkFilters.classList.add('hidden');
                if (thFilters) {
                    thFilters.classList.remove('hidden');
                    thFilters.classList.add('flex');
                }
                if (title) title.innerText = 'Tons/Head Analysis';
                if (bar) {
                    bar.className = 'w-1.5 h-10 bg-purple-500 rounded-full transition-colors duration-300';
                }
                // Render the tons/head data with delay to ensure DOM is ready
                console.log('üéØ Calling renderTonsHeadPart with delay...');
                setTimeout(() => {
                    renderTonsHeadPart();
                }, 50);
            }
        }

        // --- DATA FETCHING ---
        async function fetchEverything() {
            if (isLoading) return;
            isLoading = true;
            masterData = [];
            loadingData = [];
            milkRunWMS = [];
            milkRunSAP = [];
            milkRunCombined = [];
            
            const modal = document.getElementById('loading-modal');
            if (modal) { modal.classList.remove('hidden'); modal.classList.add('flex'); }
            document.getElementById('progress-bar').style.width = '0%';
            
            // Helper function to update individual table progress
            function updateTableProgress(tableId, percent) {
                const progressBar = document.getElementById(`progress-${tableId}`);
                const progressPercent = document.getElementById(`progress-${tableId}-percent`);
                if (progressBar) progressBar.style.width = percent + '%';
                if (progressPercent) progressPercent.innerText = Math.round(percent) + '%';
            }
            
            // Helper function to update overall progress
            function updateOverallProgress(percent) {
                const modalProgress = document.getElementById('modal-progress');
                const modalOverallPercent = document.getElementById('modal-overall-percent');
                if (modalProgress) modalProgress.style.width = percent + '%';
                if (modalOverallPercent) modalOverallPercent.innerText = Math.round(percent) + '%';
            }

            try {
                // 1. Fetch FG In-Out
                let from = 0, to = 999, isEnd = false;
                const { count: countFG } = await _db.from('FG In-Out').select('*', { count: 'exact', head: true });
                
                while (!isEnd) {
                    const { data, error } = await _db.from('FG In-Out')
                        .select('Month, Week, Date, "Shipment type", "Gross weight", Shipment, "Type Truck", "Sloc.", Material, "Delivery quantity", "Group Sale", "Product Type", "Group Customer", Customer')
                        .range(from, to);
                    if (error) throw error;
                    masterData = [...masterData, ...data];
                    const tablePercent = countFG ? (masterData.length / countFG) * 100 : 100;
                    updateTableProgress('fginout', tablePercent);
                    updateOverallProgress(tablePercent * 0.1667); // FG = 16.67% of total (1/6)
                    
                    if (data.length < 1000) isEnd = true;
                    else { from += 1000; to += 1000; }
                }
                
                // ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ô‡∏±‡∏ö Shipment
                masterDataOriginal = [...masterData];
                console.log('‚úÖ FG In-Out loaded:', masterDataOriginal.length, 'rows');

                // 2. Fetch LoadingTime
                from = 0; to = 999; isEnd = false;
                const { count: countLoad } = await _db.from('LoadingTime').select('*', { count: 'exact', head: true });

                while (!isEnd) {
                    const { data, error } = await _db.from('LoadingTime')
                        .select('Month, Week, Factory, Date, Weight_Out, "Time Out"')
                        .range(from, to);
                    
                    if (error) { console.warn(error); isEnd = true; }
                    else {
                        loadingData = [...loadingData, ...data];
                        const tablePercent = countLoad ? (loadingData.length / countLoad) * 100 : 100;
                        updateTableProgress('loadingtime', tablePercent);
                        updateOverallProgress(16.67 + (tablePercent * 0.1667)); // Loading = 16.67-33.33%

                        if (data.length < 1000) isEnd = true;
                        else { from += 1000; to += 1000; }
                    }
                }
                console.log('‚úÖ LoadingTime loaded:', loadingData.length, 'rows');

                // 3. Fetch M_WMS
                from = 0; to = 999; isEnd = false;
                const { count: countWMS } = await _db.from('M_WMS').select('*', { count: 'exact', head: true });
                while (!isEnd) {
                    const { data, error } = await _db.from('M_WMS').select('*').range(from, to);
                    if (error) { console.warn(error); isEnd = true; } 
                    else {
                        milkRunWMS = [...milkRunWMS, ...data];
                        const tablePercent = countWMS ? (milkRunWMS.length / countWMS) * 100 : 100;
                        updateTableProgress('mwms', tablePercent);
                        updateOverallProgress(33.33 + (tablePercent * 0.1667)); // M_WMS = 33.33-50%
                        
                        if (data.length < 1000) isEnd = true; else { from += 1000; to += 1000; }
                    }
                }
                console.log('‚úÖ M_WMS loaded:', milkRunWMS.length, 'rows');

                // 4. Fetch M_SAP
                from = 0; to = 999; isEnd = false;
                const { count: countSAP } = await _db.from('M_SAP').select('*', { count: 'exact', head: true });
                while (!isEnd) {
                    const { data, error } = await _db.from('M_SAP').select('*').range(from, to);
                    if (error) { console.warn(error); isEnd = true; } 
                    else {
                        milkRunSAP = [...milkRunSAP, ...data];
                        const tablePercent = countSAP ? (milkRunSAP.length / countSAP) * 100 : 100;
                        updateTableProgress('msap', tablePercent);
                        updateOverallProgress(50 + (tablePercent * 0.1667)); // M_SAP = 50-66.67%
                        
                        if (data.length < 1000) isEnd = true; else { from += 1000; to += 1000; }
                    }
                }
                console.log('‚úÖ M_SAP loaded:', milkRunSAP.length, 'rows');
                
                // 5. Fetch Head Data
                from = 0; to = 999; isEnd = false;
                const { count: countHead } = await _db.from('Head').select('*', { count: 'exact', head: true });
                while (!isEnd) {
                    const { data, error } = await _db.from('Head').select('*').range(from, to);
                    if (error) { console.warn(error); isEnd = true; } 
                    else {
                        headData = [...headData, ...data];
                        const tablePercent = countHead ? (headData.length / countHead) * 100 : 100;
                        updateTableProgress('head', tablePercent);
                        updateOverallProgress(66.67 + (tablePercent * 0.1667)); // Head = 66.67-83.33%
                        
                        if (data.length < 1000) isEnd = true; else { from += 1000; to += 1000; }
                    }
                }

                // Build cache for quick lookup
                headDataCache = {};
                headData.forEach(item => {
                    if (item.Month) {
                        headDataCache[item.Month] = parseInt(item.Working_Days) || 0;
                    }
                });
                console.log('‚úÖ Head data loaded:', headData.length, 'rows');

                // 6. Fetch Employee Data
                console.log('üì• Fetching Employee data...');
                const { data: empData, error: empError } = await _db.from('Employee').select('*');
                if (empError) {
                    console.warn('‚ö†Ô∏è Employee table error:', empError);
                    employeeData = [];
                } else {
                    employeeData = empData || [];
                    updateTableProgress('employee', 100);
                    updateOverallProgress(83.33 + (100 * 0.1667)); // Employee = 83.33-100%
                    console.log('‚úÖ Employee data loaded:', employeeData.length, 'rows');
                }

                milkRunCombined = [...milkRunWMS]; 
                
                // Setup initial state
                switchTab('loading');
                
                document.getElementById('status-dot').className = "w-3 h-3 bg-emerald-500 rounded-full mr-2";
                document.getElementById('load-status').innerText = "Online";
                
                setTimeout(() => {
                    if (modal) { modal.classList.add('hidden'); modal.classList.remove('flex'); }
                    initDashboard();
                }, 500);
                
            } catch (err) {
                console.error(err);
                document.getElementById('status-dot').className = "w-3 h-3 bg-red-500 rounded-full mr-2";
                document.getElementById('load-status').innerText = "Error";
            } finally {
                isLoading = false;
            }
        }

        function initDashboard() {
            generateFiltersUI();
            // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤ loading-efficiency
            switchTab('loading-efficiency');
        }

        function generateFiltersUI() {
            // Main Filters - ‡∏£‡∏ß‡∏° Month ‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πâ‡∏á masterData ‡πÅ‡∏•‡∏∞ loadingData
            const months = new Set(), weeks = new Set(), slocs = new Set(), shipTypes = new Set();
            
            // ‡πÄ‡∏Å‡πá‡∏ö Month ‡∏à‡∏≤‡∏Å masterData
            masterData.forEach(d => {
                if (d.Month) months.add(d.Month);
                if (d.Week) weeks.add(d.Week);
                if (d['Sloc.']) slocs.add(d['Sloc.']);
                if (d['Shipment type']) shipTypes.add(d['Shipment type']);
            });
            
            // ‡∏£‡∏ß‡∏° Month ‡∏à‡∏≤‡∏Å loadingData ‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö)
            loadingData.forEach(d => {
                if (d.Month) months.add(d.Month);
                if (d.Week) weeks.add(d.Week);
            });
            
            console.log('üìä Main Filter - Combined Months from masterData + loadingData:', Array.from(months));

            // Loading Filters
            const lMonths = new Set(), lWeeks = new Set(), lFactory = new Set(), lDates = new Set();
            loadingData.forEach(d => {
                if (d.Month) lMonths.add(d.Month);
                if (d.Week) lWeeks.add(d.Week);
                if (d.Factory) lFactory.add(d.Factory);
                if (d.Date) lDates.add(d.Date);
            });
            
            // Milk Run Filters
            const mMonths = new Set(), mWeeks = new Set(), mDates = new Set();
            milkRunCombined.forEach(d => {
                // Using column '‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà' for Week filter
                if (d.Month) mMonths.add(d.Month);
                if (d['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà']) mWeeks.add(d['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà']);
                if (d.Date) mDates.add(d.Date);
            });

            const renderList = (id, set, filterFnName) => {
                let vals = Array.from(set);
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö month filters)
                if (id.includes('month')) {
                    const monthOrder = {
                        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 1, '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 2, '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 3, '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 4,
                        '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 5, '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 6, '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 7, '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 8,
                        '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 9, '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 10, '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 11, '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 12
                    };
                    vals.sort((a, b) => {
                        const orderA = monthOrder[a] || 99;
                        const orderB = monthOrder[b] || 99;
                        return orderA - orderB;
                    });
                } else {
                    vals.sort();
                }
                
                const el = document.getElementById(id);
                if (!el) return;
                el.innerHTML = vals.map(v => 
                    `<label class="flex items-center space-x-3 p-2 hover:bg-slate-50 rounded-lg cursor-pointer text-sm font-bold text-slate-600">
                        <input type="checkbox" value="${v}" onchange="${filterFnName}()" class="filter-${id} w-4 h-4 rounded text-amber-500 border-slate-300 focus:ring-amber-500">
                        <span>${v}</span>
                    </label>`
                ).join('');
            };
            
            renderList('list-month', months, 'runFilterEngine'); 
            renderList('list-week', weeks, 'runFilterEngine'); 
            renderList('list-sloc', slocs, 'runFilterEngine');
            renderList('list-ship-type', shipTypes, 'runFilterEngine');

            renderList('list-l-month', lMonths, 'runLoadingFilterEngine');
            renderList('list-l-week', lWeeks, 'runLoadingFilterEngine');
            renderList('list-l-factory', lFactory, 'runLoadingFilterEngine');
            renderList('list-l-date', lDates, 'runLoadingFilterEngine'); 
            
            renderList('list-m-month', mMonths, 'runMilkRunFilterEngine');
            renderList('list-m-week', mWeeks, 'runMilkRunFilterEngine');
            renderList('list-m-date', mDates, 'runMilkRunFilterEngine');

            // Tons/Head Filters (NEW)
            const thMonths = new Set();
            headData.forEach(d => {
                if (d.Month) thMonths.add(d.Month);
            });
            renderList('list-th-month', thMonths, 'runTonsHeadFilterEngine');
        }

        function clearAllFilters(type) {
            if (type === 'main') {
                ['list-month', 'list-week', 'list-sloc', 'list-ship-type'].forEach(id => {
                    document.querySelectorAll(`.filter-${id}`).forEach(el => el.checked = false);
                });
                runFilterEngine();
            } else if (type === 'loading') {
                ['list-l-month', 'list-l-week', 'list-l-factory', 'list-l-date'].forEach(id => {
                    document.querySelectorAll(`.filter-${id}`).forEach(el => el.checked = false);
                });
                runLoadingFilterEngine();
            } else if (type === 'milkrun') {
                ['list-m-month', 'list-m-week', 'list-m-date'].forEach(id => {
                    document.querySelectorAll(`.filter-${id}`).forEach(el => el.checked = false);
                });
                runMilkRunFilterEngine();
            } else if (type === 'tonshead') {
                document.querySelectorAll('.filter-list-th-month').forEach(el => el.checked = false);
                runTonsHeadFilterEngine();
            }
        }

        function runFilterEngine() {
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç MAIN FILTER ENGINE');
            console.log('   Applies to: Weight Analysis, Shipment Operations, Loading Time');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-month');
            const w = getChecked('list-week');
            const s = getChecked('list-sloc'); // Sloc = Factory
            const st = getChecked('list-ship-type');
            
            console.log('Selected Filters:');
            console.log('  Month:', m.length > 0 ? m : 'All');
            console.log('  Week:', w.length > 0 ? w : 'All');
            console.log('  Sloc/Factory:', s.length > 0 ? s : 'All');
            console.log('  Shipment Type:', st.length > 0 ? st : 'All');
            console.log('');
            
            // Filter masterData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PART 1 & 2 (Weight Analysis, Shipment Operations)
            const filtered = masterData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (s.length > 0 && !s.includes(item['Sloc.'])) return false;
                if (st.length > 0 && !st.includes(item['Shipment type'])) return false;
                return true;
            });
            
            console.log('‚úÖ Filtered masterData (Weight/Shipment):', filtered.length, 'rows');
            
            // Filter loadingData ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö PART 3 (Loading Time) ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ filters ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô
            // ‡πÇ‡∏î‡∏¢ Sloc ‡∏à‡∏≤‡∏Å masterData = Factory ‡∏à‡∏≤‡∏Å loadingData
            const filteredLoading = loadingData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (s.length > 0 && !s.includes(item.Factory)) return false; // Factory = Sloc
                return true;
            });
            
            console.log('‚úÖ Filtered loadingData (Loading Time):', filteredLoading.length, 'rows');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            console.log('‚úÖ Filtered loadingData:', filteredLoading.length, 'rows');
            
            // Refresh PART 1 & 2
            refreshAllCharts(filtered);
            
            // Refresh PART 3
            renderLoadingChart(filteredLoading);
        }

        function runLoadingFilterEngine() {
            console.log('üîç Running Loading Filter Engine (PART 3 specific)');
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-l-month');
            const w = getChecked('list-l-week');
            const f = getChecked('list-l-factory'); // Factory = Sloc
            const d = getChecked('list-l-date');
            
            console.log('Loading Filters:', {month: m.length, week: w.length, factory: f.length, date: d.length});
            
            const filtered = loadingData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (f.length > 0 && !f.includes(item.Factory)) return false;
                if (d.length > 0 && !d.includes(item.Date)) return false;
                return true;
            });
            
            console.log('‚úÖ Filtered loadingData:', filtered.length, 'rows');
            renderLoadingChart(filtered);
        }
        
        function runMilkRunFilterEngine() {
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-m-month');
            const w = getChecked('list-m-week');
            const d = getChecked('list-m-date');
            
            // Filter Part 1 (WMS)
            const filteredWMS = milkRunCombined.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà'])) return false;
                if (d.length > 0 && !d.includes(item.Date)) return false;
                return true;
            });

            // Filter Part 2 (SAP)
            const filteredSAP = milkRunSAP.filter(item => {
                // Assuming SAP table also has these columns or similar for filtering. 
                // If not, we might need different logic. Assuming consistency for now based on previous requests.
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item['‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ó‡∏µ‡πà'])) return false;
                if (d.length > 0 && !d.includes(item.Date)) return false;
                return true;
            });

            renderMilkRunPart(filteredWMS, filteredSAP);
        }

        function setLoadingViewMode(mode) {
            loadingViewMode = mode;
            // Update buttons
            const btnDaily = document.getElementById('btn-view-daily');
            const btnMonthly = document.getElementById('btn-view-monthly');
            
            if (mode === 'daily') {
                btnDaily.className = 'px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white text-emerald-600 shadow-sm';
                btnMonthly.className = 'px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600';
            } else {
                btnMonthly.className = 'px-4 py-2 rounded-lg text-xs font-bold transition-all bg-white text-emerald-600 shadow-sm';
                btnDaily.className = 'px-4 py-2 rounded-lg text-xs font-bold transition-all text-slate-400 hover:text-slate-600';
            }
            
            runLoadingFilterEngine(); // Re-render with current filtered data
        }

        function refreshAllCharts(data) {
            try {
                renderWeightPart(data);
                renderShipmentPart(data);
                // renderProductPart ‡∏à‡∏∞ filter ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏≠‡∏á
                if (document.getElementById('section-product') && !document.getElementById('section-product').classList.contains('hidden')) {
                    renderProductPart();
                }
            } catch (err) { console.error(err); }
        }

        // ... (Render Main Chart Functions: renderWeightPart, renderShipmentPart, renderProductPart, drawPie, drawBar - Same as before)
        function renderWeightPart(data) {
            let outW = 0, inW = 0;
            const gType = {}, gTruck = {};
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const type = r['Shipment type'] || 'Unknown';
                const truck = r['Type Truck'] || 'Unknown';
                
                // Weight Out Condition (Original)
                if (type === '‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤' || type === '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á') outW += w;
                
                // Weight In Condition (Updated)
                if (type === '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO' || type === '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤' || type === '‡∏£‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤') {
                    inW += w;
                }

                gType[type] = (gType[type] || 0) + w; 
                gTruck[truck] = (gTruck[truck] || 0) + w;
            }
            const fmt = (v) => (v / 1000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('card-out-w').innerText = fmt(outW);
            document.getElementById('card-in-w').innerText = fmt(inW);
            document.getElementById('card-total-w').innerText = fmt(outW + inW);
            drawPie('chartWType', 'legendWType', gType, outW + inW);
            drawPie('chartWTruck', 'legendWTruck', gTruck, outW + inW);
        }

        function renderShipmentPart(data) {
            const shipMap = {'‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤': 'cnt-shipping', '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏°‡∏≤‡∏£‡∏±‡∏ö‡πÄ‡∏≠‡∏á': 'cnt-pickup', '‡∏£‡∏±‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏à‡∏≤‡∏Å PO': 'cnt-inbound'};
            Object.keys(shipMap).forEach(k => {
                const set = new Set();
                for (let i = 0; i < data.length; i++) {
                    if (data[i]['Shipment type'] === k) set.add(data[i].Shipment);
                }
                const el = document.getElementById(shipMap[k]);
                if (el) el.innerText = set.size.toLocaleString();
            });
            const gCTruck = {};
            for (let i = 0; i < data.length; i++) {
                const tr = data[i]['Type Truck'] || 'Unknown';
                if (!gCTruck[tr]) gCTruck[tr] = new Set();
                gCTruck[tr].add(data[i].Shipment);
            }
            const finalC = {}; let sumC = 0;
            Object.keys(gCTruck).forEach(k => { finalC[k] = gCTruck[k].size; sumC += gCTruck[k].size; });
            drawPie('chartCTruck', 'legendCTruck', finalC, sumC, true);
        }

        function renderProductPart() {
            console.log('=== üé® START renderProductPart ===');
            
            // ‡πÉ‡∏ä‡πâ filtered masterData ‡∏à‡∏≤‡∏Å filter engine
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const m = getChecked('list-month');
            const w = getChecked('list-week');
            const s = getChecked('list-sloc');
            const st = getChecked('list-ship-type');
            
            const data = masterData.filter(item => {
                if (m.length > 0 && !m.includes(item.Month)) return false;
                if (w.length > 0 && !w.includes(item.Week)) return false;
                if (s.length > 0 && !s.includes(item['Sloc.'])) return false;
                if (st.length > 0 && !st.includes(item['Shipment type'])) return false;
                return true;
            });
            console.log('üìä Using filtered data rows:', data.length);
            
            const gSale = {}, gProd = {}, gMat = {}, gCustGroup = {}, uniqueGroups = new Set();
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const q = parseFloat(r['Delivery quantity']) || 0;
                const sale = r['Group Sale'] || 'N/A';
                const pType = r['Product Type'] || 'N/A';
                const mat = r.Material || 'Unknown';
                const custGroup = r['Group Customer'] || 'Others';
                gSale[sale] = (gSale[sale] || 0) + w; 
                gProd[pType] = (gProd[pType] || 0) + w;
                gCustGroup[custGroup] = (gCustGroup[custGroup] || 0) + w;
                if (!gMat[mat]) gMat[mat] = { w: 0, q: 0 };
                gMat[mat].w += w; gMat[mat].q += q;
                if (custGroup) uniqueGroups.add(custGroup);
            }
            
            console.log('üì¶ Group Sale categories:', Object.keys(gSale).length);
            console.log('üì¶ Product Type categories:', Object.keys(gProd).length);
            console.log('üì¶ Customer Group categories:', Object.keys(gCustGroup).length);
            
            drawBar('chartGroupSale', 'container-GroupSale', gSale);
            drawBar('chartProdType', 'container-ProdType', gProd);
            const sorted = Object.entries(gMat).sort((a, b) => b[1].w - a[1].w).slice(0, 10);
            const listEl = document.getElementById('top-product-list');
            if (listEl) {
                listEl.innerHTML = sorted.map(([name, val], i) => `
                    <tr class="hover:bg-slate-50 transition-all border-b border-slate-100 last:border-0 group">
                        <td class="px-6 py-5 text-center"><span class="inline-flex items-center justify-center w-8 h-8 rounded-full text-xs font-black ${i < 3 ? 'bg-amber-500 text-white shadow-md' : 'bg-slate-200 text-slate-500'}">#${i+1}</span></td>
                        <td class="px-6 py-5 font-bold text-slate-700 group-hover:text-amber-600 transition-colors uppercase" title="${name}">${name.length > 50 ? name.substring(0, 47) + '...' : name}</td>
                        <td class="px-6 py-5 text-right font-bold text-slate-400">${val.q.toLocaleString()}</td>
                        <td class="px-6 py-5 text-right font-black text-slate-800 text-lg tracking-tighter">${(val.w/1000).toLocaleString(undefined,{minimumFractionDigits:2})}</td>
                    </tr>`).join('');
            }
            const totalCustW = Object.values(gCustGroup).reduce((a,b)=>a+b,0);
            drawPie('chartGroupCust', 'legendGroupCust', gCustGroup, totalCustW);
            console.log('‚úÖ Charts rendered successfully');
            console.log('=== ‚úÖ END renderProductPart ===');
            const dropdown = document.getElementById('filter-group-cust');
            const currentSelection = dropdown.value; 
            dropdown.innerHTML = '<option value="ALL">All Groups</option>';
            Array.from(uniqueGroups).sort().forEach(g => {
                const opt = document.createElement('option'); opt.value = g; opt.innerText = g; dropdown.appendChild(opt);
            });
            if (Array.from(dropdown.options).some(o => o.value === currentSelection)) dropdown.value = currentSelection;
            dropdown.onchange = () => renderTopCustomers(data);
            renderTopCustomers(data);
        }

        function renderTopCustomers(data) {
            const dropdown = document.getElementById('filter-group-cust');
            const selectedGroup = dropdown.value;
            const gCustomer = {};
            const customerGroupSales = {}; // ‡πÄ‡∏Å‡πá‡∏ö Group Sale ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Customer
            
            for (let i = 0; i < data.length; i++) {
                const r = data[i];
                const w = parseFloat(r['Gross weight']) || 0;
                const wTons = w / 1000; // ‡πÅ‡∏õ‡∏•‡∏á kg ‡πÄ‡∏õ‡πá‡∏ô Tons
                const custName = r.Customer || 'Unknown';
                const custGroup = r['Group Customer'] || 'Others';
                const groupSale = r['Group Sale'] || 'Unknown';
                
                if (selectedGroup !== 'ALL' && custGroup !== selectedGroup) continue;
                
                gCustomer[custName] = (gCustomer[custName] || 0) + wTons;
                
                // ‡πÄ‡∏Å‡πá‡∏ö Group Sale ‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ Customer
                if (!customerGroupSales[custName]) {
                    customerGroupSales[custName] = {};
                }
                customerGroupSales[custName][groupSale] = (customerGroupSales[custName][groupSale] || 0) + wTons;
            }
            
            const top10Obj = Object.fromEntries(Object.entries(gCustomer).sort((a, b) => b[1] - a[1]).slice(0, 10));
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü‡∏û‡∏£‡πâ‡∏≠‡∏° onClick event
            drawBarWithClick('chartTopCustomer', 'container-TopCustomer', top10Obj, (customerName) => {
                // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà Customer ‚Üí ‡πÅ‡∏™‡∏î‡∏á Group Sale
                showCustomerGroupSales(customerName, customerGroupSales[customerName], data);
            });
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á Group Sale ‡∏Ç‡∏≠‡∏á Customer ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
        function showCustomerGroupSales(customerName, groupSalesData, originalData) {
            console.log('üìä Customer clicked:', customerName);
            console.log('üìä Group Sales data:', groupSalesData);
            
            if (!groupSalesData || Object.keys(groupSalesData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Group Sale ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${customerName}`);
                return;
            }
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal/popup ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
            const modalHTML = `
                <div id="customer-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-blue-500 to-purple-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üìä ${customerName}</h3>
                                <p class="text-sm opacity-90 mt-1">Top Group Sales by Weight</p>
                            </div>
                            <button onclick="document.getElementById('customer-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-customer-groupsale"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            const oldModal = document.getElementById('customer-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü Group Sale
            setTimeout(() => {
                const canvas = document.getElementById('chart-customer-groupsale');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                const sortedData = Object.entries(groupSalesData).sort((a, b) => b[1] - a[1]);
                const labels = sortedData.map(e => e[0]);
                const dataValues = sortedData.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Weight (Tons)',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y', // Horizontal bar
                        layout: { 
                            padding: { 
                                right: 150,  // ‡πÄ‡∏û‡∏¥‡πà‡∏° padding ‡∏Ç‡∏ß‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ label ‡∏°‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á
                                left: 10,
                                top: 10,
                                bottom: 10
                            } 
                        },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                formatter: (val) => val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' Tons',
                                clip: false,  // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ label ‡πÅ‡∏™‡∏î‡∏á‡∏ô‡∏≠‡∏Å chart area
                                offset: 8     // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å bar
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const val = ctx.raw;
                                        return `Weight: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { 
                                display: false,
                                grace: '5%'  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà 5% ‡πÄ‡∏û‡∏∑‡πà‡∏≠ label
                            },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á Check Cap Details ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
        function showCheckCapDetails(checkCapValue, detailsData, totalAll) {
            console.log('üìä Check Cap clicked:', checkCapValue);
            console.log('üìä Details (raw):', detailsData);
            
            if (!detailsData || Object.keys(detailsData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ Details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${checkCapValue}`);
                return;
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô (‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å detailsData ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏´‡∏•‡∏≤‡∏¢ key ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏±‡∏ô)
            const aggregatedData = {};
            Object.entries(detailsData).forEach(([key, count]) => {
                aggregatedData[key] = (aggregatedData[key] || 0) + count;
            });
            
            console.log('üìä Details (aggregated):', aggregatedData);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡∏Ç‡∏≠‡∏á checkCapValue ‡∏ô‡∏µ‡πâ
            const totalThis = Object.values(aggregatedData).reduce((a, b) => a + b, 0);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal
            const modalHTML = `
                <div id="checkcap-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-cyan-500 to-blue-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üîç ${checkCapValue}</h3>
                                <p class="text-sm opacity-90 mt-1">Check Cap Details Breakdown (Total: ${totalThis})</p>
                            </div>
                            <button onclick="document.getElementById('checkcap-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-checkcap-detail"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤
            const oldModal = document.getElementById('checkcap-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                const canvas = document.getElementById('chart-checkcap-detail');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ (‡πÉ‡∏ä‡πâ aggregatedData ‡πÅ‡∏ó‡∏ô detailsData)
                const sortedData = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);
                const labels = sortedData.map(e => e[0]);
                const dataValues = sortedData.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 150, left: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const count = ctx.raw;
                                        const percentOfThis = ((count / totalThis) * 100).toFixed(1);
                                        const percentOfAll = ((count / totalAll) * 100).toFixed(1);
                                        return [
                                            `Count: ${count}`,
                                            `% of ${checkCapValue}: ${percentOfThis}%`,
                                            `% of Total: ${percentOfAll}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                formatter: (val) => {
                                    const percent = ((val / totalThis) * 100).toFixed(1);
                                    return `${val} (${percent}%)`;
                                },
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: { display: false, grace: '5%' },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 40 ? label.substring(0, 40) + '...' : label;
                                    }
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Details ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
        function showDepositorDetails(depositorValue, detailsData, totalAll) {
            console.log('üìä ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å clicked:', depositorValue);
            console.log('üìä Details (raw):', detailsData);
            
            if (!detailsData || Object.keys(detailsData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ Details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${depositorValue}`);
                return;
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const aggregatedData = {};
            Object.entries(detailsData).forEach(([key, count]) => {
                aggregatedData[key] = (aggregatedData[key] || 0) + count;
            });
            
            console.log('üìä Details (aggregated):', aggregatedData);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡∏Ç‡∏≠‡∏á depositorValue ‡∏ô‡∏µ‡πâ
            const totalThis = Object.values(aggregatedData).reduce((a, b) => a + b, 0);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal
            const modalHTML = `
                <div id="depositor-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-purple-500 to-pink-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üîç ${depositorValue}</h3>
                                <p class="text-sm opacity-90 mt-1">‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Details Breakdown (Total: ${totalThis})</p>
                            </div>
                            <button onclick="document.getElementById('depositor-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-depositor-detail"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤
            const oldModal = document.getElementById('depositor-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                const canvas = document.getElementById('chart-depositor-detail');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                const sortedData = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);
                const labels = sortedData.map(e => e[0]);
                const dataValues = sortedData.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 150, left: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const count = ctx.raw;
                                        const percentOfThis = ((count / totalThis) * 100).toFixed(1);
                                        const percentOfAll = ((count / totalAll) * 100).toFixed(1);
                                        return [
                                            `Count: ${count}`,
                                            `% of ${depositorValue}: ${percentOfThis}%`,
                                            `% of Total: ${percentOfAll}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                formatter: (val) => {
                                    const percent = ((val / totalThis) * 100).toFixed(1);
                                    return `${val} (${percent}%)`;
                                },
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: { display: false, grace: '5%' },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 40 ? label.substring(0, 40) + '...' : label;
                                    }
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Fac) Details ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
        function showReceiverDetails(facValue, detailsData, totalAll) {
            console.log('üìä Fac clicked:', facValue);
            console.log('üìä Details (raw):', detailsData);
            
            if (!detailsData || Object.keys(detailsData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ Details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${facValue}`);
                return;
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const aggregatedData = {};
            Object.entries(detailsData).forEach(([key, count]) => {
                aggregatedData[key] = (aggregatedData[key] || 0) + count;
            });
            
            console.log('üìä Details (aggregated):', aggregatedData);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡∏Ç‡∏≠‡∏á facValue ‡∏ô‡∏µ‡πâ
            const totalThis = Object.values(aggregatedData).reduce((a, b) => a + b, 0);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal
            const modalHTML = `
                <div id="receiver-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-green-500 to-teal-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üîç ${facValue}</h3>
                                <p class="text-sm opacity-90 mt-1">‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Breakdown (Total: ${totalThis})</p>
                            </div>
                            <button onclick="document.getElementById('receiver-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-receiver-detail"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤
            const oldModal = document.getElementById('receiver-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                const canvas = document.getElementById('chart-receiver-detail');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                const sortedData = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);
                const labels = sortedData.map(e => e[0]);
                const dataValues = sortedData.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 150, left: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const count = ctx.raw;
                                        const percentOfThis = ((count / totalThis) * 100).toFixed(1);
                                        const percentOfAll = ((count / totalAll) * 100).toFixed(1);
                                        return [
                                            `Count: ${count}`,
                                            `% of ${facValue}: ${percentOfThis}%`,
                                            `% of Total: ${percentOfAll}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                formatter: (val) => {
                                    const percent = ((val / totalThis) * 100).toFixed(1);
                                    return `${val} (${percent}%)`;
                                },
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: { display: false, grace: '5%' },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 40 ? label.substring(0, 40) + '...' : label;
                                    }
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á Sloc Details ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
        function showSlocDetails(slocValue, detailsData, totalAll) {
            console.log('üìä Sloc clicked:', slocValue);
            console.log('üìä Details (raw):', detailsData);
            
            if (!detailsData || Object.keys(detailsData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ Details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${slocValue}`);
                return;
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const aggregatedData = {};
            Object.entries(detailsData).forEach(([key, count]) => {
                aggregatedData[key] = (aggregatedData[key] || 0) + count;
            });
            
            console.log('üìä Details (aggregated):', aggregatedData);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡∏Ç‡∏≠‡∏á slocValue ‡∏ô‡∏µ‡πâ
            const totalThis = Object.values(aggregatedData).reduce((a, b) => a + b, 0);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal
            const modalHTML = `
                <div id="sloc-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-pink-500 to-rose-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üîç ${slocValue}</h3>
                                <p class="text-sm opacity-90 mt-1">Sloc Details Breakdown (Total: ${totalThis})</p>
                            </div>
                            <button onclick="document.getElementById('sloc-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-sloc-detail"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤
            const oldModal = document.getElementById('sloc-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                const canvas = document.getElementById('chart-sloc-detail');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢
                const sortedData = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);
                const labels = sortedData.map(e => e[0]);
                const dataValues = sortedData.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 150, left: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const count = ctx.raw;
                                        const percentOfThis = ((count / totalThis) * 100).toFixed(1);
                                        const percentOfAll = ((count / totalAll) * 100).toFixed(1);
                                        return [
                                            `Count: ${count}`,
                                            `% of ${slocValue}: ${percentOfThis}%`,
                                            `% of Total: ${percentOfAll}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                formatter: (val) => {
                                    const percent = ((val / totalThis) * 100).toFixed(1);
                                    return `${val} (${percent}%)`;
                                },
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: { display: false, grace: '5%' },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 40 ? label.substring(0, 40) + '...' : label;
                                    }
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: ‡πÅ‡∏™‡∏î‡∏á Sloc ‚Üí Customer Details ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å
        function showSlocCustomerDetails(slocValue, detailsData, totalAll) {
            console.log('üìä Sloc clicked:', slocValue);
            console.log('üìä Details (raw):', detailsData);
            
            if (!detailsData || Object.keys(detailsData).length === 0) {
                alert(`‡πÑ‡∏°‡πà‡∏°‡∏µ Customer Details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${slocValue}`);
                return;
            }
            
            // ‡∏£‡∏ß‡∏°‡∏ô‡∏±‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ã‡πâ‡∏≥‡∏Å‡∏±‡∏ô
            const aggregatedData = {};
            Object.entries(detailsData).forEach(([key, count]) => {
                aggregatedData[key] = (aggregatedData[key] || 0) + count;
            });
            
            console.log('üìä Details (aggregated):', aggregatedData);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì total ‡∏Ç‡∏≠‡∏á slocValue ‡∏ô‡∏µ‡πâ
            const totalThis = Object.values(aggregatedData).reduce((a, b) => a + b, 0);
            const customerCount = Object.keys(aggregatedData).length;
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á modal
            const modalHTML = `
                <div id="sloccustomer-drilldown-modal" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" onclick="if(event.target === this) this.remove()">
                    <div class="bg-white rounded-3xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <div class="sticky top-0 bg-gradient-to-r from-emerald-500 to-teal-600 text-white p-6 rounded-t-3xl flex justify-between items-center">
                            <div>
                                <h3 class="text-2xl font-black">üîç ${slocValue}</h3>
                                <p class="text-sm opacity-90 mt-1">Top 10 Customers (Total: ${totalThis} from ${customerCount} customers)</p>
                            </div>
                            <button onclick="document.getElementById('sloccustomer-drilldown-modal').remove()" class="bg-white/20 hover:bg-white/30 rounded-full w-10 h-10 flex items-center justify-center transition">
                                <span class="text-2xl">√ó</span>
                            </button>
                        </div>
                        <div class="p-8">
                            <div class="relative" style="height: 400px">
                                <canvas id="chart-sloccustomer-detail"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // ‡∏•‡∏ö modal ‡πÄ‡∏Å‡πà‡∏≤
            const oldModal = document.getElementById('sloccustomer-drilldown-modal');
            if (oldModal) oldModal.remove();
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° modal ‡πÉ‡∏´‡∏°‡πà
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏≤‡∏ü
            setTimeout(() => {
                const canvas = document.getElementById('chart-sloccustomer-detail');
                if (!canvas) return;
                
                // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡πÑ‡∏õ‡∏ô‡πâ‡∏≠‡∏¢ ‡πÅ‡∏•‡∏∞‡πÄ‡∏≠‡∏≤‡πÅ‡∏Ñ‡πà Top 10
                const sortedData = Object.entries(aggregatedData).sort((a, b) => b[1] - a[1]);
                const top10Data = sortedData.slice(0, 10);
                const labels = top10Data.map(e => e[0]);
                const dataValues = top10Data.map(e => e[1]);
                const colors = generateColors(labels.length);
                
                new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Count',
                            data: dataValues,
                            backgroundColor: colors,
                            borderRadius: 8,
                            barPercentage: 0.7
                        }]
                    },
                    options: {
                        maintainAspectRatio: false,
                        indexAxis: 'y',
                        layout: { padding: { right: 150, left: 10 } },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const count = ctx.raw;
                                        const percentOfThis = ((count / totalThis) * 100).toFixed(1);
                                        const percentOfAll = ((count / totalAll) * 100).toFixed(1);
                                        return [
                                            `Count: ${count}`,
                                            `% of ${slocValue}: ${percentOfThis}%`,
                                            `% of Total: ${percentOfAll}%`
                                        ];
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'end',
                                color: '#334155',
                                formatter: (val) => {
                                    const percent = ((val / totalThis) * 100).toFixed(1);
                                    return `${val} (${percent}%)`;
                                },
                                font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                clip: false,
                                offset: 8
                            }
                        },
                        scales: {
                            x: { display: false, grace: '5%' },
                            y: {
                                grid: { display: false },
                                ticks: {
                                    font: { size: 11, weight: '600', family: 'Sarabun' },
                                    color: '#475569',
                                    padding: 8,
                                    callback: function(value, index) {
                                        const label = this.getLabelForValue(value);
                                        return label.length > 40 ? label.substring(0, 40) + '...' : label;
                                    }
                                }
                            }
                        },
                        animation: { duration: 600 }
                    }
                });
            }, 100);
        }
        
        // Function: drawBar with onClick handler
        function drawBarWithClick(canvasId, containerId, dataObj, onClickCallback) {
            if (activeCharts[canvasId]) {
                activeCharts[canvasId].destroy();
                delete activeCharts[canvasId];
            }
            
            const labels = Object.keys(dataObj);
            const dataVals = Object.values(dataObj);
            const colors = generateColors(labels.length);
            
            const container = document.getElementById(containerId);
            if (container) {
                const dynamicH = Math.max(500, labels.length * 60);
                container.style.height = dynamicH + 'px';
            }
            
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            
            activeCharts[canvasId] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Weight',
                        data: dataVals,
                        backgroundColor: colors,
                        borderRadius: 8,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    layout: { padding: { right: 120, left: 10 } },
                    onClick: (event, elements) => {
                        if (elements.length > 0) {
                            const index = elements[0].index;
                            const customerName = labels[index];
                            if (onClickCallback) onClickCallback(customerName);
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const val = ctx.raw;
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons`;
                                }
                            }
                        },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#334155',
                            formatter: (val) => val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2}) + ' Tons',
                            font: { weight: 'bold', size: 11, family: 'Sarabun' },
                            offset: 8
                        }
                    },
                    scales: {
                        x: { display: false, grace: '5%' },
                        y: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11, weight: '600', family: 'Sarabun' },
                                color: '#475569',
                                padding: 8,
                                callback: function(value, index) {
                                    const label = this.getLabelForValue(value);
                                    return label.length > 25 ? label.substring(0, 25) + '...' : label;
                                }
                            }
                        }
                    },
                    animation: { duration: 600 }
                }
            });
        }
        
        // ============================================
        // MILK RUN LOGIC (Split into Part 1 & 2)
        // ============================================
        function renderMilkRunPart(dataWMS, dataSAP) {
            // --- PART 1: WMS Analysis ---
            const uniqueMilkRun = new Set();
            let totalWeight = 0;
            let totalDO = 0;
            const dateGroups = {};
            
            // ‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å TT-04, TT-05
            const tt04Times = [];
            const tt05Times = [];
            
            // Check Cap analysis
            const checkCapGroups = {};
            const checkCapDetails = {}; // ‡πÄ‡∏Å‡πá‡∏ö details ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö drill-down

            dataWMS.forEach(item => {
                // Debug: ‡πÅ‡∏™‡∏î‡∏á column names ‡∏Ç‡∏≠‡∏á M_WMS
                if (!window.debugMilkRunShown) {
                    console.log('üìã M_WMS columns:', Object.keys(item));
                    console.log('üìã M_WMS sample row:', item);
                    window.debugMilkRunShown = true;
                }
                
                // Cards
                if (item['Milk Run No.']) uniqueMilkRun.add(item['Milk Run No.']);
                if (item.Weight) totalWeight += parseFloat(item.Weight) || 0;
                if (item['DO/Item']) totalDO += parseFloat(item['DO/Item']) || 0;

                // Chart - Completed vs Cancel
                const d = item.Date || 'N/A';
                if (d !== 'N/A') {
                    if (!dateGroups[d]) dateGroups[d] = { completed: 0, cancel: 0 };
                    const compVal = parseFloat(item['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Completed']);
                    const cancVal = parseFloat(item['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Cancel']);
                    if (compVal && compVal !== 0) dateGroups[d].completed++;
                    if (cancVal && cancVal !== 0) dateGroups[d].cancel++;
                }
                
                // ‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å TT-04
                const tt04 = item['TT-04'];
                if (tt04 && tt04 !== '0:00' && tt04 !== '00:00' && tt04 !== '0') {
                    const minutes = parseTimeToMinutes(tt04);
                    if (minutes > 0) tt04Times.push(minutes);
                }
                
                // ‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å TT-05
                const tt05 = item['TT-05'];
                if (tt05 && tt05 !== '0:00' && tt05 !== '00:00' && tt05 !== '0') {
                    const minutes = parseTimeToMinutes(tt05);
                    if (minutes > 0) tt05Times.push(minutes);
                }
                
                // Check Cap
                const checkCap = item['Check Cap'];
                const details = item['Details']; // column ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö Fac (‡πÄ‡∏ä‡πà‡∏ô "Fac.K, Fac.L")
                
                if (checkCap) {
                    // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô string ‡∏Å‡πà‡∏≠‡∏ô (‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô number)
                    const checkCapStr = String(checkCap).trim();
                    if (checkCapStr && checkCapStr !== 'null' && checkCapStr !== 'undefined') {
                        // ‡πÅ‡∏¢‡∏Å‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ comma (‡πÄ‡∏ä‡πà‡∏ô "1, 2")
                        const checkCapValues = checkCapStr.split(',').map(v => v.trim()).filter(v => v);
                        
                        // ‡πÅ‡∏¢‡∏Å Fac ‡∏à‡∏≤‡∏Å Details
                        let facList = [];
                        if (details) {
                            const detailsStr = String(details).trim();
                            if (detailsStr && detailsStr !== 'null' && detailsStr !== 'undefined') {
                                // ‡πÅ‡∏¢‡∏Å Fac (‡πÄ‡∏ä‡πà‡∏ô "Fac.K, Fac.L" ‚Üí ["Fac.K", "Fac.L"])
                                facList = detailsStr.split(',').map(v => v.trim()).filter(v => v);
                            }
                        }
                        
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ Fac ‡πÉ‡∏ô Details ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ "Unknown"
                        if (facList.length === 0) {
                            facList = ['Unknown'];
                        }
                        
                        checkCapValues.forEach(val => {
                            checkCapGroups[val] = (checkCapGroups[val] || 0) + 1;
                            
                            // ‡πÄ‡∏Å‡πá‡∏ö Fac ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Check Cap value
                            if (!checkCapDetails[val]) {
                                checkCapDetails[val] = {};
                            }
                            
                            // ‡πÄ‡∏Å‡πá‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Fac ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô Details
                            facList.forEach(fac => {
                                checkCapDetails[val][fac] = (checkCapDetails[val][fac] || 0) + 1;
                            });
                        });
                    }
                }
            });
            
            // Helper function: ‡πÅ‡∏õ‡∏•‡∏á time string ‡πÄ‡∏õ‡πá‡∏ô‡∏ô‡∏≤‡∏ó‡∏µ
            function parseTimeToMinutes(timeStr) {
                if (!timeStr) return 0;
                const parts = timeStr.toString().split(':');
                if (parts.length >= 2) {
                    const hours = parseInt(parts[0]) || 0;
                    const mins = parseInt(parts[1]) || 0;
                    return hours * 60 + mins;
                }
                return 0;
            }
            
            // Helper function: ‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏≤‡∏ó‡∏µ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô HH:MM
            function minutesToTime(minutes) {
                if (!minutes || minutes === 0) return '--:--';
                const h = Math.floor(minutes / 60);
                const m = minutes % 60;
                return `${h}:${m.toString().padStart(2, '0')}`;
            }
            
            // Update ‡∏´‡∏±‡∏ß‡∏•‡∏≤‡∏Å Cards
            // TT-04
            if (tt04Times.length > 0) {
                const tt04Min = Math.min(...tt04Times);
                const tt04Max = Math.max(...tt04Times);
                const tt04Avg = tt04Times.reduce((a, b) => a + b, 0) / tt04Times.length;
                
                document.getElementById('tt04-count').innerText = tt04Times.length;
                document.getElementById('tt04-min').innerText = minutesToTime(tt04Min);
                document.getElementById('tt04-avg').innerText = minutesToTime(Math.round(tt04Avg));
                document.getElementById('tt04-max').innerText = minutesToTime(tt04Max);
            } else {
                document.getElementById('tt04-count').innerText = '0';
                document.getElementById('tt04-min').innerText = '--:--';
                document.getElementById('tt04-avg').innerText = '--:--';
                document.getElementById('tt04-max').innerText = '--:--';
            }
            
            // TT-05
            if (tt05Times.length > 0) {
                const tt05Min = Math.min(...tt05Times);
                const tt05Max = Math.max(...tt05Times);
                const tt05Avg = tt05Times.reduce((a, b) => a + b, 0) / tt05Times.length;
                
                document.getElementById('tt05-count').innerText = tt05Times.length;
                document.getElementById('tt05-min').innerText = minutesToTime(tt05Min);
                document.getElementById('tt05-avg').innerText = minutesToTime(Math.round(tt05Avg));
                document.getElementById('tt05-max').innerText = minutesToTime(tt05Max);
            } else {
                document.getElementById('tt05-count').innerText = '0';
                document.getElementById('tt05-min').innerText = '--:--';
                document.getElementById('tt05-avg').innerText = '--:--';
                document.getElementById('tt05-max').innerText = '--:--';
            }
            
            // Update WMS Cards
            const mrCountEl = document.getElementById('mr-card-count');
            const mrWeightEl = document.getElementById('mr-card-weight');
            const mrDoEl = document.getElementById('mr-card-do');
            if (mrCountEl) mrCountEl.innerText = uniqueMilkRun.size.toLocaleString();
            if (mrWeightEl) mrWeightEl.innerText = totalWeight.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (mrDoEl) mrDoEl.innerText = totalDO.toLocaleString();

            // Render WMS Chart
            if (activeCharts['chartMilkRunTime']) {
                activeCharts['chartMilkRunTime'].destroy();
                delete activeCharts['chartMilkRunTime'];
            }
            const sortedDates = Object.keys(dateGroups).sort((a,b) => new Date(a) - new Date(b));
            const dataCompleted = sortedDates.map(d => dateGroups[d].completed);
            const dataCancel = sortedDates.map(d => dateGroups[d].cancel);

            const ctx = document.getElementById('chartMilkRunTime');
            if (ctx) {
                activeCharts['chartMilkRunTime'] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: sortedDates,
                        datasets: [
                            { label: 'Completed', data: dataCompleted, borderColor: '#10b981', backgroundColor: '#10b981', tension: 0.3, pointRadius: 4, borderWidth: 3 },
                            { label: 'Cancelled', data: dataCancel, borderColor: '#ef4444', backgroundColor: '#ef4444', tension: 0.3, pointRadius: 4, borderWidth: 3 }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', align: 'end' },
                            datalabels: { display: true, align: 'top', anchor: 'end', backgroundColor: 'rgba(255, 255, 255, 0.7)', borderRadius: 4, color: '#334155', font: { weight: 'bold', size: 11 }, formatter: (val) => val > 0 ? val : '' }
                        },
                        scales: { y: { beginAtZero: true, title: { display: true, text: 'Number of Transactions' } }, x: { grid: { display: false } } }
                    }
                });
            }
            
            // Render ‡∏Å‡∏£‡∏≤‡∏ü‡∏ó‡∏µ‡πà 2: Completed vs Cancelled by Time Value
            if (activeCharts['chartMilkRunByValue']) {
                activeCharts['chartMilkRunByValue'].destroy();
                delete activeCharts['chartMilkRunByValue'];
            }
            
            // Group by ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Completed ‡πÅ‡∏•‡∏∞ Cancel
            const timeValueGroups = {};
            
            dataWMS.forEach(item => {
                const compTime = item['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Completed'];
                const cancTime = item['‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Cancel'];
                
                // Group Completed
                if (compTime && parseFloat(compTime) !== 0) {
                    const timeStr = String(compTime).trim();
                    if (!timeValueGroups[timeStr]) {
                        timeValueGroups[timeStr] = { completed: 0, cancel: 0 };
                    }
                    timeValueGroups[timeStr].completed++;
                }
                
                // Group Cancel
                if (cancTime && parseFloat(cancTime) !== 0) {
                    const timeStr = String(cancTime).trim();
                    if (!timeValueGroups[timeStr]) {
                        timeValueGroups[timeStr] = { completed: 0, cancel: 0 };
                    }
                    timeValueGroups[timeStr].cancel++;
                }
            });
            
            const sortedTimeValues = Object.keys(timeValueGroups).sort();
            const dataCompletedByValue = sortedTimeValues.map(t => timeValueGroups[t].completed);
            const dataCancelByValue = sortedTimeValues.map(t => timeValueGroups[t].cancel);
            
            const ctxByValue = document.getElementById('chartMilkRunByValue');
            if (ctxByValue && sortedTimeValues.length > 0) {
                activeCharts['chartMilkRunByValue'] = new Chart(ctxByValue, {
                    type: 'line',
                    data: {
                        labels: sortedTimeValues,
                        datasets: [
                            { 
                                label: 'Completed', 
                                data: dataCompletedByValue, 
                                borderColor: '#10b981',
                                backgroundColor: '#10b981',
                                tension: 0.3,
                                pointRadius: 4,
                                borderWidth: 3
                            },
                            { 
                                label: 'Cancelled', 
                                data: dataCancelByValue, 
                                borderColor: '#ef4444',
                                backgroundColor: '#ef4444',
                                tension: 0.3,
                                pointRadius: 4,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', align: 'end' },
                            datalabels: { 
                                display: true, 
                                align: 'top', 
                                anchor: 'end', 
                                backgroundColor: 'rgba(255, 255, 255, 0.7)', 
                                borderRadius: 4, 
                                color: '#334155', 
                                font: { weight: 'bold', size: 11 }, 
                                formatter: (val) => val > 0 ? val : '' 
                            }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true, 
                                title: { display: true, text: 'Count' }
                            }, 
                            x: { 
                                grid: { display: false },
                                title: { display: true, text: 'Time Value' },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 10 }
                                }
                            } 
                        }
                    }
                });
            }
            
            // Render ‡∏Å‡∏£‡∏≤‡∏ü‡πÉ‡∏´‡∏°‡πà: Weight & DO/Item by ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å
            if (activeCharts['chartWeightDOByDepositor']) {
                activeCharts['chartWeightDOByDepositor'].destroy();
                delete activeCharts['chartWeightDOByDepositor'];
            }
            
            // Group by ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å
            const depositorGroups = {};
            
            dataWMS.forEach(item => {
                const depositor = item['‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å'] || 'Unknown';
                const completed = item['Completed'];
                const cancel = item['Cancel'];
                const weight = parseFloat(item['Weight']) || 0;
                const doItem = parseFloat(item['DO/Item']) || 0;
                
                if (!depositorGroups[depositor]) {
                    depositorGroups[depositor] = { 
                        completedWeight: 0, 
                        completedDO: 0,
                        cancelledWeight: 0,
                        cancelledDO: 0
                    };
                }
                
                // ‡πÅ‡∏¢‡∏Å‡∏ô‡∏±‡∏ö Completed ‡πÅ‡∏•‡∏∞ Cancelled
                if (completed == 1) {
                    depositorGroups[depositor].completedWeight += weight;
                    depositorGroups[depositor].completedDO += doItem;
                }
                
                if (cancel == 1) {
                    depositorGroups[depositor].cancelledWeight += weight;
                    depositorGroups[depositor].cancelledDO += doItem;
                }
            });
            
            const sortedDepositors = Object.keys(depositorGroups).sort();
            const completedWeights = sortedDepositors.map(d => depositorGroups[d].completedWeight);
            const cancelledWeights = sortedDepositors.map(d => depositorGroups[d].cancelledWeight);
            const completedDOs = sortedDepositors.map(d => depositorGroups[d].completedDO);
            const cancelledDOs = sortedDepositors.map(d => depositorGroups[d].cancelledDO);
            
            const ctxDepositor = document.getElementById('chartWeightDOByDepositor');
            if (ctxDepositor && sortedDepositors.length > 0) {
                activeCharts['chartWeightDOByDepositor'] = new Chart(ctxDepositor, {
                    type: 'bar',
                    data: {
                        labels: sortedDepositors,
                        datasets: [
                            { 
                                label: 'Completed Weight', 
                                data: completedWeights, 
                                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                                borderColor: '#10b981',
                                borderWidth: 2,
                                borderRadius: 6,
                                yAxisID: 'y'
                            },
                            { 
                                label: 'Cancelled Weight', 
                                data: cancelledWeights, 
                                backgroundColor: 'rgba(239, 68, 68, 0.7)',
                                borderColor: '#ef4444',
                                borderWidth: 2,
                                borderRadius: 6,
                                yAxisID: 'y'
                            },
                            { 
                                label: 'Completed DO/Item', 
                                data: completedDOs, 
                                type: 'line',
                                borderColor: '#3b82f6',
                                backgroundColor: '#3b82f6',
                                tension: 0.3,
                                pointRadius: 5,
                                borderWidth: 3,
                                yAxisID: 'y1'
                            },
                            { 
                                label: 'Cancelled DO/Item', 
                                data: cancelledDOs, 
                                type: 'line',
                                borderColor: '#f59e0b',
                                backgroundColor: '#f59e0b',
                                tension: 0.3,
                                pointRadius: 5,
                                borderWidth: 3,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        maintainAspectRatio: false,
                        responsive: true,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', align: 'end' },
                            datalabels: { 
                                display: true, 
                                align: 'top', 
                                anchor: 'end', 
                                backgroundColor: 'rgba(255, 255, 255, 0.7)', 
                                borderRadius: 4, 
                                color: '#334155', 
                                font: { weight: 'bold', size: 9 }, 
                                formatter: (val) => val > 0 ? val.toLocaleString(undefined, {maximumFractionDigits: 0}) : '' 
                            }
                        },
                        scales: { 
                            y: { 
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true, 
                                title: { display: true, text: 'Weight' },
                                stacked: false
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: { display: true, text: 'DO/Item' },
                                grid: { drawOnChartArea: false }
                            },
                            x: { 
                                grid: { display: false },
                                title: { display: true, text: '‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å' },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45,
                                    font: { size: 10 }
                                }
                            } 
                        }
                    }
                });
            }
            
            // Render ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å Analysis Chart (‡∏Ñ‡∏•‡πâ‡∏≤‡∏¢ Check Cap)
            if (activeCharts['chartDepositor']) {
                activeCharts['chartDepositor'].destroy();
                delete activeCharts['chartDepositor'];
            }
            
            // Group by ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö Fac details
            const depositorCountGroups = {};
            const depositorFacDetails = {};
            
            dataWMS.forEach(item => {
                const depositor = item['‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å'];
                const details = item['Details']; // Fac list
                
                if (depositor) {
                    const depositorStr = String(depositor).trim();
                    if (depositorStr && depositorStr !== 'null' && depositorStr !== 'undefined') {
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        depositorCountGroups[depositorStr] = (depositorCountGroups[depositorStr] || 0) + 1;
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö Fac details
                        if (!depositorFacDetails[depositorStr]) {
                            depositorFacDetails[depositorStr] = {};
                        }
                        
                        // ‡πÅ‡∏¢‡∏Å Fac ‡∏à‡∏≤‡∏Å Details
                        if (details) {
                            const detailsStr = String(details).trim();
                            if (detailsStr && detailsStr !== 'null' && detailsStr !== 'undefined') {
                                const facList = detailsStr.split(',').map(v => v.trim()).filter(v => v);
                                facList.forEach(fac => {
                                    depositorFacDetails[depositorStr][fac] = (depositorFacDetails[depositorStr][fac] || 0) + 1;
                                });
                            }
                        }
                    }
                }
            });
            
            const totalDepositor = Object.values(depositorCountGroups).reduce((a, b) => a + b, 0);
            if (totalDepositor > 0) {
                const sortedDepositors = Object.entries(depositorCountGroups).sort((a, b) => b[1] - a[1]);
                const depositorLabels = sortedDepositors.map(e => e[0]);
                const depositorCounts = sortedDepositors.map(e => e[1]);
                const depositorColors = generateColors(depositorLabels.length);
                
                const containerDepositor = document.getElementById('container-Depositor');
                if (containerDepositor) {
                    const dynamicH = Math.max(400, depositorLabels.length * 50);
                    containerDepositor.style.height = dynamicH + 'px';
                }
                
                const canvasDepositor = document.getElementById('chartDepositor');
                if (canvasDepositor) {
                    activeCharts['chartDepositor'] = new Chart(canvasDepositor, {
                        type: 'bar',
                        data: {
                            labels: depositorLabels,
                            datasets: [{
                                label: 'Count',
                                data: depositorCounts,
                                backgroundColor: depositorColors,
                                borderRadius: 8,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            layout: { padding: { right: 100, left: 10 } },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const depositorValue = depositorLabels[index];
                                    showDepositorDetails(depositorValue, depositorFacDetails[depositorValue], totalDepositor);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const count = ctx.raw;
                                            const percent = ((count / totalDepositor) * 100).toFixed(1);
                                            return `${ctx.label}: ${count} (${percent}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#334155',
                                    formatter: (val) => {
                                        const percent = ((val / totalDepositor) * 100).toFixed(1);
                                        return `${val} (${percent}%)`;
                                    },
                                    font: { weight: 'bold', size: 9, family: 'Sarabun' },
                                    offset: 4,
                                    clip: false
                                }
                            },
                            scales: {
                                x: { display: false, grace: '5%' },
                                y: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 10, weight: '600', family: 'Sarabun' },
                                        color: '#475569',
                                        padding: 6
                                    }
                                }
                            },
                            animation: { duration: 600 }
                        }
                    });
                }
            }
            
            // Render ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö Analysis Chart (Fac ‚Üí ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å)
            if (activeCharts['chartReceiver']) {
                activeCharts['chartReceiver'].destroy();
                delete activeCharts['chartReceiver'];
            }
            
            // Group by Fac (Details) ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å ‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å‡πÑ‡∏ß‡πâ
            const facCountGroups = {};
            const facDepositorDetails = {};
            
            dataWMS.forEach(item => {
                const depositor = item['‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å'];
                const details = item['Details']; // Fac list
                
                if (details) {
                    const detailsStr = String(details).trim();
                    if (detailsStr && detailsStr !== 'null' && detailsStr !== 'undefined') {
                        // ‡πÅ‡∏¢‡∏Å Fac
                        const facList = detailsStr.split(',').map(v => v.trim()).filter(v => v);
                        
                        facList.forEach(fac => {
                            // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                            facCountGroups[fac] = (facCountGroups[fac] || 0) + 1;
                            
                            // ‡πÄ‡∏Å‡πá‡∏ö ‡∏ú‡∏π‡πâ‡∏ù‡∏≤‡∏Å ‡∏ó‡∏µ‡πà‡∏ù‡∏≤‡∏Å‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà Fac ‡∏ô‡∏µ‡πâ
                            if (!facDepositorDetails[fac]) {
                                facDepositorDetails[fac] = {};
                            }
                            
                            if (depositor) {
                                const depositorStr = String(depositor).trim();
                                if (depositorStr && depositorStr !== 'null' && depositorStr !== 'undefined') {
                                    facDepositorDetails[fac][depositorStr] = (facDepositorDetails[fac][depositorStr] || 0) + 1;
                                }
                            }
                        });
                    }
                }
            });
            
            const totalReceiver = Object.values(facCountGroups).reduce((a, b) => a + b, 0);
            if (totalReceiver > 0) {
                const sortedFacs = Object.entries(facCountGroups).sort((a, b) => b[1] - a[1]);
                const facLabels = sortedFacs.map(e => e[0]);
                const facCounts = sortedFacs.map(e => e[1]);
                const facColors = generateColors(facLabels.length);
                
                const containerReceiver = document.getElementById('container-Receiver');
                if (containerReceiver) {
                    const dynamicH = Math.max(400, facLabels.length * 50);
                    containerReceiver.style.height = dynamicH + 'px';
                }
                
                const canvasReceiver = document.getElementById('chartReceiver');
                if (canvasReceiver) {
                    activeCharts['chartReceiver'] = new Chart(canvasReceiver, {
                        type: 'bar',
                        data: {
                            labels: facLabels,
                            datasets: [{
                                label: 'Count',
                                data: facCounts,
                                backgroundColor: facColors,
                                borderRadius: 8,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            layout: { padding: { right: 100, left: 10 } },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const facValue = facLabels[index];
                                    showReceiverDetails(facValue, facDepositorDetails[facValue], totalReceiver);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const count = ctx.raw;
                                            const percent = ((count / totalReceiver) * 100).toFixed(1);
                                            return `${ctx.label}: ${count} (${percent}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#334155',
                                    formatter: (val) => {
                                        const percent = ((val / totalReceiver) * 100).toFixed(1);
                                        return `${val} (${percent}%)`;
                                    },
                                    font: { weight: 'bold', size: 9, family: 'Sarabun' },
                                    offset: 4,
                                    clip: false
                                }
                            },
                            scales: {
                                x: { display: false, grace: '5%' },
                                y: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 10, weight: '600', family: 'Sarabun' },
                                        color: '#475569',
                                        padding: 6
                                    }
                                }
                            },
                            animation: { duration: 600 }
                        }
                    });
                }
            }
            
            // Render Check Cap Chart
            if (activeCharts['chartCheckCap']) {
                activeCharts['chartCheckCap'].destroy();
                delete activeCharts['chartCheckCap'];
            }
            
            const totalCheckCap = Object.values(checkCapGroups).reduce((a, b) => a + b, 0);
            if (totalCheckCap > 0) {
                const sortedCheckCap = Object.entries(checkCapGroups).sort((a, b) => b[1] - a[1]);
                const checkCapLabels = sortedCheckCap.map(e => e[0]);
                const checkCapCounts = sortedCheckCap.map(e => e[1]);
                const checkCapColors = generateColors(checkCapLabels.length);
                
                const container = document.getElementById('container-CheckCap');
                if (container) {
                    const dynamicH = Math.max(400, checkCapLabels.length * 50);
                    container.style.height = dynamicH + 'px';
                }
                
                const canvasCheckCap = document.getElementById('chartCheckCap');
                if (canvasCheckCap) {
                    activeCharts['chartCheckCap'] = new Chart(canvasCheckCap, {
                        type: 'bar',
                        data: {
                            labels: checkCapLabels,
                            datasets: [{
                                label: 'Count',
                                data: checkCapCounts,
                                backgroundColor: checkCapColors,
                                borderRadius: 8,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            layout: { padding: { right: 120, left: 10 } },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const checkCapValue = checkCapLabels[index];
                                    showCheckCapDetails(checkCapValue, checkCapDetails[checkCapValue], totalCheckCap);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const count = ctx.raw;
                                            const percent = ((count / totalCheckCap) * 100).toFixed(1);
                                            return `${ctx.label}: ${count} (${percent}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#334155',
                                    formatter: (val) => {
                                        const percent = ((val / totalCheckCap) * 100).toFixed(1);
                                        return `${val} (${percent}%)`;
                                    },
                                    font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                    offset: 8
                                }
                            },
                            scales: {
                                x: { display: false, grace: '5%' },
                                y: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 11, weight: '600', family: 'Sarabun' },
                                        color: '#475569',
                                        padding: 8
                                    }
                                }
                            },
                            animation: { duration: 600 }
                        }
                    });
                }
            }

            // --- PART 2: SAP Analysis ---
            
            // Render Sloc Analysis Chart
            if (activeCharts['chartSloc']) {
                activeCharts['chartSloc'].destroy();
                delete activeCharts['chartSloc'];
            }
            
            // Group by Sloc ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö Fac details
            const slocCountGroups = {};
            const slocFacDetails = {};
            
            dataSAP.forEach(item => {
                const sloc = item['Sloc.'];
                const details = item['Details']; // Fac list
                
                if (sloc) {
                    const slocStr = String(sloc).trim();
                    if (slocStr && slocStr !== 'null' && slocStr !== 'undefined') {
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        slocCountGroups[slocStr] = (slocCountGroups[slocStr] || 0) + 1;
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö Fac details
                        if (!slocFacDetails[slocStr]) {
                            slocFacDetails[slocStr] = {};
                        }
                        
                        // ‡πÅ‡∏¢‡∏Å Fac ‡∏à‡∏≤‡∏Å Details
                        if (details) {
                            const detailsStr = String(details).trim();
                            if (detailsStr && detailsStr !== 'null' && detailsStr !== 'undefined') {
                                const facList = detailsStr.split(',').map(v => v.trim()).filter(v => v);
                                facList.forEach(fac => {
                                    slocFacDetails[slocStr][fac] = (slocFacDetails[slocStr][fac] || 0) + 1;
                                });
                            }
                        }
                    }
                }
            });
            
            const totalSloc = Object.values(slocCountGroups).reduce((a, b) => a + b, 0);
            if (totalSloc > 0) {
                const sortedSlocs = Object.entries(slocCountGroups).sort((a, b) => b[1] - a[1]);
                const slocLabels = sortedSlocs.map(e => e[0]);
                const slocCounts = sortedSlocs.map(e => e[1]);
                const slocColors = generateColors(slocLabels.length);
                
                const containerSloc = document.getElementById('container-Sloc');
                if (containerSloc) {
                    const dynamicH = Math.max(400, slocLabels.length * 50);
                    containerSloc.style.height = dynamicH + 'px';
                }
                
                const canvasSloc = document.getElementById('chartSloc');
                if (canvasSloc) {
                    activeCharts['chartSloc'] = new Chart(canvasSloc, {
                        type: 'bar',
                        data: {
                            labels: slocLabels,
                            datasets: [{
                                label: 'Count',
                                data: slocCounts,
                                backgroundColor: slocColors,
                                borderRadius: 8,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            layout: { padding: { right: 120, left: 10 } },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const slocValue = slocLabels[index];
                                    showSlocDetails(slocValue, slocFacDetails[slocValue], totalSloc);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const count = ctx.raw;
                                            const percent = ((count / totalSloc) * 100).toFixed(1);
                                            return `${ctx.label}: ${count} (${percent}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#334155',
                                    formatter: (val) => {
                                        const percent = ((val / totalSloc) * 100).toFixed(1);
                                        return `${val} (${percent}%)`;
                                    },
                                    font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                    offset: 8
                                }
                            },
                            scales: {
                                x: { display: false, grace: '5%' },
                                y: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 11, weight: '600', family: 'Sarabun' },
                                        color: '#475569',
                                        padding: 8
                                    }
                                }
                            },
                            animation: { duration: 600 }
                        }
                    });
                }
            }
            
            // Render Customer Analysis Chart
            if (activeCharts['chartCustomer']) {
                activeCharts['chartCustomer'].destroy();
                delete activeCharts['chartCustomer'];
            }
            
            // Group by Sloc ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö Customer details (for Customer Analysis chart)
            const slocCustomerCountGroups = {};
            const slocCustomerDetails = {};
            
            console.log('üîç DEBUG Customer Analysis - dataSAP length:', dataSAP.length);
            console.log('üîç DEBUG Sample item:', dataSAP[0]);
            
            dataSAP.forEach(item => {
                const sloc = item['Sloc.'];
                const customer = item['Customer'];
                
                if (sloc) {
                    const slocStr = String(sloc).trim();
                    if (slocStr && slocStr !== 'null' && slocStr !== 'undefined') {
                        // ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                        slocCustomerCountGroups[slocStr] = (slocCustomerCountGroups[slocStr] || 0) + 1;
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö Customer details
                        if (!slocCustomerDetails[slocStr]) {
                            slocCustomerDetails[slocStr] = {};
                        }
                        
                        if (customer) {
                            const customerStr = String(customer).trim();
                            if (customerStr && customerStr !== 'null' && customerStr !== 'undefined') {
                                slocCustomerDetails[slocStr][customerStr] = (slocCustomerDetails[slocStr][customerStr] || 0) + 1;
                            }
                        }
                    }
                }
            });
            
            console.log('üîç DEBUG slocCustomerCountGroups:', slocCustomerCountGroups);
            console.log('üîç DEBUG Total slocs:', Object.keys(slocCustomerCountGroups).length);
            
            const totalSlocs = Object.values(slocCustomerCountGroups).reduce((a, b) => a + b, 0);
            console.log('üîç DEBUG Total Slocs:', totalSlocs);
            
            if (totalSlocs > 0) {
                const sortedSlocs = Object.entries(slocCustomerCountGroups).sort((a, b) => b[1] - a[1]);
                
                // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà Top 20 slocs
                const topSlocs = sortedSlocs.slice(0, 20);
                const slocLabels = topSlocs.map(e => e[0]);
                const slocCounts = topSlocs.map(e => e[1]);
                const slocColors = generateColors(slocLabels.length);
                
                console.log('üîç DEBUG Sloc Labels:', slocLabels.length, 'slocs (Top 20 from', sortedSlocs.length, 'total)');
                console.log('üîç DEBUG Sloc Counts:', slocCounts);
                
                const containerCustomer = document.getElementById('container-Customer');
                console.log('üîç DEBUG Container found:', !!containerCustomer);
                
                if (containerCustomer) {
                    // ‡∏à‡∏≥‡∏Å‡∏±‡∏î height ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà 1500px
                    const dynamicH = Math.min(1500, Math.max(400, slocLabels.length * 50));
                    containerCustomer.style.height = dynamicH + 'px';
                    console.log('üîç DEBUG Container height set:', dynamicH);
                }
                
                const canvasCustomer = document.getElementById('chartCustomer');
                console.log('üîç DEBUG Canvas found:', !!canvasCustomer);
                
                if (canvasCustomer) {
                    console.log('üîç DEBUG Creating Customer chart...');
                    activeCharts['chartCustomer'] = new Chart(canvasCustomer, {
                        type: 'bar',
                        data: {
                            labels: slocLabels,
                            datasets: [{
                                label: 'Count',
                                data: slocCounts,
                                backgroundColor: slocColors,
                                borderRadius: 8,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            maintainAspectRatio: false,
                            indexAxis: 'y',
                            layout: { padding: { right: 120, left: 10 } },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const slocValue = slocLabels[index];
                                    showSlocCustomerDetails(slocValue, slocCustomerDetails[slocValue], totalSlocs);
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    callbacks: {
                                        label: (ctx) => {
                                            const count = ctx.raw;
                                            const percent = ((count / totalSlocs) * 100).toFixed(1);
                                            return `${ctx.label}: ${count} (${percent}%)`;
                                        }
                                    }
                                },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'end',
                                    color: '#334155',
                                    formatter: (val) => {
                                        const percent = ((val / totalSlocs) * 100).toFixed(1);
                                        return `${val} (${percent}%)`;
                                    },
                                    font: { weight: 'bold', size: 11, family: 'Sarabun' },
                                    offset: 8
                                }
                            },
                            scales: {
                                x: { display: false, grace: '5%' },
                                y: {
                                    grid: { display: false },
                                    ticks: {
                                        font: { size: 11, weight: '600', family: 'Sarabun' },
                                        color: '#475569',
                                        padding: 8
                                    }
                                }
                            },
                            animation: { duration: 600 }
                        }
                    });
                    console.log('‚úÖ SUCCESS: Customer chart created!');
                }
            } else {
                console.warn('‚ö†Ô∏è WARNING: No sloc data to display (totalSlocs = 0)');
            }
            
            // SAP Cards (Check Milk Run status)
            const sapGroups = {};
            let totalSAPShipments = 0;

            // Iterate through filtered SAP data
            dataSAP.forEach(item => {
                const status = item['Check Milk Run'] || 'Unknown';
                // Using 'Shipment' as unique identifier per shipment if needed, 
                // but requirement implies counting rows or grouping by shipment.
                // Assuming counting rows/records as shipments for now based on context.
                if (!sapGroups[status]) sapGroups[status] = 0;
                sapGroups[status]++;
                totalSAPShipments++;
            });

            // Render SAP Cards
            const sapContainer = document.getElementById('sap-analysis-container');
            if (sapContainer) {
                if (totalSAPShipments === 0) {
                    sapContainer.innerHTML = `<div class="p-10 text-center text-slate-400 italic">No SAP data available for current filters.</div>`;
                } else {
                    // Enhanced card design with better proportions
                    let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-8">';
                    
                    Object.keys(sapGroups).sort().forEach(status => {
                        const count = sapGroups[status];
                        const percent = ((count / totalSAPShipments) * 100).toFixed(1);
                        
                        // Dynamic styling based on status content
                        let gradientClass, textClass, barClass, badgeClass;
                        const sLower = status.toLowerCase();
                        
                        if (sLower.includes('milk run') || sLower.includes('yes')) {
                            gradientClass = "from-pink-50 via-white to-rose-50";
                            textClass = "text-pink-600";
                            barClass = "bg-gradient-to-r from-pink-500 to-rose-500";
                            badgeClass = "bg-pink-500";
                        } else if (sLower.includes('‡∏Ç‡∏∂‡πâ‡∏ô‡πÄ‡∏≠‡∏á')) {
                            gradientClass = "from-indigo-50 via-white to-blue-50";
                            textClass = "text-indigo-600";
                            barClass = "bg-gradient-to-r from-indigo-500 to-blue-500";
                            badgeClass = "bg-indigo-500";
                        } else {
                            gradientClass = "from-slate-50 via-white to-gray-50";
                            textClass = "text-slate-600";
                            barClass = "bg-gradient-to-r from-slate-400 to-gray-400";
                            badgeClass = "bg-slate-400";
                        }

                        html += `
                        <div class="relative bg-gradient-to-br ${gradientClass} border-2 border-slate-100 rounded-[2.5rem] p-10 shadow-lg hover:shadow-xl transition-all duration-300 hover:-translate-y-1 overflow-hidden group">
                            <!-- Background Pattern -->
                            <div class="absolute top-0 right-0 opacity-5 ${textClass}">
                                <svg class="w-40 h-40" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M4 3a2 2 0 100 4h12a2 2 0 100-4H4z"/>
                                    <path fill-rule="evenodd" d="M3 8h14v7a2 2 0 01-2 2H5a2 2 0 01-2-2V8zm5 3a1 1 0 011-1h2a1 1 0 110 2H9a1 1 0 01-1-1z" clip-rule="evenodd"/>
                                </svg>
                            </div>
                            
                            <!-- Header -->
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-2">STATUS</div>
                                    <div class="text-2xl font-black ${textClass} leading-tight">${status}</div>
                                </div>
                                <div class="bg-white/80 backdrop-blur-sm rounded-2xl px-4 py-2 shadow-lg border border-slate-200">
                                    <div class="text-3xl font-black ${textClass}">${percent}%</div>
                                </div>
                            </div>
                            
                            <!-- Main Count -->
                            <div class="mb-6">
                                <div class="flex items-baseline space-x-3">
                                    <div class="text-6xl font-black text-slate-800">${count.toLocaleString()}</div>
                                    <div class="text-lg font-bold text-slate-400">Shipments</div>
                                </div>
                            </div>
                        </div>
                        `;
                    });
                    
                    html += '</div>';
                    sapContainer.innerHTML = html;
                }
            }
        }

        // ============================================
        // UPDATED: LOADING TIME CHART LOGIC
        // ============================================
        function renderLoadingChart(data) {
            if (activeCharts['chartLoadingTime']) {
                activeCharts['chartLoadingTime'].destroy();
                delete activeCharts['chartLoadingTime'];
            }

            const dailyGroup = {};
            let totalW = 0;
            let peakDailyWeight = 0;
            let maxOverallTime = 0;
            let sumOfMaxTimes = 0;
            let daysWithTime = 0;

            // 1. Process Daily Data First (Common)
            data.forEach(item => {
                const date = item.Date || 'N/A';
                if (date === 'N/A') return;
                const month = item.Month || 'Unknown';
                const factory = item.Factory || 'Unknown';
                const w = parseFloat(item.Weight_Out) || 0;
                totalW += w;

                let timeDec = 0;
                if (item['Time Out']) {
                    const parts = item['Time Out'].split(':');
                    if (parts.length >= 2) timeDec = parseInt(parts[0]) + parseInt(parts[1])/60;
                }

                if (!dailyGroup[date]) {
                    dailyGroup[date] = { 
                        weight: 0, 
                        maxTime: 0, 
                        month: month, 
                        factories: new Set(), // ‡πÄ‡∏Å‡πá‡∏ö Factory ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
                        shipments: new Set() 
                    };
                }
                dailyGroup[date].weight += w;
                dailyGroup[date].factories.add(factory); // ‡πÄ‡∏û‡∏¥‡πà‡∏° Factory
                if (timeDec > dailyGroup[date].maxTime) dailyGroup[date].maxTime = timeDec;
            });
            
            // 2. ‡∏ô‡∏±‡∏ö Shipment ‡∏à‡∏≤‡∏Å masterDataOriginal (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å filter)
            console.log('üîç Counting Shipments from FG In-Out (Original Data)...');
            console.log('üìä Using masterDataOriginal:', masterDataOriginal.length, 'rows');
            
            // Debug: ‡∏´‡∏≤ Date field ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            if (masterDataOriginal.length > 0) {
                console.log('üìã masterDataOriginal[0] keys:', Object.keys(masterDataOriginal[0]));
                console.log('üìã Sample row:', {
                    Date: masterDataOriginal[0].Date,
                    'Sloc.': masterDataOriginal[0]['Sloc.'],
                    Shipment: masterDataOriginal[0].Shipment,
                    Month: masterDataOriginal[0].Month
                });
                
                // ‡∏´‡∏≤ field ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ date (‡πÑ‡∏°‡πà‡∏™‡∏ô‡πÉ‡∏à‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå)
                const dateFields = Object.keys(masterDataOriginal[0]).filter(key => 
                    key.toLowerCase().includes('date') || 
                    key.includes('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') ||
                    key === 'Date'
                );
                console.log('üìÖ Possible Date fields:', dateFields);
            }
            
            // Helper function: ‡∏´‡∏≤ Date field ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            const getDateField = (item) => {
                // ‡∏•‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢ field names ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ
                const possibleFields = ['Date', 'date', 'DATE', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', 'Delivery Date', 'Ship Date'];
                for (const field of possibleFields) {
                    if (item[field] !== undefined && item[field] !== null) {
                        return item[field];
                    }
                }
                return null;
            };
            
            // Helper function: ‡πÅ‡∏õ‡∏•‡∏á Date ‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD
            const normalizeDate = (dateStr) => {
                if (!dateStr) return null;
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô YYYY-MM-DD ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    return dateStr;
                }
                
                // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô DD/MM/YYYY
                if (/^\d{2}\/\d{2}\/\d{4}$/.test(dateStr)) {
                    const [day, month, year] = dateStr.split('/');
                    return `${year}-${month}-${day}`;
                }
                
                // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Date parse
                try {
                    const d = new Date(dateStr);
                    if (isNaN(d.getTime())) return null;
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                } catch (e) {
                    return null;
                }
            };
            
            Object.keys(dailyGroup).forEach(date => {
                const factories = dailyGroup[date].factories;
                const normalizedDate = normalizeDate(date);
                
                console.log(`  Date: ${date}, Factories:`, Array.from(factories));
                
                // ‡∏ô‡∏±‡∏ö Shipment ‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Date + Sloc (Factory)
                let shipmentCount = 0;
                let checkedRows = 0;
                let nullDateCount = 0;
                let matchedCount = 0;
                
                masterDataOriginal.forEach((masterItem, idx) => {
                    // Debug: ‡πÅ‡∏™‡∏î‡∏á sample 3 rows ‡πÅ‡∏£‡∏Å
                    if (idx < 3) {
                        const dateValue = getDateField(masterItem);
                        console.log(`    [Row ${idx}] Date field value: "${dateValue}", Sloc: ${masterItem['Sloc.']}, Shipment: ${masterItem.Shipment}`);
                    }
                    
                    const masterDateValue = getDateField(masterItem);
                    const masterDate = normalizeDate(masterDateValue);
                    
                    // ‡∏ô‡∏±‡∏ö null dates
                    if (!masterDateValue) {
                        if (nullDateCount === 0) console.log(`    ‚ö†Ô∏è First null date at row`, idx);
                        nullDateCount++;
                    }
                    
                    // ‡πÄ‡∏ä‡πá‡∏Ñ: Date ‡∏ï‡∏£‡∏á ‡πÅ‡∏•‡∏∞ Sloc. ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô factories ‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏±‡πâ‡∏ô
                    if (masterDate && 
                        masterDate === normalizedDate && 
                        masterItem['Sloc.'] &&
                        factories.has(masterItem['Sloc.']) && 
                        masterItem.Shipment) {
                        dailyGroup[date].shipments.add(masterItem.Shipment);
                        shipmentCount++;
                        matchedCount++;
                        
                        // Debug: ‡πÅ‡∏™‡∏î‡∏á match ‡πÅ‡∏£‡∏Å
                        if (matchedCount === 1) {
                            console.log(`    ‚úÖ First match: Date=${masterDate}, Sloc=${masterItem['Sloc.']}, Shipment=${masterItem.Shipment}`);
                        }
                    }
                });
                
                console.log(`    ‚Üí Found ${dailyGroup[date].shipments.size} unique shipments (${shipmentCount} total rows)`);
                if (nullDateCount > 0) console.log(`    ‚ö†Ô∏è ${nullDateCount} rows with null/missing Date field`);
            });
            
            console.log('üìä Daily Group with Shipment Count:', dailyGroup);

            // Calculate Metrics
            Object.values(dailyGroup).forEach(val => {
                if (val.weight > peakDailyWeight) peakDailyWeight = val.weight;
                if (val.maxTime > maxOverallTime) maxOverallTime = val.maxTime;
                if (val.maxTime > 0) {
                    sumOfMaxTimes += val.maxTime;
                    daysWithTime++;
                }
            });

            // Prepare Chart Data based on View Mode
            let labels = [];
            let dataWeight = [];
            let dataTime = [];
            let dataShipments = []; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Shipment

            if (loadingViewMode === 'daily') {
                // DAILY MODE
                labels = Object.keys(dailyGroup).sort((a,b) => new Date(a) - new Date(b));
                dataWeight = labels.map(d => dailyGroup[d].weight);
                dataTime = labels.map(d => dailyGroup[d].maxTime);
                dataShipments = labels.map(d => dailyGroup[d].shipments.size); // ‡∏ô‡∏±‡∏ö Shipment ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
            } else {
                // MONTHLY MODE (Aggregated)
                const monthlyGroup = {};
                
                Object.keys(dailyGroup).forEach(date => {
                    const m = dailyGroup[date].month;
                    if (!monthlyGroup[m]) {
                        monthlyGroup[m] = { totalWeight: 0, maxTimes: [], allShipments: new Set() };
                    }
                    monthlyGroup[m].totalWeight += dailyGroup[date].weight;
                    if (dailyGroup[date].maxTime > 0) {
                        monthlyGroup[m].maxTimes.push(dailyGroup[date].maxTime);
                    }
                    // ‡∏£‡∏ß‡∏° Shipment ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    dailyGroup[date].shipments.forEach(ship => monthlyGroup[m].allShipments.add(ship));
                });

                labels = Object.keys(monthlyGroup).sort(); // Sort months roughly
                dataWeight = labels.map(m => monthlyGroup[m].totalWeight);
                dataTime = labels.map(m => {
                    const times = monthlyGroup[m].maxTimes;
                    if (times.length === 0) return 0;
                    const sum = times.reduce((a,b) => a+b, 0);
                    return sum / times.length; // Average of Max Times
                });
                dataShipments = labels.map(m => monthlyGroup[m].allShipments.size); // ‡∏£‡∏ß‡∏° Shipment ‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥
            }

            // Helpers
            const decToTime = (val) => {
                const h = Math.floor(val);
                const m = Math.round((val - h) * 60);
                return `${h}:${m < 10 ? '0'+m : m}`;
            };

            // Update Cards
            document.getElementById('loading-total-weight').innerText = totalW.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('loading-peak-weight').innerText = peakDailyWeight.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('loading-max-time').innerText = maxOverallTime > 0 ? decToTime(maxOverallTime) : "--:--";
            
            const avgTime = daysWithTime > 0 ? sumOfMaxTimes / daysWithTime : 0;
            document.getElementById('loading-avg-time').innerText = avgTime > 0 ? decToTime(avgTime) : "--:--";

            // Render Chart
            const ctxContainer = document.getElementById('loading-chart-container');
            const canvas = document.getElementById('chartLoadingTime');
            
            if (!ctxContainer || !canvas) return;
            const minWidth = Math.max(100, labels.length * 60); 
            ctxContainer.style.width = `${minWidth}px`; 

            const targetLine = new Array(labels.length).fill(20.5);

            activeCharts['chartLoadingTime'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            type: 'line',
                            label: loadingViewMode === 'daily' ? 'Max Time' : 'Avg Max Time',
                            data: dataTime,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'yTime',
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            pointBackgroundColor: (ctx) => ctx.raw > 20.5 ? '#ef4444' : '#3b82f6',
                            segment: {
                                borderColor: ctx => {
                                    if (ctx.p0.parsed.y > 20.5 || ctx.p1.parsed.y > 20.5) return '#ef4444'; 
                                    return '#3b82f6';
                                }
                            }
                        },
                        {
                            type: 'line',
                            label: 'Target (20:30)',
                            data: targetLine,
                            borderColor: '#ef4444',
                            borderWidth: 2,
                            borderDash: [5, 5],
                            pointRadius: 0,
                            yAxisID: 'yTime',
                            fill: false,
                            datalabels: { display: false }
                        },
                        {
                            type: 'bar',
                            label: 'Weight',
                            data: dataWeight,
                            backgroundColor: '#10b981',
                            borderRadius: 6,
                            yAxisID: 'yWeight',
                            barPercentage: 0.6
                        }
                    ]
                },
                options: {
                    maintainAspectRatio: false,
                    responsive: true,
                    layout: { padding: { top: 30, right: 20, left: 10, bottom: 0 } },
                    scales: {
                        x: { grid: { display: false }, ticks: { font: { size: 11, family: 'Sarabun' }, maxRotation: 45, minRotation: 45 } },
                        yWeight: { type: 'linear', display: true, position: 'left', title: { display: true, text: 'Weight (Tons)', color: '#10b981' }, grid: { display: false } },
                        yTime: { type: 'linear', display: true, position: 'right', title: { display: true, text: 'Time', color: '#3b82f6' }, min: 0, max: 24, ticks: { callback: (val) => decToTime(val), stepSize: 2 } }
                    },
                    plugins: {
                        datalabels: {
                            color: '#334155', // Dark text color for readability
                            backgroundColor: 'rgba(255, 255, 255, 0.85)', // White background fill
                            borderRadius: 4, // Rounded corners for background
                            padding: 4, // Padding inside the background
                            
                            // Dynamic positioning based on dataset type
                            anchor: (context) => context.dataset.type === 'line' ? 'end' : 'center',
                            align: (context) => context.dataset.type === 'line' ? 'end' : 'center',
                            offset: (context) => context.dataset.type === 'line' ? 4 : 0,

                            formatter: (val, context) => {
                                if (context.dataset.label === 'Target (20:30)') return '';
                                if (context.dataset.type === 'line') return decToTime(val);
                                if (val === 0) return '';
                                
                                // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Weight bar ‚Üí ‡πÅ‡∏™‡∏î‡∏á ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å + ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏±‡∏ô
                                if (context.dataset.label === 'Weight') {
                                    const tons = Math.round(val).toLocaleString();
                                    const shipments = dataShipments[context.dataIndex] || 0;
                                    return `${tons} Tons\n${shipments} ‡∏Ñ‡∏±‡∏ô`;
                                }
                                
                                return Math.round(val).toLocaleString();
                            },
                            font: { weight: 'bold', size: 10, family: 'Sarabun' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.dataset.yAxisID === 'yTime') return label + decToTime(context.raw);
                                    return label + context.raw.toLocaleString(undefined, {minimumFractionDigits: 2}) + ' Tons';
                                }
                            }
                        }
                    }
                }
            });
        }

        function drawPie(id, legId, group, total, isCount = false) {
            console.log(`ü•ß drawPie called - id: ${id}, legId: ${legId}`);
            console.log('üìä Data:', Object.keys(group).length, 'categories, total:', total);
            
            if (activeCharts[id]) { 
                activeCharts[id].destroy(); 
                delete activeCharts[id]; 
                console.log(`‚ôªÔ∏è Destroyed existing chart: ${id}`);
            }
            
            const sortedEntries = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sortedEntries.map(e => e[0]);
            const dataVals = sortedEntries.map(e => isCount ? e[1] : e[1] / 1000);
            const colors = generateColors(labels.length);
            const leaderLinePlugin = {
                id: 'leaderLine',
                afterDraw: (chart) => {
                    const { ctx } = chart; ctx.save(); const meta = chart.getDatasetMeta(0);
                    if (!meta || !meta.data) { ctx.restore(); return; }
                    meta.data.forEach((element, index) => {
                        if (element.hidden) return; 
                        const val = dataVals[index];
                        const ratio = val / (isCount ? total : total / 1000);
                        if (ratio * 100 <= 3) return;
                        const model = element;
                        const midAngle = model.startAngle + (model.endAngle - model.startAngle) / 2;
                        const r = model.outerRadius;
                        const startX = model.x + Math.cos(midAngle) * (r - 2);
                        const startY = model.y + Math.sin(midAngle) * (r - 2);
                        const endX = model.x + Math.cos(midAngle) * (r + 20);
                        const endY = model.y + Math.sin(midAngle) * (r + 20);
                        ctx.beginPath(); ctx.moveTo(startX, startY); ctx.lineTo(endX, endY);
                        ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 2; ctx.stroke();
                    });
                    ctx.restore();
                }
            };
            
            const canvas = document.getElementById(id);
            if (!canvas) {
                console.error(`‚ùå Canvas not found: ${id}`);
                return;
            }
            console.log(`‚úÖ Canvas found: ${id}`);
            
            activeCharts[id] = new Chart(canvas, {
                type: 'pie',
                data: { labels, datasets: [{ data: dataVals, backgroundColor: colors, borderWidth: 2, borderColor: '#fff' }] },
                plugins: [leaderLinePlugin],
                options: {
                    maintainAspectRatio: false, layout: { padding: 30 }, radius: '65%', 
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            color: '#1e293b', anchor: 'end', align: 'end', offset: 15,
                            formatter: (value, ctx) => {
                                const pct = ((isCount ? value : value * 1000) / total * 100).toFixed(1);
                                if (pct <= 3) return '';
                                const displayVal = value.toLocaleString(undefined, { minimumFractionDigits: isCount ? 0 : 1, maximumFractionDigits: isCount ? 0 : 1 });
                                return `${displayVal} ${isCount ? '' : 'Tons'}\n(${pct}%)`;
                            },
                            font: { size: 11, weight: 'bold', family: 'Sarabun' }, textAlign: 'center', padding: 4
                        },
                        tooltip: { callbacks: { label: (ctx) => { const val = ctx.raw; const pct = (val / (isCount ? total : total / 1000) * 100).toFixed(1); return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: isCount ? 0 : 2})} ${isCount ? '' : 'Tons'} (${pct}%)`; } }, backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12, titleFont: { size: 13, weight: 'bold', family: 'Sarabun' }, bodyFont: { size: 12, family: 'Sarabun' }, displayColors: true, boxWidth: 15, boxHeight: 15 }
                    },
                    animation: { duration: 500, animateRotate: true, animateScale: false }
                }
            });
            console.log(`‚úÖ Chart created successfully: ${id}`);
            
            const legendEl = document.getElementById(legId);
            if (legendEl) {
                legendEl.innerHTML = labels.map((l, i) => {
                    const val = dataVals[i];
                    const pct = ((isCount ? val : val * 1000) / total * 100).toFixed(1);
                    const displayVal = val.toLocaleString(undefined, { minimumFractionDigits: isCount ? 0 : 2, maximumFractionDigits: isCount ? 0 : 2 });
                    return `<div class="flex justify-between items-center text-xs p-2.5 bg-slate-50 rounded-xl border border-slate-100 hover:border-amber-200 transition-colors"><div class="flex items-center font-bold text-slate-600"><span class="w-3 h-3 rounded-full mr-2 shadow-sm" style="background:${colors[i]}"></span><span class="truncate max-w-[200px]" title="${l}">${l}</span></div><div class="font-black text-slate-800 whitespace-nowrap">${displayVal} ${isCount ? '' : 'Tons.'} <span class="text-slate-400 font-medium ml-1">(${pct}%)</span></div></div>`;
                }).join('');
                console.log(`‚úÖ Legend rendered: ${legId}`);
            } else {
                console.warn(`‚ö†Ô∏è Legend element not found: ${legId}`);
            }
        }

        function drawBar(id, containerId, group) {
            console.log(`üé® drawBar called - id: ${id}, containerId: ${containerId}`);
            console.log('üìä Data:', Object.keys(group).length, 'categories');
            
            if (activeCharts[id]) { 
                activeCharts[id].destroy(); 
                delete activeCharts[id]; 
                console.log(`‚ôªÔ∏è Destroyed existing chart: ${id}`);
            }
            
            const sorted = Object.entries(group).sort((a, b) => b[1] - a[1]);
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1] / 1000);
            const total = dataVals.reduce((a, b) => a + b, 0);
            const colors = generateColors(labels.length);
            
            const container = document.getElementById(containerId);
            if (!container) {
                console.error(`‚ùå Container not found: ${containerId}`);
                return;
            }
            console.log(`‚úÖ Container found: ${containerId}`);
            
            const dynamicHeight = Math.max(500, labels.length * 60);
            container.style.height = dynamicHeight + 'px';
            
            const canvas = document.getElementById(id);
            if (!canvas) {
                console.error(`‚ùå Canvas not found: ${id}`);
                return;
            }
            console.log(`‚úÖ Canvas found: ${id}`);
            
            activeCharts[id] = new Chart(canvas, {
                type: 'bar',
                data: { labels, datasets: [{ data: dataVals, backgroundColor: colors, borderRadius: 6, barPercentage: 0.7 }] },
                options: {
                    indexAxis: 'y', maintainAspectRatio: false, layout: { padding: { right: 120, left: 10 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: { anchor: 'end', align: 'end', color: '#334155', formatter: (value) => { const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0; const displayVal = value.toLocaleString(undefined, { minimumFractionDigits: 1, maximumFractionDigits: 1 }); return `${displayVal} Tons (${pct}%)`; }, font: { size: 11, weight: 'bold', family: 'Sarabun' }, clip: false, offset: 8 },
                        tooltip: { callbacks: { label: (ctx) => { const val = ctx.raw; const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0; return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons (${pct}%)`; } }, backgroundColor: 'rgba(0, 0, 0, 0.8)', padding: 12, titleFont: { size: 13, weight: 'bold', family: 'Sarabun' }, bodyFont: { size: 12, family: 'Sarabun' }, displayColors: true, boxWidth: 15, boxHeight: 15 }
                    },
                    scales: {
                        x: { display: false, grace: '5%' },
                        y: { grid: { display: false }, ticks: { callback: function(value, index) { const label = this.getLabelForValue(value); if (!label) return ''; return label.length > 30 ? label.substring(0, 27) + '...' : label; }, font: { size: 11, weight: '600', family: 'Sarabun' }, color: '#475569', padding: 8 } }
                    },
                    animation: { duration: 500 }
                }
            });
            console.log(`‚úÖ Chart created successfully: ${id}`);
        }

        window.addEventListener('beforeunload', () => {
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) { activeCharts[key].destroy(); delete activeCharts[key]; }
            });
        });


        // ============================================
        // TONS/HEAD FUNCTIONS
        // ============================================

        function runTonsHeadFilterEngine() {
            renderTonsHeadPart();
        }

        function renderTonsHeadPart() {
            console.clear(); // Clear console for fresh output
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üöÄ TONS/HEAD RENDER - VERSION 2.0.1');
            console.log('   Fixed: Filter logic for Tons per Month calculation');
            console.log('   Date: 2025-02-06 17:30');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• employeeData ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!employeeData || employeeData.length === 0) {
                console.warn('‚ö†Ô∏è No Employee data available');
                resetTonsHeadUI();
                return;
            }
            
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• headData ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
            if (!headData || headData.length === 0) {
                console.warn('‚ö†Ô∏è No Head data available');
                resetTonsHeadUI();
                return;
            }
            
            // ‡πÉ‡∏ä‡πâ filter ‡∏à‡∏≤‡∏Å UI (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)
            const getChecked = (id) => Array.from(document.querySelectorAll(`.filter-${id}:checked`)).map(el => el.value);
            const selectedMonths = getChecked('list-th-month');
            
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç FILTER DEBUG');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            
            // Debug all checkboxes
            const allCheckboxes = document.querySelectorAll('.filter-list-th-month');
            const checkedCheckboxes = document.querySelectorAll('.filter-list-th-month:checked');
            
            console.log('Total checkboxes:', allCheckboxes.length);
            console.log('Checked checkboxes:', checkedCheckboxes.length);
            
            // ‡πÅ‡∏™‡∏î‡∏á checkbox ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏ï‡∏±‡∏ß
            allCheckboxes.forEach((cb, idx) => {
                console.log(`  [${idx}] ${cb.value}: ${cb.checked ? '‚úÖ CHECKED' : '‚ùå NOT CHECKED'}`);
            });
            
            console.log('');
            console.log('Selected Months:', selectedMonths);
            console.log('Selected Months length:', selectedMonths.length);
            console.log('Filter active?', selectedMonths.length > 0 ? 'YES - Will filter' : 'NO - Will show ALL');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            // ‚ö†Ô∏è IMPORTANT: Filter logic fixed
            // Problem: When checkbox is CHECKED, selectedMonths has value, but we want to filter
            // When checkbox is NOT CHECKED, selectedMonths is empty, we show all
            
            console.log('üîç APPLYING FILTER LOGIC');
            console.log('  selectedMonths:', selectedMonths);
            console.log('  selectedMonths.length:', selectedMonths.length);
            
            // Simple logic: If selectedMonths has items, filter. Otherwise show all.
            const filteredHeadData = (selectedMonths.length > 0)
                ? headData.filter(item => selectedMonths.includes(item.Month))
                : headData;
            
            const filteredMasterData = (selectedMonths.length > 0)
                ? masterData.filter(item => selectedMonths.includes(item.Month))
                : masterData;
            
            console.log('');
            console.log('üîç FILTER RESULT:');
            console.log('  Condition: selectedMonths.length =', selectedMonths.length);
            console.log('  Action:', selectedMonths.length > 0 ? 'FILTER by selected months' : 'SHOW ALL');
            console.log('  headData (original):', headData.length, 'rows');
            console.log('  filteredHeadData:', filteredHeadData.length, 'rows');
            console.log('  masterData (original):', masterData.length, 'rows');
            console.log('  filteredMasterData:', filteredMasterData.length, 'rows');
            console.log('');
            
            // Verify filter worked
            if (selectedMonths.length > 0) {
                const uniqueMonths = new Set();
                masterData.forEach(row => {
                    if (row.Month) uniqueMonths.add(row.Month);
                });
                
                if (filteredMasterData.length === masterData.length && uniqueMonths.size > 1) {
                    // Only show warning if there are multiple months but filter didn't work
                    console.warn('‚ö†Ô∏è Filter may not be working - multiple months exist but got same data length');
                    console.log('   Unique months in data:', Array.from(uniqueMonths));
                } else if (uniqueMonths.size === 1) {
                    // Data has only one month - filter working correctly
                    console.log('‚úÖ Filter working correctly');
                    console.log('   Note: Data contains only 1 unique month:', Array.from(uniqueMonths)[0]);
                } else {
                    console.log('‚úÖ FILTER WORKED! Reduced from', masterData.length, 'to', filteredMasterData.length, 'rows');
                }
            }
            console.log('');
            
            console.log('üì• Employee Data:', employeeData.length, 'factories');
            console.log('üì• Head Data BEFORE filter:', headData.length, 'months');
            console.log('üì• Head Data AFTER filter:', filteredHeadData.length, 'months');
            console.log('üì• Master Data BEFORE filter:', masterData.length, 'rows');
            console.log('üì• Master Data AFTER filter:', filteredMasterData.length, 'rows');
            
            // ‡πÅ‡∏™‡∏î‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÉ‡∏ô filteredHeadData
            const monthsInFiltered = filteredHeadData.map(item => item.Month);
            console.log('üìÖ Months in filtered Head Data:', monthsInFiltered);
            console.log('');

            if (!filteredMasterData || filteredMasterData.length === 0) {
                console.warn('‚ö†Ô∏è No FG In-Out data after filtering');
                resetTonsHeadUI();
                return;
            }

            if (!filteredHeadData || filteredHeadData.length === 0) {
                console.warn('‚ö†Ô∏è No Head data after filtering');
                resetTonsHeadUI();
                return;
            }

            // Step 1: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ú‡∏•‡∏£‡∏ß‡∏°‡∏à‡∏≤‡∏Å Employee table)
            let totalPeople = 0;
            const employeeMap = {};
            employeeData.forEach(item => {
                if (item.Factory) {
                    const people = Number(item['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô'] || item.people || item.People || 0);
                    employeeMap[item.Factory] = people;
                    totalPeople += people;
                }
            });
            
            console.log('üë• Total People (‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î):', totalPeople);
            console.log('üë• Employee Map:', employeeMap);

            // Step 2: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å Head table ‡∏ó‡∏µ‡πà filter ‡πÅ‡∏•‡πâ‡∏ß)
            let totalWorkingDays = 0;
            let numberOfMonths = 0;
            const monthsWithData = new Set(); // ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            
            console.log('üîç Processing filtered Head Data...');
            filteredHeadData.forEach(item => {
                if (item.Month) {
                    const days = Number(item['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] || item.Working_Days || item.working_days || 0);
                    console.log(`  - ${item.Month}: ${days} ‡∏ß‡∏±‡∏ô`);
                    if (days > 0) {
                        totalWorkingDays += days;
                        monthsWithData.add(item.Month);
                    }
                }
            });
            
            numberOfMonths = monthsWithData.size;
            
            console.log('');
            console.log('üîç NUMBER OF MONTHS CALCULATION:');
            console.log('  monthsWithData (Set):', Array.from(monthsWithData));
            console.log('  monthsWithData.size:', monthsWithData.size);
            console.log('  numberOfMonths:', numberOfMonths);
            console.log('  ‚ö†Ô∏è This should match the number of filtered months!');
            console.log('');
            
            console.log('üìÖ Total Working Days:', totalWorkingDays);
            console.log('üìÖ Number of Months:', numberOfMonths);
            console.log('üìÖ Months:', Array.from(monthsWithData));

            // Step 3: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏à‡∏≤‡∏Å masterData ‡∏ó‡∏µ‡πà filter ‡πÅ‡∏•‡πâ‡∏ß)
            console.log('üîç Calculating weight from FILTERED data...');
            console.log('  Using filteredMasterData with', filteredMasterData.length, 'rows');
            
            // ‡πÅ‡∏™‡∏î‡∏á sample 3 rows ‡πÅ‡∏£‡∏Å
            if (filteredMasterData.length > 0) {
                console.log('  Sample data (first 3 rows):');
                filteredMasterData.slice(0, 3).forEach((item, idx) => {
                    console.log(`    [${idx}] Month: ${item.Month}, Weight: ${item['Gross weight']}`);
                });
            }
            
            let totalWeight = 0;
            const weightByFactory = {};
            
            filteredMasterData.forEach(item => {
                if (item['Gross weight']) {
                    const weight = Number(item['Gross weight']) || 0;
                    totalWeight += weight;
                    
                    // ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Factory ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü
                    if (item['Sloc.']) {
                        const factory = item['Sloc.'];
                        if (!weightByFactory[factory]) {
                            weightByFactory[factory] = 0;
                        }
                        weightByFactory[factory] += weight;
                    }
                }
            });
            
            const totalTons = totalWeight / 1000;
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‚öñÔ∏è WEIGHT CALCULATION');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('Filtered Master Data rows:', filteredMasterData.length);
            console.log('Total Weight (kg):', totalWeight.toLocaleString());
            console.log('Total Tons:', totalTons.toFixed(2));
            console.log('Weight by Factory:', weightByFactory);
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');

            // Step 3.5: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Tons/Month ‡πÅ‡∏¢‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü)
            const tonsPerMonthByMonth = {}; // {‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: Tons/Month}
            const workingDaysMap = {}; // {‡πÄ‡∏î‡∏∑‡∏≠‡∏ô: ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô}
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á map ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            console.log('üîç Building working days map...');
            filteredHeadData.forEach(item => {
                if (item.Month) {
                    const days = Number(item['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô'] || item.Working_Days || item.working_days || 0);
                    if (days > 0) {
                        workingDaysMap[item.Month] = days;
                        console.log(`  - ${item.Month}: ${days} ‡∏ß‡∏±‡∏ô`);
                    }
                }
            });
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            console.log('üîç Calculating weight by month FROM FILTERED DATA...');
            console.log('  filteredMasterData rows:', filteredMasterData.length);
            
            // ‡∏î‡∏π‡∏ß‡πà‡∏≤ filteredMasterData ‡∏°‡∏µ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏ö‡πâ‡∏≤‡∏á
            const monthsInFilteredMaster = new Set();
            filteredMasterData.forEach(item => {
                if (item.Month) monthsInFilteredMaster.add(item.Month);
            });
            console.log('  Unique months in filteredMasterData:', Array.from(monthsInFilteredMaster));
            console.log('  Expected months (from filter):', selectedMonths.length > 0 ? selectedMonths : 'ALL');
            
            const weightByMonth = {};
            filteredMasterData.forEach(item => {
                if (item.Month && item['Gross weight']) {
                    const month = item.Month;
                    const weight = Number(item['Gross weight']) || 0;
                    if (!weightByMonth[month]) {
                        weightByMonth[month] = 0;
                    }
                    weightByMonth[month] += weight;
                }
            });
            console.log('‚öñÔ∏è Weight by Month (kg):', weightByMonth);
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Tons/Month ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç FINAL CALCULATION FOR CHART');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('weightByMonth (raw data):', weightByMonth);
            console.log('workingDaysMap:', workingDaysMap);
            console.log('');
            
            Object.keys(weightByMonth).forEach(month => {
                const days = workingDaysMap[month];
                console.log(`Processing month: ${month}`);
                console.log(`  - Weight (kg): ${weightByMonth[month]}`);
                console.log(`  - Working days: ${days}`);
                
                if (days && days > 0) {
                    const tonsInMonth = weightByMonth[month] / 1000;
                    const tonsPerDay = tonsInMonth / days; // ‡∏´‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
                    tonsPerMonthByMonth[month] = tonsPerDay;
                    console.log(`  - Step 1: ${weightByMonth[month]} √∑ 1000 = ${tonsInMonth.toFixed(2)} Tons`);
                    console.log(`  - Step 2: ${tonsInMonth.toFixed(2)} √∑ ${days} days = ${tonsPerDay.toFixed(2)} Tons/Day`);
                    console.log(`  - Assigned to tonsPerMonthByMonth['${month}']: ${tonsPerDay.toFixed(2)}`);
                } else {
                    console.warn(`  - ‚ö†Ô∏è No working days - SKIPPED`);
                }
                console.log('');
            });
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä FINAL tonsPerMonthByMonth:', tonsPerMonthByMonth);
            console.log('   Keys:', Object.keys(tonsPerMonthByMonth));
            console.log('   Values:', Object.values(tonsPerMonthByMonth));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');

            // Step 4: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Tons per Month ‡πÅ‡∏•‡∏∞ Tons per Month per Head
            
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üîç TONS PER MONTH CALCULATION');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('selectedMonths:', selectedMonths);
            console.log('selectedMonths.length:', selectedMonths.length);
            console.log('totalWorkingDays:', totalWorkingDays);
            console.log('totalTons:', totalTons.toFixed(2));
            console.log('');
            
            // Tons per Month = Total Tons √∑ Total Working Days
            // This represents tons per day √ó average days in a month
            let tonsPerMonth = 0;
            
            if (totalWorkingDays > 0) {
                tonsPerMonth = totalTons / totalWorkingDays;
                console.log('‚úÖ Calculation: totalTons √∑ totalWorkingDays');
                console.log('   ', totalTons.toFixed(2), '√∑', totalWorkingDays, '=', tonsPerMonth.toFixed(2));
                console.log('   This represents Tons per Working Day');
            } else {
                console.warn('‚ö†Ô∏è Total Working Days = 0, cannot calculate Tons per Month');
            }
            
            console.log('');
            console.log('üìä Final Tons per Month:', tonsPerMonth.toFixed(2));
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');
            
            // Tons per Month per Head = Total Tons √∑ Working Days √∑ Total People
            let tonsPerMonthPerHead = 0;
            if (totalWorkingDays > 0 && totalPeople > 0) {
                tonsPerMonthPerHead = totalTons / totalWorkingDays / totalPeople;
            }
            
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä TONS PER MONTH (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‡∏™‡∏π‡∏ï‡∏£: Total Tons √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
            console.log('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:', totalTons.toFixed(2), '√∑', numberOfMonths, '=', tonsPerMonth.toFixed(2));
            console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:', tonsPerMonth.toFixed(2), 'Tons/Month');
            console.log('');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä TONS PER MONTH PER HEAD');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‡∏™‡∏π‡∏ï‡∏£: Total Tons √∑ Working Days √∑ Total People');
            console.log('‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì:', totalTons.toFixed(2), '√∑', totalWorkingDays, '√∑', totalPeople, '=', tonsPerMonthPerHead.toFixed(2));
            console.log('‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå:', tonsPerMonthPerHead.toFixed(2), 'Tons/Month/Head');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');

            // Step 5: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Tons/Head ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏° Factory (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü)
            // ‡∏™‡∏π‡∏ï‡∏£: (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Factory √∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('üìä TONS/HEAD BY FACTORY (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü)');
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('‡∏™‡∏π‡∏ï‡∏£: (‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Factory √∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô) √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô');
            console.log('');
            
            const chartData = {};
            
            // ‡πÉ‡∏ä‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            if (totalWorkingDays === 0) {
                console.warn('‚ö†Ô∏è Total Working Days = 0, cannot calculate Tons/Head by Factory');
            } else {
                Object.keys(weightByFactory).forEach(factory => {
                    const people = employeeMap[factory];
                    if (people && people > 0) {
                        const weightInTons = weightByFactory[factory] / 1000;
                        
                        // Step 1: ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å √∑ ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô = Tons per Day
                        const tonsPerDay = weightInTons / totalWorkingDays;
                        
                        // Step 2: Tons per Day √∑ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô = Tons/Head
                        const tonsPerHead = tonsPerDay / people;
                        
                        chartData[factory] = tonsPerHead;
                        
                        console.log(`Factory: ${factory}`);
                        console.log(`  - ‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å‡∏£‡∏ß‡∏°: ${weightInTons.toFixed(2)} Tons`);
                        console.log(`  - ‡∏ß‡∏±‡∏ô‡∏ó‡∏≥‡∏á‡∏≤‡∏ô: ${totalWorkingDays} ‡∏ß‡∏±‡∏ô`);
                        console.log(`  - ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô: ${people} ‡∏Ñ‡∏ô`);
                        console.log(`  - Step 1: ${weightInTons.toFixed(2)} √∑ ${totalWorkingDays} = ${tonsPerDay.toFixed(4)} Tons/Day`);
                        console.log(`  - Step 2: ${tonsPerDay.toFixed(4)} √∑ ${people} = ${tonsPerHead.toFixed(4)} Tons/Head`);
                        console.log(`  - ‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå: ${tonsPerHead.toFixed(2)} Tons/Head`);
                        console.log('');
                    } else {
                        console.log(`Factory: ${factory} - ‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏ô (‡∏Ç‡πâ‡∏≤‡∏°)`);
                    }
                });
            }
            
            console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
            console.log('');

            // Step 6: Update UI
            const totalTonsEl = document.getElementById('th-total-tons');
            const totalDaysEl = document.getElementById('th-total-days');
            const totalPeopleEl = document.getElementById('th-total-people');
            const tonsPerMonthEl = document.getElementById('th-tons-per-month');
            const tonsPerMonthPerHeadEl = document.getElementById('th-tons-per-day');
            
            if (totalTonsEl) totalTonsEl.innerText = totalTons.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (totalDaysEl) totalDaysEl.innerText = totalWorkingDays.toLocaleString();
            if (totalPeopleEl) totalPeopleEl.innerText = totalPeople.toLocaleString();
            if (tonsPerMonthEl) tonsPerMonthEl.innerText = tonsPerMonth.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (tonsPerMonthPerHeadEl) tonsPerMonthPerHeadEl.innerText = tonsPerMonthPerHead.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Step 7: Draw Charts
            drawTonsMonthChart(tonsPerMonthByMonth); // ‡∏Å‡∏£‡∏≤‡∏ü Tons/Month by Month (‡∏Å‡πà‡∏≠‡∏ô)
            drawTonsHeadChart(chartData); // ‡∏Å‡∏£‡∏≤‡∏ü Tons/Head by Factory (‡∏´‡∏•‡∏±‡∏á)
            
            console.log('‚úÖ UI updated successfully');
            console.log('=== ‚úÖ END renderTonsHeadPart ===');
        }
        
        function resetTonsHeadUI() {
            console.log('üîÑ Resetting TONS/HEAD UI...');
            
            // Destroy charts
            if (activeCharts['th-month-chart']) {
                activeCharts['th-month-chart'].destroy();
                delete activeCharts['th-month-chart'];
                console.log('‚ôªÔ∏è Destroyed th-month-chart');
            }
            if (activeCharts['th-chart']) {
                activeCharts['th-chart'].destroy();
                delete activeCharts['th-chart'];
                console.log('‚ôªÔ∏è Destroyed th-chart');
            }
            
            // Reset UI values
            const totalTonsEl = document.getElementById('th-total-tons');
            const totalDaysEl = document.getElementById('th-total-days');
            const totalPeopleEl = document.getElementById('th-total-people');
            const tonsPerMonthEl = document.getElementById('th-tons-per-month');
            const tonsPerMonthPerHeadEl = document.getElementById('th-tons-per-day');
            
            if (totalTonsEl) totalTonsEl.innerText = "0.00";
            if (totalDaysEl) totalDaysEl.innerText = "0";
            if (totalPeopleEl) totalPeopleEl.innerText = "0";
            if (tonsPerMonthEl) tonsPerMonthEl.innerText = "0.00";
            if (tonsPerMonthPerHeadEl) tonsPerMonthPerHeadEl.innerText = "0.00";
            
            console.log('‚úÖ UI reset complete');
        }

        function drawTonsMonthChart(monthData) {
            console.log('üé® drawTonsMonthChart called');
            console.log('üìä Chart data:', monthData);
            
            if (activeCharts['th-month-chart']) {
                activeCharts['th-month-chart'].destroy();
                delete activeCharts['th-month-chart'];
                console.log('‚ôªÔ∏è Destroyed existing month chart');
            }

            // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏õ‡∏è‡∏¥‡∏ó‡∏¥‡∏ô
            const monthOrder = {
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°': 1, '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå': 2, '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°': 3, '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô': 4,
                '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°': 5, '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô': 6, '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°': 7, '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°': 8,
                '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô': 9, '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°': 10, '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô': 11, '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°': 12
            };
            
            const sorted = Object.entries(monthData).sort((a, b) => {
                const orderA = monthOrder[a[0]] || 99;
                const orderB = monthOrder[b[0]] || 99;
                return orderA - orderB;
            });
            
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1]);
            const colors = generateColors(labels.length);

            console.log('üìä Labels:', labels);
            console.log('üìä Data values:', dataVals);

            const canvas = document.getElementById('th-month-chart');
            if (!canvas) {
                console.error('‚ùå Canvas th-month-chart not found!');
                return;
            }
            console.log('‚úÖ Canvas found:', canvas);

            const container = document.getElementById('th-month-chart-container');
            const dynamicHeight = 400; // Fixed height for vertical bar chart
            
            if (container) {
                const parentEl = container.parentElement;
                if (parentEl && parentEl.offsetWidth === 0) {
                    parentEl.style.width = '100%';
                    parentEl.style.minWidth = '600px';
                }
                
                container.style.height = dynamicHeight + 'px';
                container.style.width = '100%';
                container.style.minWidth = '600px';
                void container.offsetHeight;
            }

            try {
                activeCharts['th-month-chart'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Tons/Day',
                        data: dataVals,
                        backgroundColor: colors,
                        borderRadius: 8,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    indexAxis: 'x', // Vertical bars (changed from 'y')
                    maintainAspectRatio: false,
                    layout: { padding: { top: 40, bottom: 10, left: 10, right: 10 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'top',
                            color: '#334155',
                            formatter: (value) => {
                                return `${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                            },
                            font: { size: 11, weight: 'bold', family: 'Sarabun' },
                            clip: false,
                            offset: 4
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const val = ctx.raw;
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons/Day`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold', family: 'Sarabun' },
                            bodyFont: { size: 12, family: 'Sarabun' }
                        }
                    },
                    scales: {
                        x: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11, weight: '600', family: 'Sarabun' },
                                color: '#475569',
                                padding: 8
                            }
                        },
                        y: { 
                            display: true,
                            grace: '10%',
                            ticks: {
                                font: { size: 11, family: 'Sarabun' },
                                color: '#64748b'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    animation: { duration: 600 }
                }
            });
            
            console.log('‚úÖ Month chart created successfully!');
        } catch (error) {
            console.error('‚ùå Error creating month chart:', error);
        }
        }

        function drawTonsHeadChart(tonsData) {
            console.log('üé® drawTonsHeadChart called');
            console.log('üìä Chart data:', tonsData);
            
            if (activeCharts['th-chart']) {
                activeCharts['th-chart'].destroy();
                delete activeCharts['th-chart'];
                console.log('‚ôªÔ∏è Destroyed existing chart');
            }

            const sorted = Object.entries(tonsData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1]);
            const total = dataVals.reduce((a, b) => a + b, 0);
            const colors = generateColors(labels.length);

            console.log('üìä Labels:', labels);
            console.log('üìä Data values:', dataVals);

            const canvas = document.getElementById('th-chart');
            if (!canvas) {
                console.error('‚ùå Canvas th-chart not found!');
                return;
            }
            console.log('‚úÖ Canvas found:', canvas);

            const container = document.getElementById('th-chart-container');
            const dynamicHeight = Math.max(500, labels.length * 60);
            
            if (container) {
                // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ parent ‡∏Ç‡∏≠‡∏á container ‡∏°‡∏µ width
                const parentEl = container.parentElement;
                if (parentEl && parentEl.offsetWidth === 0) {
                    console.warn('‚ö†Ô∏è Parent width is 0, forcing width');
                    parentEl.style.width = '100%';
                    parentEl.style.minWidth = '600px';
                }
                
                container.style.height = dynamicHeight + 'px';
                container.style.width = '100%';
                container.style.minWidth = '600px';
                
                // Force reflow
                void container.offsetHeight;
                
                setTimeout(() => {
                    console.log('‚úÖ Container dimensions set:', {
                        height: dynamicHeight,
                        width: container.offsetWidth,
                        parentWidth: parentEl ? parentEl.offsetWidth : 0,
                        display: window.getComputedStyle(container).display
                    });
                }, 10);
            } else {
                console.warn('‚ö†Ô∏è Container th-chart-container not found');
            }

            try {
                activeCharts['th-chart'] = new Chart(canvas, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Tons/Head',
                        data: dataVals,
                        backgroundColor: colors,
                        borderRadius: 8,
                        barPercentage: 0.7
                    }]
                },
                options: {
                    indexAxis: 'y',
                    maintainAspectRatio: false,
                    layout: { padding: { right: 160, left: 10 } },
                    plugins: {
                        legend: { display: false },
                        datalabels: {
                            anchor: 'end',
                            align: 'end',
                            color: '#334155',
                            formatter: (value) => {
                                return `${value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons/Head`;
                            },
                            font: { size: 11, weight: 'bold', family: 'Sarabun' },
                            clip: false,
                            offset: 8
                        },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => {
                                    const val = ctx.raw;
                                    return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})} Tons/Head`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: { size: 13, weight: 'bold', family: 'Sarabun' },
                            bodyFont: { size: 12, family: 'Sarabun' }
                        }
                    },
                    scales: {
                        x: { display: false, grace: '5%' },
                        y: {
                            grid: { display: false },
                            ticks: {
                                font: { size: 11, weight: '600', family: 'Sarabun' },
                                color: '#475569',
                                padding: 8
                            }
                        }
                    },
                    animation: { duration: 600 }
                }
            });
            
            console.log('‚úÖ Chart created successfully!');
            console.log('üìê Canvas dimensions after chart creation:', {
                width: canvas.width,
                height: canvas.height,
                offsetWidth: canvas.offsetWidth,
                offsetHeight: canvas.offsetHeight
            });
        } catch (error) {
            console.error('‚ùå Error creating chart:', error);
        }
        }
        
        window.onload = fetchEverything;
    </script>
</body>
</html>
