<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Intelligence - Sarabun Edition</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js & DataLabels -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:ital,wght@0,300;0,400;0,600;0,800;1,400&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; }
        
        /* Navigation Styles */
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        /* Filter Styles */
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <aside class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic">Ops <span class="text-white">WH2</span></h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1">
            <div onclick="switchTab('weight')" id="tab-weight" class="nav-item active">
                <span class="mr-2">‚öñÔ∏è</span> WEIGHT ANALYSIS
            </div>
            <div onclick="switchTab('shipment')" id="tab-shipment" class="nav-item">
                <span class="mr-2">üöö</span> SHIPMENT OPERATIONS
            </div>
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT RANKING
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button onclick="fetchEverything()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-4 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase">Database Rows</span>
                <span id="data-count-info" class="text-sm text-white font-mono font-bold">0</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- HEADER & FILTER -->
        <header class="bg-white border-b px-10 py-5 sticky top-0 z-40 flex justify-between items-center shadow-sm">
            <div class="flex items-center space-x-3">
                <!-- Filter Month -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-month')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        MONTH <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-month" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏î‡∏∑‡∏≠‡∏ô..." onkeyup="searchSub('list-month', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-month" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Week -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-week')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        WEEK <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-week" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå..." onkeyup="searchSub('list-week', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-week" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                <!-- Filter Sloc -->
                <div class="relative group">
                    <button onclick="toggleFilter('menu-sloc')" class="bg-slate-100 hover:bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-bold text-slate-700 flex items-center transition-all">
                        SLOC. <span class="ml-2 text-slate-400 text-xs">‚ñº</span>
                    </button>
                    <div id="menu-sloc" class="filter-menu">
                        <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ Sloc..." onkeyup="searchSub('list-sloc', this.value)" class="w-full text-sm p-3 mb-2 border-b outline-none font-medium">
                        <div id="list-sloc" class="filter-list custom-scrollbar space-y-1"></div>
                    </div>
                </div>
                
                <div class="h-8 w-px bg-slate-300 mx-2"></div>
                
                <button onclick="clearAllFilters()" class="text-xs font-bold text-slate-400 hover:text-amber-500 px-2 transition-colors uppercase tracking-wider">
                    RESET ALL
                </button>
            </div>
            
            <div class="flex items-center">
                <div class="text-right mr-4">
                    <div id="tab-title" class="text-lg font-black text-slate-800 uppercase tracking-wider">Weight Analysis</div>
                    <div class="text-xs text-slate-400 font-medium">Real-time Dashboard</div>
                </div>
                <div class="w-1.5 h-10 bg-amber-500 rounded-full"></div>
            </div>
        </header>

        <div id="content-body" class="p-10 space-y-10">
            
            <!-- SECTION 1: WEIGHT ANALYSIS -->
            <div id="section-weight" class="tab-content space-y-8">
                <!-- Summary Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Total Weight</div>
                        <div id="total-weight" class="text-4xl font-black text-slate-800 mb-1">0.00 <span class="text-lg text-slate-400">t</span></div>
                    </div>
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Avg Weight</div>
                        <div id="avg-weight" class="text-4xl font-black text-slate-800 mb-1">0.00 <span class="text-lg text-slate-400">t</span></div>
                    </div>
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Total Orders</div>
                        <div id="total-orders" class="text-4xl font-black text-slate-800 mb-1">0</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-sm font-black text-slate-700 uppercase tracking-wider mb-6 flex items-center">
                            <div class="w-2 h-8 bg-amber-400 mr-4 rounded"></div> Weight by Week
                        </div>
                        <div class="h-[420px] flex items-center justify-center"><canvas id="chartWeightWeek"></canvas></div>
                        <div id="legendWeightWeek" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-sm font-black text-slate-700 uppercase tracking-wider mb-6 flex items-center">
                            <div class="w-2 h-8 bg-amber-400 mr-4 rounded"></div> Weight by Sloc
                        </div>
                        <div class="h-[420px] flex items-center justify-center"><canvas id="chartWeightSloc"></canvas></div>
                        <div id="legendWeightSloc" class="mt-6 space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 2: SHIPMENT OPERATIONS -->
            <div id="section-shipment" class="tab-content hidden space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Total Shipments</div>
                        <div id="total-shipments" class="text-4xl font-black text-slate-800 mb-1">0</div>
                    </div>
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Unique Doors</div>
                        <div id="unique-doors" class="text-4xl font-black text-slate-800 mb-1">0</div>
                    </div>
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Avg Shipment Weight</div>
                        <div id="avg-shipment-weight" class="text-4xl font-black text-slate-800 mb-1">0.00 <span class="text-lg text-slate-400">t</span></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-sm font-black text-slate-700 uppercase tracking-wider mb-6 flex items-center">
                            <div class="w-2 h-8 bg-amber-400 mr-4 rounded"></div> Shipments by Door
                        </div>
                        <div class="h-[420px] flex items-center justify-center"><canvas id="chartShipmentDoor"></canvas></div>
                        <div id="legendShipmentDoor" class="mt-6 space-y-2"></div>
                    </div>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-sm font-black text-slate-700 uppercase tracking-wider mb-6 flex items-center">
                            <div class="w-2 h-8 bg-amber-400 mr-4 rounded"></div> Shipments by Week
                        </div>
                        <div class="h-[420px] flex items-center justify-center"><canvas id="chartShipmentWeek"></canvas></div>
                        <div id="legendShipmentWeek" class="mt-6 space-y-2"></div>
                    </div>
                </div>
            </div>

            <!-- SECTION 3: PRODUCT RANKING -->
            <div id="section-product" class="tab-content hidden space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Total Products</div>
                        <div id="total-products" class="text-4xl font-black text-slate-800 mb-1">0</div>
                    </div>
                    <div class="bg-white p-7 rounded-2xl shadow-sm border border-slate-100">
                        <div class="text-xs font-black text-slate-400 uppercase tracking-widest mb-3">Top Product Weight</div>
                        <div id="top-product-weight" class="text-4xl font-black text-slate-800 mb-1">0.00 <span class="text-lg text-slate-400">t</span></div>
                    </div>
                </div>

                <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-100">
                    <div class="text-sm font-black text-slate-700 uppercase tracking-wider mb-6 flex items-center">
                        <div class="w-2 h-8 bg-amber-400 mr-4 rounded"></div> Top Products by Weight
                    </div>
                    <div id="containerProductBar" class="h-[600px]"><canvas id="chartProductBar"></canvas></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        // ============= IMPROVED: STATE MANAGEMENT & INITIALIZATION =============
        const state = {
            rawData: [],
            filteredData: [],
            isLoading: false,
            fetchController: null,
            searchDebounceTimer: null
        };

        const activeCharts = {};
        let supabaseClient = null;

        // ============= IMPROVED: SAFE DOM HELPERS =============
        const safeGetElement = (id) => {
            const el = document.getElementById(id);
            if (!el) console.warn(`Element with id '${id}' not found`);
            return el;
        };

        const safeSetText = (id, text) => {
            const el = safeGetElement(id);
            if (el) el.innerText = text;
        };

        const safeSetHTML = (id, html) => {
            const el = safeGetElement(id);
            if (el) el.innerHTML = html;
        };

        // ============= IMPROVED: DEBOUNCED SEARCH =============
        function searchSub(listId, val) {
            clearTimeout(state.searchDebounceTimer);
            state.searchDebounceTimer = setTimeout(() => {
                const list = safeGetElement(listId);
                if (!list) return;
                
                const items = list.querySelectorAll('label');
                const searchTerm = val.toLowerCase().trim();
                
                items.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? '' : 'none';
                });
            }, 150);
        }

        // ============= IMPROVED: FILTER MANAGEMENT =============
        function toggleFilter(menuId) {
            const menu = safeGetElement(menuId);
            if (!menu) return;

            const isActive = menu.classList.contains('active');
            
            // Close all other menus first
            document.querySelectorAll('.filter-menu').forEach(m => {
                if (m.id !== menuId) m.classList.remove('active');
            });
            
            menu.classList.toggle('active');
        }

        // Close filters when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.filter-menu') && !e.target.closest('button[onclick^="toggleFilter"]')) {
                document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
            }
        });

        // ============= IMPROVED: STATUS UPDATES =============
        function updateStatus(message, isError = false, isSuccess = false) {
            const statusEl = safeGetElement('load-status');
            const dotEl = safeGetElement('status-dot');
            
            if (statusEl) statusEl.innerText = message;
            
            if (dotEl) {
                dotEl.className = 'w-3 h-3 rounded-full mr-2 transition-colors';
                if (isError) dotEl.classList.add('bg-red-500');
                else if (isSuccess) dotEl.classList.add('bg-green-500', 'animate-pulse');
                else dotEl.classList.add('bg-amber-500', 'animate-pulse');
            }
        }

        function updateProgress(percent) {
            const bar = safeGetElement('progress-bar');
            if (bar) {
                bar.style.width = `${Math.min(100, Math.max(0, percent))}%`;
            }
        }

        // ============= IMPROVED: DATA FETCHING WITH ERROR HANDLING =============
        async function fetchEverything() {
            // Prevent multiple simultaneous fetches
            if (state.isLoading) {
                console.log('Fetch already in progress');
                return;
            }

            // Abort previous fetch if exists
            if (state.fetchController) {
                state.fetchController.abort();
            }

            state.isLoading = true;
            state.fetchController = new AbortController();

            try {
                updateStatus('Loading...', false, false);
                updateProgress(10);

                // Initialize Supabase if not already done
                if (!supabaseClient) {
                    const SUPABASE_URL = 'https://mfdjrjofghgrwfptcmov.supabase.co';
                    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZGpyam9mZ2hncndmcHRjbW92Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUzMDU3MDcsImV4cCI6MjA1MDg4MTcwN30.xDxD-YBg3dqGcvkQBKrwBPCPO3fQOqg_K-WCJ8sULo4';
                    
                    if (!SUPABASE_URL || !SUPABASE_KEY) {
                        throw new Error('Supabase configuration missing');
                    }
                    
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }

                updateProgress(30);

                // Fetch data with timeout
                const fetchPromise = supabaseClient.from('test').select('*');
                const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Request timeout')), 30000)
                );

                const { data, error } = await Promise.race([fetchPromise, timeoutPromise]);

                updateProgress(70);

                if (error) throw error;
                
                if (!Array.isArray(data)) {
                    throw new Error('Invalid data format received');
                }

                state.rawData = data.map(row => ({
                    ...row,
                    Weight: parseFloat(row.Weight) || 0,
                    Month: String(row.Month || '').trim(),
                    Week: String(row.Week || '').trim(),
                    Sloc: String(row.Sloc || '').trim(),
                    Door: String(row.Door || '').trim(),
                    SalesDocument: String(row['Sales Document'] || '').trim(),
                    Material: String(row.Material || '').trim()
                }));

                state.filteredData = [...state.rawData];

                updateProgress(90);
                buildFilterOptions();
                runFilterEngine();
                updateProgress(100);
                
                updateStatus('Connected', false, true);
                safeSetText('data-count-info', state.rawData.length.toLocaleString());

            } catch (error) {
                console.error('Fetch error:', error);
                updateStatus(error.message || 'Connection Failed', true);
                safeSetText('data-count-info', '0');
                
                // Show user-friendly error message
                if (error.message.includes('timeout')) {
                    alert('‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                } else if (error.message.includes('network')) {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡∏≠‡∏Ç‡πà‡∏≤‡∏¢‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï');
                } else {
                    alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message);
                }
            } finally {
                state.isLoading = false;
                state.fetchController = null;
            }
        }

        // ============= IMPROVED: FILTER OPTIONS BUILDER =============
        function buildFilterOptions() {
            try {
                const months = [...new Set(state.rawData.map(r => r.Month).filter(Boolean))].sort();
                const weeks = [...new Set(state.rawData.map(r => r.Week).filter(Boolean))].sort();
                const slocs = [...new Set(state.rawData.map(r => r.Sloc).filter(Boolean))].sort();

                const buildCheckboxList = (container, items) => {
                    const el = safeGetElement(container);
                    if (!el) return;
                    
                    el.innerHTML = items.map(item => 
                        `<label class="flex items-center p-2 hover:bg-slate-50 rounded cursor-pointer transition-colors">
                            <input type="checkbox" value="${item}" onchange="runFilterEngine()" 
                                class="mr-2 w-4 h-4 text-amber-500 rounded focus:ring-2 focus:ring-amber-200">
                            <span class="text-sm font-medium text-slate-700">${item}</span>
                        </label>`
                    ).join('');
                };

                buildCheckboxList('list-month', months);
                buildCheckboxList('list-week', weeks);
                buildCheckboxList('list-sloc', slocs);
            } catch (error) {
                console.error('Error building filter options:', error);
            }
        }

        // ============= IMPROVED: FILTER ENGINE =============
        function runFilterEngine() {
            try {
                const getChecked = (id) => {
                    const container = safeGetElement(id);
                    if (!container) return [];
                    return Array.from(container.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(c => c.value);
                };

                const selectedMonths = getChecked('list-month');
                const selectedWeeks = getChecked('list-week');
                const selectedSlocs = getChecked('list-sloc');

                state.filteredData = state.rawData.filter(r => {
                    if (selectedMonths.length > 0 && !selectedMonths.includes(r.Month)) return false;
                    if (selectedWeeks.length > 0 && !selectedWeeks.includes(r.Week)) return false;
                    if (selectedSlocs.length > 0 && !selectedSlocs.includes(r.Sloc)) return false;
                    return true;
                });

                updateAllViews();
            } catch (error) {
                console.error('Error in filter engine:', error);
            }
        }

        // ============= IMPROVED: VIEW UPDATES =============
        function updateAllViews() {
            try {
                updateWeightView();
                updateShipmentView();
                updateProductView();
            } catch (error) {
                console.error('Error updating views:', error);
            }
        }

        function updateWeightView() {
            const data = state.filteredData;
            const totalWeight = data.reduce((sum, r) => sum + r.Weight, 0);
            const avgWeight = data.length > 0 ? totalWeight / data.length : 0;

            safeSetHTML('total-weight', `${(totalWeight/1000).toFixed(2)} <span class="text-lg text-slate-400">t</span>`);
            safeSetHTML('avg-weight', `${(avgWeight/1000).toFixed(2)} <span class="text-lg text-slate-400">t</span>`);
            safeSetText('total-orders', data.length.toLocaleString());

            const byWeek = data.reduce((acc, r) => {
                if (r.Week) acc[r.Week] = (acc[r.Week] || 0) + r.Weight;
                return acc;
            }, {});

            const bySloc = data.reduce((acc, r) => {
                if (r.Sloc) acc[r.Sloc] = (acc[r.Sloc] || 0) + r.Weight;
                return acc;
            }, {});

            drawPie('chartWeightWeek', 'legendWeightWeek', byWeek, false);
            drawPie('chartWeightSloc', 'legendWeightSloc', bySloc, false);
        }

        function updateShipmentView() {
            const data = state.filteredData;
            const totalShipments = new Set(data.map(r => r.SalesDocument).filter(Boolean)).size;
            const uniqueDoors = new Set(data.map(r => r.Door).filter(Boolean)).size;
            const totalWeight = data.reduce((sum, r) => sum + r.Weight, 0);
            const avgShipmentWeight = totalShipments > 0 ? totalWeight / totalShipments : 0;

            safeSetText('total-shipments', totalShipments.toLocaleString());
            safeSetText('unique-doors', uniqueDoors.toLocaleString());
            safeSetHTML('avg-shipment-weight', `${(avgShipmentWeight/1000).toFixed(2)} <span class="text-lg text-slate-400">t</span>`);

            const byDoor = data.reduce((acc, r) => {
                if (r.Door && r.SalesDocument) {
                    if (!acc[r.Door]) acc[r.Door] = new Set();
                    acc[r.Door].add(r.SalesDocument);
                }
                return acc;
            }, {});
            const doorCounts = Object.fromEntries(Object.entries(byDoor).map(([k,v]) => [k, v.size]));

            const byWeek = data.reduce((acc, r) => {
                if (r.Week && r.SalesDocument) {
                    if (!acc[r.Week]) acc[r.Week] = new Set();
                    acc[r.Week].add(r.SalesDocument);
                }
                return acc;
            }, {});
            const weekCounts = Object.fromEntries(Object.entries(byWeek).map(([k,v]) => [k, v.size]));

            drawPie('chartShipmentDoor', 'legendShipmentDoor', doorCounts, true);
            drawPie('chartShipmentWeek', 'legendShipmentWeek', weekCounts, true);
        }

        function updateProductView() {
            const data = state.filteredData;
            const byProduct = data.reduce((acc, r) => {
                if (r.Material) acc[r.Material] = (acc[r.Material] || 0) + r.Weight;
                return acc;
            }, {});

            const totalProducts = Object.keys(byProduct).length;
            const topProductWeight = Math.max(...Object.values(byProduct), 0);

            safeSetText('total-products', totalProducts.toLocaleString());
            safeSetHTML('top-product-weight', `${(topProductWeight/1000).toFixed(2)} <span class="text-lg text-slate-400">t</span>`);

            drawBar('chartProductBar', 'containerProductBar', byProduct);
        }

        // ============= IMPROVED: CHART HELPERS =============
        function generateColors(n) {
            const palette = [
                '#f59e0b', '#06b6d4', '#8b5cf6', '#ec4899', '#10b981',
                '#f97316', '#3b82f6', '#a855f7', '#ef4444', '#14b8a6',
                '#eab308', '#6366f1', '#d946ef', '#f43f5e', '#22c55e'
            ];
            const colors = [];
            for (let i = 0; i < n; i++) {
                colors.push(palette[i % palette.length]);
            }
            return colors;
        }

        // ============= IMPROVED: CHART RENDERING WITH MEMORY LEAK PREVENTION =============
        function drawPie(id, legId, group, isCount = false) {
            try {
                // Destroy existing chart safely
                if (activeCharts[id]) {
                    activeCharts[id].destroy();
                    activeCharts[id] = null;
                }

                const sorted = Object.entries(group).sort((a,b) => b[1] - a[1]).slice(0, 10);
                if (sorted.length === 0) {
                    safeSetHTML(legId, '<div class="text-center text-slate-400 text-sm py-4">No data available</div>');
                    return;
                }

                const labels = sorted.map(e => e[0]);
                const dataVals = sorted.map(e => isCount ? e[1] : e[1]/1000);
                const total = sorted.reduce((sum, e) => sum + e[1], 0);
                const colors = generateColors(labels.length);

                const canvas = safeGetElement(id);
                if (!canvas) return;

                // Custom plugin for leader lines
                const leaderLinePlugin = {
                    id: 'leaderLines',
                    afterDatasetsDraw: (chart) => {
                        const ctx = chart.ctx;
                        const meta = chart.getDatasetMeta(0);
                        if (!meta || !meta.data) return;

                        ctx.save();
                        meta.data.forEach((element, index) => {
                            const val = dataVals[index];
                            const ratio = val / (isCount ? total : total/1000);
                            const pct = ratio * 100;
                            
                            if (pct <= 4) return;

                            const model = element;
                            const midAngle = model.startAngle + (model.endAngle - model.startAngle) / 2;
                            const r = model.outerRadius;
                            
                            const startX = model.x + Math.cos(midAngle) * (r - 2);
                            const startY = model.y + Math.sin(midAngle) * (r - 2);
                            const endX = model.x + Math.cos(midAngle) * (r + 15);
                            const endY = model.y + Math.sin(midAngle) * (r + 15);
                            
                            ctx.beginPath();
                            ctx.moveTo(startX, startY);
                            ctx.lineTo(endX, endY);
                            ctx.strokeStyle = '#cbd5e1';
                            ctx.lineWidth = 2;
                            ctx.stroke();
                        });
                        ctx.restore();
                    }
                };

                activeCharts[id] = new Chart(canvas, {
                    type: 'pie',
                    data: { 
                        labels, 
                        datasets: [{ 
                            data: dataVals, 
                            backgroundColor: colors, 
                            borderWidth: 2, 
                            borderColor: '#fff' 
                        }] 
                    },
                    plugins: [leaderLinePlugin],
                    options: {
                        maintainAspectRatio: false,
                        layout: { padding: 40 },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                color: '#1e293b',
                                anchor: 'end',
                                align: 'end',
                                offset: 20,
                                formatter: (value, ctx) => {
                                    const pct = ((isCount ? value : value*1000) / total * 100).toFixed(1);
                                    return pct > 4 ? `${value.toLocaleString(undefined, {minimumFractionDigits: isCount?0:2})} ${isCount?'':'t'}\n(${pct}%)` : '';
                                },
                                font: { size: 12, weight: 'bold', family: 'Sarabun' },
                                textAlign: 'center'
                            },
                            tooltip: { 
                                callbacks: { 
                                    label: (ctx) => {
                                        const val = ctx.raw; 
                                        const pct = (val / (isCount ? total : total/1000) * 100).toFixed(1);
                                        return `${ctx.label}: ${val.toLocaleString(undefined, {minimumFractionDigits: isCount?0:2})} ${isCount?'':'t'} (${pct}%)`;
                                    } 
                                } 
                            }
                        }
                    }
                });

                // Custom Legend
                safeSetHTML(legId, labels.map((l, i) => {
                    const val = dataVals[i];
                    const pct = ((isCount ? val : val*1000)/total * 100).toFixed(1);
                    return `<div class="flex justify-between items-center text-xs p-2.5 bg-slate-50 rounded-xl border border-slate-100 hover:border-amber-200 transition-colors">
                        <div class="flex items-center font-bold text-slate-600"><span class="w-3 h-3 rounded-full mr-2 shadow-sm" style="background:${colors[i]}"></span> ${l}</div>
                        <div class="font-black text-slate-800">${val.toLocaleString(undefined, {minimumFractionDigits: isCount?0:2})} <span class="text-slate-400 font-medium ml-1">(${pct}%)</span></div>
                    </div>`;
                }).join(''));
            } catch (error) {
                console.error('Error drawing pie chart:', error);
            }
        }

        function drawBar(id, containerId, group) {
            try {
                // Destroy existing chart safely
                if (activeCharts[id]) {
                    activeCharts[id].destroy();
                    activeCharts[id] = null;
                }

                const sorted = Object.entries(group).sort((a,b) => b[1] - a[1]).slice(0, 20);
                if (sorted.length === 0) return;

                const labels = sorted.map(e => e[0]);
                const dataVals = sorted.map(e => e[1]/1000);
                const total = dataVals.reduce((a,b) => a+b, 0);
                const colors = generateColors(labels.length);

                const container = safeGetElement(containerId);
                const canvas = safeGetElement(id);
                if (!container || !canvas) return;

                const dynamicHeight = Math.max(400, labels.length * 50);
                container.style.height = dynamicHeight + 'px';

                activeCharts[id] = new Chart(canvas, {
                    type: 'bar',
                    data: { 
                        labels, 
                        datasets: [{ 
                            data: dataVals, 
                            backgroundColor: colors, 
                            borderRadius: 6, 
                            barPercentage: 0.7 
                        }] 
                    },
                    options: {
                        indexAxis: 'y',
                        maintainAspectRatio: false,
                        layout: { padding: { right: 80 } },
                        plugins: {
                            legend: { display: false },
                            datalabels: {
                                anchor: 'end', 
                                align: 'right',
                                color: '#334155',
                                formatter: (value) => {
                                    const pct = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${value.toLocaleString(undefined, {minimumFractionDigits: 2})}t (${pct}%)`;
                                },
                                font: { size: 12, weight: 'bold', family: 'Sarabun' }
                            },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => {
                                        const val = ctx.raw;
                                        const pct = total > 0 ? ((val / total) * 100).toFixed(1) : 0;
                                        return `${ctx.label}: ${val.toFixed(2)}t (${pct}%)`;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: { display: false },
                            y: { 
                                grid: { display: false }, 
                                ticks: { 
                                    font: { size: 12, weight: '600', family: 'Sarabun' }, 
                                    color: '#475569' 
                                } 
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error drawing bar chart:', error);
            }
        }

        // ============= IMPROVED: TAB SWITCHING =============
        function switchTab(t) {
            try {
                document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                
                const section = safeGetElement('section-' + t);
                const tab = safeGetElement('tab-' + t);
                
                if (section) section.classList.remove('hidden');
                if (tab) tab.classList.add('active');
                
                const titles = {
                    'weight': 'Weight Analysis',
                    'shipment': 'Shipment Operations',
                    'product': 'Product Analysis'
                };
                
                safeSetText('tab-title', titles[t] || 'Dashboard');
            } catch (error) {
                console.error('Error switching tab:', error);
            }
        }

        // ============= IMPROVED: CLEAR FILTERS =============
        function clearAllFilters() {
            try {
                document.querySelectorAll('input[type="checkbox"]').forEach(el => el.checked = false);
                runFilterEngine();
            } catch (error) {
                console.error('Error clearing filters:', error);
            }
        }

        // ============= IMPROVED: CLEANUP ON PAGE UNLOAD =============
        window.addEventListener('beforeunload', () => {
            // Destroy all charts to prevent memory leaks
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) {
                    activeCharts[key].destroy();
                    activeCharts[key] = null;
                }
            });
            
            // Abort any pending fetch
            if (state.fetchController) {
                state.fetchController.abort();
            }
        });

        // ============= INITIALIZATION =============
        window.onload = () => {
            try {
                fetchEverything();
            } catch (error) {
                console.error('Initialization error:', error);
                updateStatus('Initialization Failed', true);
            }
        };
    </script>
</body>
</html>
