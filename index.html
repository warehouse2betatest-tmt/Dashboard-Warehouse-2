<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Warehouse Intelligence - Sarabun Edition</title>
    <!-- Google Fonts: Sarabun -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;800&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #f8fafc; display: flex; height: 100vh; overflow: hidden; font-size: 16px; }
        
        .sidebar { width: 280px; background-color: #1e293b; color: white; flex-shrink: 0; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; overflow: hidden; }
        .sidebar.collapsed { width: 0; padding: 0; opacity: 0; }
        
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; transition: all 0.3s ease-in-out; }
        
        .nav-item { padding: 1.2rem 1.5rem; cursor: pointer; transition: 0.3s; border-left: 5px solid transparent; font-size: 15px; font-weight: 400; letter-spacing: 0.5px; white-space: nowrap; }
        .nav-item:hover { background: #334155; color: #fbbf24; }
        .nav-item.active { background: #334155; color: #fbbf24; border-left-color: #fbbf24; font-weight: 800; }
        
        .filter-menu { display: none; position: absolute; top: 115%; left: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.15); min-width: 260px; z-index: 100; padding: 12px; border: 1px solid #e2e8f0; }
        .filter-menu.active { display: block; }
        .filter-list { max-height: 250px; overflow-y: auto; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .chart-scroll-container::-webkit-scrollbar { height: 8px; }
        .chart-scroll-container::-webkit-scrollbar-track { background: #f1f5f9; }
        .chart-scroll-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .chart-scroll-container::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .truncate { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .max-w-\[200px\] { max-width: 200px; }
        .whitespace-nowrap { white-space: nowrap; }
        
        /* Debug Panel */
        .debug-panel { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: white; padding: 1rem; max-width: 450px; max-height: 400px; overflow-y: auto; font-size: 11px; font-family: monospace; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 9999; }
        .debug-log { margin-bottom: 6px; padding: 6px; border-left: 3px solid #3b82f6; background: #0f172a; border-radius: 4px; }
        .debug-log.error { border-left-color: #ef4444; background: #1a0b0e; }
        .debug-log.success { border-left-color: #10b981; background: #0a1612; }
        .debug-log.warning { border-left-color: #f59e0b; background: #1a1108; }
    </style>
</head>
<body>

    <!-- Debug Panel -->
    <div id="debug-panel" class="debug-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #334155; padding-bottom: 8px;">
            <strong class="text-amber-400">üîç Debug Console</strong>
            <button onclick="this.parentElement.parentElement.style.display='none'" style="background: #334155; padding: 2px 8px; border-radius: 4px; cursor: pointer; color: white; border: none;">Hide</button>
        </div>
        <div id="debug-logs"></div>
    </div>

    <!-- SIDEBAR -->
    <aside id="main-sidebar" class="sidebar shadow-2xl">
        <div class="p-8 border-b border-slate-700">
            <h1 class="text-2xl font-bold text-amber-400 uppercase tracking-tight italic whitespace-nowrap">Ops <span class="text-white">WH2</span></h1>
            <div class="flex items-center mt-3">
                <div id="status-dot" class="w-3 h-3 bg-slate-500 rounded-full mr-2"></div>
                <div id="load-status" class="text-xs text-slate-400 uppercase font-bold tracking-widest whitespace-nowrap">Connecting...</div>
            </div>
        </div>
        <nav class="flex-grow py-6 space-y-1 overflow-y-auto custom-scrollbar">
            <div onclick="switchTab('weight')" id="tab-weight" class="nav-item active">
                <span class="mr-2">‚öñÔ∏è</span> WEIGHT ANALYSIS
            </div>
            <div onclick="switchTab('shipment')" id="tab-shipment" class="nav-item">
                <span class="mr-2">üöö</span> SHIPMENT OPERATIONS
            </div>
            <div onclick="switchTab('product')" id="tab-product" class="nav-item">
                <span class="mr-2">üì¶</span> PRODUCT & CUSTOMER
            </div>
            <div onclick="switchTab('loading')" id="tab-loading" class="nav-item">
                <span class="mr-2">‚è±Ô∏è</span> LOADING TIME
            </div>
            <div onclick="switchTab('milkrun')" id="tab-milkrun" class="nav-item">
                <span class="mr-2">üõª</span> MILK RUN
            </div>
        </nav>
        <div class="p-6 border-t border-slate-700 bg-slate-800/50">
            <button onclick="fetchEverything()" class="w-full bg-amber-500 hover:bg-amber-600 text-slate-900 text-sm font-extrabold py-3 rounded-xl mb-3 flex items-center justify-center transition-all shadow-lg shadow-amber-500/20 transform hover:scale-[1.02]">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                REFRESH DATA
            </button>
            <button onclick="testConnection()" class="w-full bg-blue-500 hover:bg-blue-600 text-white text-sm font-bold py-2 rounded-xl mb-4 transition-all">
                üß™ TEST CONNECTION
            </button>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">FG_InOut Rows</span>
                <span id="data-count-info" class="text-sm text-white font-mono font-bold">0</span>
            </div>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">LoadingTime Rows</span>
                <span id="loading-count-info" class="text-sm text-emerald-400 font-mono font-bold">0</span>
            </div>
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs text-slate-400 font-bold uppercase whitespace-nowrap">M_WMS Rows</span>
                <span id="milkrun-count-info" class="text-sm text-blue-400 font-mono font-bold">0</span>
            </div>
            <div class="w-full bg-slate-700 h-2 rounded-full overflow-hidden">
                <div id="progress-bar" class="bg-amber-400 h-full w-0 transition-all duration-300"></div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT -->
    <main class="main-content">
        <!-- LOADING POPUP -->
        <div id="loading-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center">
            <div class="bg-white rounded-3xl p-10 shadow-2xl max-w-md w-full mx-4 text-center">
                <div class="mb-6 flex justify-center">
                    <div id="loading-spinner" class="w-16 h-16 border-4 border-slate-200 border-t-amber-500 rounded-full animate-spin"></div>
                </div>
                <h3 class="text-2xl font-black text-slate-800 mb-3" id="modal-title">Loading Data</h3>
                <p class="text-slate-600 font-medium mb-2" id="modal-subtitle">Connecting to Supabase...</p>
                
                <div class="mt-6 space-y-2 text-left text-sm font-medium">
                    <div class="flex justify-between items-center"><span>üîπ FG_InOut</span><span id="status-inout" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ LoadingTime</span><span id="status-loading" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ M_WMS</span><span id="status-milkrun" class="text-slate-400">Pending...</span></div>
                    <div class="flex justify-between items-center"><span>üîπ M_SAP</span><span id="status-sku" class="text-slate-400">Pending...</span></div>
                </div>
            </div>
        </div>

        <!-- HEADER -->
        <header class="bg-white shadow-sm p-6 sticky top-0 z-40">
            <div class="flex justify-between items-center">
                <h2 id="page-title" class="text-3xl font-black text-slate-800 uppercase tracking-wide">‚öñÔ∏è Weight Analysis</h2>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-xs text-slate-400 font-bold uppercase">Last Updated</div>
                        <div id="last-updated" class="text-sm text-slate-800 font-mono font-bold">Never</div>
                    </div>
                </div>
            </div>
        </header>

        <!-- FILTERS -->
        <section id="filter-section" class="bg-gradient-to-r from-slate-50 to-slate-100 p-6 shadow-sm sticky top-[100px] z-30">
            <div class="grid grid-cols-3 gap-4">
                
                <div class="relative">
                    <button id="filter-btn-month" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üìÖ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Month</span><span id="label-month" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-month" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Month</div>
                        <div id="list-month" class="filter-list space-y-1"></div>
                    </div>
                </div>

                <div class="relative">
                    <button id="filter-btn-flow" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üîÑ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Flow</span><span id="label-flow" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-flow" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Flow</div>
                        <div id="list-flow" class="filter-list space-y-1"></div>
                    </div>
                </div>

                <div class="relative">
                    <button id="filter-btn-transporter" class="w-full flex justify-between items-center bg-white hover:bg-slate-50 text-slate-700 font-bold py-3.5 px-5 rounded-xl border-2 border-slate-200 hover:border-amber-400 transition-all shadow-sm">
                        <div class="flex items-center"><span class="text-2xl mr-3">üöõ</span><span class="text-left"><span class="block text-xs text-slate-400 uppercase font-bold">Transporter</span><span id="label-transporter" class="block text-sm font-extrabold text-slate-800">All</span></span></div>
                        <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="menu-transporter" class="filter-menu custom-scrollbar">
                        <div class="mb-2 font-bold text-slate-700 uppercase text-xs border-b pb-2">Select Transporter</div>
                        <div id="list-transporter" class="filter-list space-y-1"></div>
                    </div>
                </div>

            </div>
        </section>

        <!-- CONTENT TABS -->
        <div class="flex-grow p-6 space-y-6">

            <!-- TAB: WEIGHT ANALYSIS -->
            <div id="content-weight" class="tab-content">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Weight (In)</div>
                        <div id="sum-weight-in" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-rose-500 to-red-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Weight (Out)</div>
                        <div id="sum-weight-out" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-orange-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Combined Total</div>
                        <div id="sum-weight-total" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üîµ Weight by Month (In)</h3>
                        <div class="h-[360px]"><canvas id="chart-month-in"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üî¥ Weight by Month (Out)</h3>
                        <div class="h-[360px]"><canvas id="chart-month-out"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üü¢ Weight by Day (In)</h3>
                        <div class="h-[360px]"><canvas id="chart-day-in"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üü† Weight by Day (Out)</h3>
                        <div class="h-[360px]"><canvas id="chart-day-out"></canvas></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                    <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üîµüî¥ Combined In + Out by Month</h3>
                    <div class="h-[400px]"><canvas id="chart-month-combined"></canvas></div>
                </div>
            </div>

            <!-- TAB: SHIPMENT OPERATIONS -->
            <div id="content-shipment" class="tab-content hidden">
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-violet-500 to-purple-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Trips (In)</div>
                        <div id="sum-trips-in" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Shipments</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Trips (Out)</div>
                        <div id="sum-trips-out" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Shipments</div>
                    </div>
                    <div class="bg-gradient-to-br from-teal-500 to-cyan-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Avg Weight/Trip (In)</div>
                        <div id="avg-weight-in" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-500 to-amber-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Avg Weight/Trip (Out)</div>
                        <div id="avg-weight-out" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üìä Top Transporters (In)</h3>
                        <div class="h-[360px]"><canvas id="pie-trans-in"></canvas></div>
                        <div id="legend-trans-in" class="mt-6 space-y-2 custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üìä Top Transporters (Out)</h3>
                        <div class="h-[360px]"><canvas id="pie-trans-out"></canvas></div>
                        <div id="legend-trans-out" class="mt-6 space-y-2 custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üöö Top Trucks (In)</h3>
                        <div class="h-[360px]"><canvas id="pie-truck-in"></canvas></div>
                        <div id="legend-truck-in" class="mt-6 space-y-2 custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üöö Top Trucks (Out)</h3>
                        <div class="h-[360px]"><canvas id="pie-truck-out"></canvas></div>
                        <div id="legend-truck-out" class="mt-6 space-y-2 custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üì¶ Trips by Day (In)</h3>
                        <div class="h-[360px]"><canvas id="chart-trips-day-in"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üì¶ Trips by Day (Out)</h3>
                        <div class="h-[360px]"><canvas id="chart-trips-day-out"></canvas></div>
                    </div>
                </div>
            </div>

            <!-- TAB: PRODUCT & CUSTOMER -->
            <div id="content-product" class="tab-content hidden">
                <div class="grid grid-cols-3 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-emerald-500 to-green-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Products</div>
                        <div id="sum-products" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Unique SKUs</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-500 to-indigo-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Customers</div>
                        <div id="sum-customers" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Unique Buyers</div>
                    </div>
                    <div class="bg-gradient-to-br from-purple-500 to-pink-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Product Coverage</div>
                        <div id="coverage-pct" class="text-4xl font-black mb-1">0%</div>
                        <div class="text-xs opacity-80 font-medium">Of Master SKU</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üì¶ Top Products (In)</h3>
                        <div class="chart-scroll-container overflow-x-auto">
                            <div id="container-prod-in" style="height: 500px; min-width: 600px;">
                                <canvas id="bar-prod-in"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üì¶ Top Products (Out)</h3>
                        <div class="chart-scroll-container overflow-x-auto">
                            <div id="container-prod-out" style="height: 500px; min-width: 600px;">
                                <canvas id="bar-prod-out"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üë• Top Customers (In)</h3>
                        <div class="chart-scroll-container overflow-x-auto">
                            <div id="container-cust-in" style="height: 500px; min-width: 600px;">
                                <canvas id="bar-cust-in"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üë• Top Customers (Out)</h3>
                        <div class="chart-scroll-container overflow-x-auto">
                            <div id="container-cust-out" style="height: 500px; min-width: 600px;">
                                <canvas id="bar-cust-out"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: LOADING TIME -->
            <div id="content-loading" class="tab-content hidden">
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-cyan-500 to-blue-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Avg Load Time</div>
                        <div id="avg-loadtime" class="text-4xl font-black mb-1">00:00</div>
                        <div class="text-xs opacity-80 font-medium">HH:MM</div>
                    </div>
                    <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Min Load Time</div>
                        <div id="min-loadtime" class="text-4xl font-black mb-1">00:00</div>
                        <div class="text-xs opacity-80 font-medium">HH:MM</div>
                    </div>
                    <div class="bg-gradient-to-br from-red-500 to-rose-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Max Load Time</div>
                        <div id="max-loadtime" class="text-4xl font-black mb-1">00:00</div>
                        <div class="text-xs opacity-80 font-medium">HH:MM</div>
                    </div>
                    <div class="bg-gradient-to-br from-amber-500 to-yellow-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Records</div>
                        <div id="loading-records" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Operations</div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg mb-6">
                    <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">‚è±Ô∏è Loading Time by Day</h3>
                    <div class="h-[400px]"><canvas id="chart-loadtime-day"></canvas></div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üöõ Loading Time by Transporter</h3>
                    <div class="chart-scroll-container overflow-x-auto">
                        <div id="container-loadtime-trans" style="height: 500px; min-width: 600px;">
                            <canvas id="bar-loadtime-trans"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl shadow-lg mt-6">
                    <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üìä Combined: Weight vs Time</h3>
                    <div class="h-[400px]"><canvas id="chart-weight-vs-time"></canvas></div>
                </div>
            </div>

            <!-- TAB: MILK RUN -->
            <div id="content-milkrun" class="tab-content hidden">
                <div class="grid grid-cols-4 gap-6 mb-6">
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Routes</div>
                        <div id="milkrun-routes" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Unique Runs</div>
                    </div>
                    <div class="bg-gradient-to-br from-pink-500 to-fuchsia-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Total Weight</div>
                        <div id="milkrun-weight" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-sky-500 to-blue-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Avg Weight/Route</div>
                        <div id="milkrun-avg" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Tons</div>
                    </div>
                    <div class="bg-gradient-to-br from-teal-500 to-emerald-600 rounded-2xl p-6 shadow-xl text-white">
                        <div class="text-sm font-bold uppercase mb-2 opacity-90">Active Vehicles</div>
                        <div id="milkrun-vehicles" class="text-4xl font-black mb-1">0</div>
                        <div class="text-xs opacity-80 font-medium">Trucks</div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üõª Routes by Month</h3>
                        <div class="h-[360px]"><canvas id="chart-milkrun-month"></canvas></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üì¶ Weight by Month</h3>
                        <div class="h-[360px]"><canvas id="chart-milkrun-weight"></canvas></div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6 mt-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üöõ Top Vehicles</h3>
                        <div class="h-[360px]"><canvas id="pie-milkrun-vehicle"></canvas></div>
                        <div id="legend-milkrun-vehicle" class="mt-6 space-y-2 custom-scrollbar max-h-[300px] overflow-y-auto"></div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h3 class="text-lg font-black text-slate-800 mb-4 uppercase">üìç Top Routes</h3>
                        <div class="chart-scroll-container overflow-x-auto">
                            <div id="container-milkrun-route" style="height: 500px; min-width: 600px;">
                                <canvas id="bar-milkrun-route"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Load Scripts at the end -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <script>
        // ========== DEBUG LOGGING ==========
        const log = (msg, type = 'info') => {
            const time = new Date().toLocaleTimeString();
            const el = document.getElementById('debug-logs');
            if (el) {
                const div = document.createElement('div');
                div.className = `debug-log ${type}`;
                div.textContent = `[${time}] ${msg}`;
                el.insertBefore(div, el.firstChild);
                while (el.children.length > 100) el.removeChild(el.lastChild);
            }
            console.log(`[${type}]`, msg);
        };

        log('üöÄ App starting', 'info');
        log('üì¶ Version: 2.0.0', 'info');

        // Global error handler
        window.addEventListener('error', (event) => {
            log(`üí• Global Error: ${event.message}`, 'error');
            log(`   at ${event.filename}:${event.lineno}:${event.colno}`, 'error');
        });

        window.addEventListener('unhandledrejection', (event) => {
            log(`üí• Unhandled Promise Rejection: ${event.reason}`, 'error');
        });

        // ========== UTILITY FUNCTIONS ==========
        const sanitizeHTML = (str) => {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        };

        const debounce = (func, wait) => {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        };

        const safeParseFloat = (val) => {
            const parsed = parseFloat(val);
            return isNaN(parsed) ? 0 : parsed;
        };

        const safeParsDate = (dateStr) => {
            if (!dateStr) return null;
            const date = new Date(dateStr);
            return isNaN(date.getTime()) ? null : date;
        };

        // ========== SUPABASE CONFIGURATION ==========
        const SUPABASE_URL = 'https://nqnqcctqdfdbizfdgtjk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xbnFjY3RxZGZkYml6ZmRndGprIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzYxNzE2NzcsImV4cCI6MjA1MTc0NzY3N30.AhLr1yp1j-xq3LJ1OZSh1r0LoqoQFZKy7zZsMpHhzHs';
        
        let supabase;
        let isSupabaseReady = false;

        const initSupabase = () => {
            try {
                // Check if library is loaded
                if (typeof window.supabase === 'undefined') {
                    log('‚ùå Supabase library not loaded', 'error');
                    log('‚ö†Ô∏è Make sure scripts are loaded from CDN', 'warning');
                    return false;
                }
                
                // Check if createClient function exists
                if (typeof window.supabase.createClient !== 'function') {
                    log('‚ùå Supabase.createClient not found', 'error');
                    return false;
                }
                
                log('üîß Creating Supabase client...', 'info');
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
                    auth: {
                        persistSession: false,
                        autoRefreshToken: false
                    }
                });
                
                log('‚úÖ Supabase initialized', 'success');
                log(`üìç URL: ${SUPABASE_URL}`, 'info');
                return true;
            } catch (e) {
                log(`‚ùå Init error: ${e.message}`, 'error');
                log(`Stack: ${e.stack}`, 'error');
                return false;
            }
        };

        // ========== STATE MANAGEMENT ==========
        const appState = {
            rawData: [],
            loadingData: [],
            milkrunData: [],
            skuData: [],
            filters: { month: 'All', flow: 'All', transporter: 'All' },
            activeTab: 'weight',
            isLoading: false,
            lastUpdate: null
        };

        const activeCharts = {};

        // ========== TEST CONNECTION ==========
        window.testConnection = async () => {
            log('üß™ Testing connection...', 'info');
            if (!isSupabaseReady && !initSupabase()) {
                alert('‚ùå Supabase not initialized');
                return;
            }

            try {
                log('üì° Querying FG_InOut table...');
                const { data, error, count } = await supabase
                    .from('FG_InOut')
                    .select('*', { count: 'exact', head: true });
                
                if (error) {
                    log(`‚ùå Error: ${error.message}`, 'error');
                    alert(`‚ùå Connection Failed!\n\n${error.message}\n\nCheck:\n1. RLS policies\n2. Table name\n3. API key`);
                } else {
                    log(`‚úÖ Success! ${count} rows`, 'success');
                    alert(`‚úÖ Connected!\n\nTable: FG_InOut\nRows: ${count}`);
                }
            } catch (e) {
                log(`‚ùå Test failed: ${e.message}`, 'error');
                alert(`‚ùå ${e.message}`);
            }
        };

        // ========== DATA FETCHING ==========
        const fetchEverything = async () => {
            if (appState.isLoading) {
                log('‚ö†Ô∏è Already loading', 'warning');
                return;
            }
            
            if (!isSupabaseReady) {
                isSupabaseReady = initSupabase();
                if (!isSupabaseReady) {
                    showError('Cannot initialize Supabase');
                    return;
                }
            }
            
            appState.isLoading = true;
            const modal = document.getElementById('loading-modal');
            if (modal) modal.classList.remove('hidden');

            const updateStatus = (id, text, ok) => {
                const el = document.getElementById(id);
                if (el) {
                    el.textContent = text;
                    el.className = ok ? 'text-emerald-500 font-bold' : 'text-red-500';
                }
            };

            let progress = 0;
            const updateProgress = () => {
                progress += 25;
                document.getElementById('progress-bar').style.width = `${progress}%`;
            };

            try {
                // FG_InOut
                log('üì• Fetching FG_InOut...');
                updateStatus('status-inout', 'Loading...');
                try {
                    const { data, error } = await supabase
                        .from('FG_InOut')
                        .select('*')
                        .order('Date_Time', { ascending: false })
                        .limit(5000);
                    if (error) throw error;
                    appState.rawData = data || [];
                    updateStatus('status-inout', `‚úì ${appState.rawData.length}`, true);
                    log(`‚úÖ Loaded ${appState.rawData.length} rows`, 'success');
                } catch (e) {
                    log(`‚ùå FG_InOut: ${e.message}`, 'error');
                    updateStatus('status-inout', '‚úó Failed', false);
                }
                updateProgress();

                // LoadingTime
                log('üì• Fetching LoadingTime...');
                updateStatus('status-loading', 'Loading...');
                try {
                    const { data, error } = await supabase
                        .from('LoadingTime')
                        .select('*')
                        .order('LoadingDate', { ascending: false })
                        .limit(5000);
                    if (error) throw error;
                    appState.loadingData = data || [];
                    updateStatus('status-loading', `‚úì ${appState.loadingData.length}`, true);
                    log(`‚úÖ Loaded ${appState.loadingData.length} rows`, 'success');
                } catch (e) {
                    log(`‚ùå LoadingTime: ${e.message}`, 'error');
                    updateStatus('status-loading', '‚úó Failed', false);
                }
                updateProgress();

                // M_WMS
                log('üì• Fetching M_WMS...');
                updateStatus('status-milkrun', 'Loading...');
                try {
                    const { data, error } = await supabase
                        .from('M_WMS')
                        .select('*')
                        .limit(5000);
                    if (error) throw error;
                    appState.milkrunData = data || [];
                    updateStatus('status-milkrun', `‚úì ${appState.milkrunData.length}`, true);
                    log(`‚úÖ Loaded ${appState.milkrunData.length} rows`, 'success');
                } catch (e) {
                    log(`‚ùå M_WMS: ${e.message}`, 'error');
                    updateStatus('status-milkrun', '‚úó Failed', false);
                }
                updateProgress();

                // M_SAP
                log('üì• Fetching M_SAP...');
                updateStatus('status-sku', 'Loading...');
                try {
                    const { data, error } = await supabase
                        .from('M_SAP')
                        .select('*')
                        .limit(5000);
                    if (error) throw error;
                    appState.skuData = data || [];
                    updateStatus('status-sku', `‚úì ${appState.skuData.length}`, true);
                    log(`‚úÖ Loaded ${appState.skuData.length} rows`, 'success');
                } catch (e) {
                    log(`‚ùå M_SAP: ${e.message}`, 'error');
                    updateStatus('status-sku', '‚úó Failed', false);
                }
                updateProgress();

                // Update UI
                updateDataCountUI();
                updateLastUpdatedUI();
                buildFilters();
                redrawAll();
                
                setTimeout(() => {
                    if (modal) modal.classList.add('hidden');
                    updateConnectionStatus(true);
                    log('‚úÖ Fetch complete', 'success');
                }, 1000);

            } catch (error) {
                log(`üí• Fatal error: ${error.message}`, 'error');
                showError(error.message);
            } finally {
                appState.isLoading = false;
            }
        };

        // ========== UI UPDATES ==========
        const updateDataCountUI = () => {
            const set = (id, val) => {
                const el = document.getElementById(id);
                if (el) el.textContent = val.toLocaleString();
            };
            set('data-count-info', appState.rawData.length);
            set('loading-count-info', appState.loadingData.length);
            set('milkrun-count-info', appState.milkrunData.length);
        };

        const updateLastUpdatedUI = () => {
            const el = document.getElementById('last-updated');
            if (el && appState.lastUpdate) {
                el.textContent = appState.lastUpdate.toLocaleTimeString('th-TH');
            } else if (el) {
                appState.lastUpdate = new Date();
                el.textContent = appState.lastUpdate.toLocaleTimeString('th-TH');
            }
        };

        const updateConnectionStatus = (connected) => {
            const dot = document.getElementById('status-dot');
            const status = document.getElementById('load-status');
            if (dot) dot.className = `w-3 h-3 rounded-full mr-2 ${connected ? 'bg-emerald-500 animate-pulse' : 'bg-red-500'}`;
            if (status) {
                status.textContent = connected ? 'Connected' : 'Disconnected';
                status.className = `text-xs uppercase font-bold tracking-widest whitespace-nowrap ${connected ? 'text-emerald-400' : 'text-red-400'}`;
            }
        };

        const showError = (message) => {
            log(`üö® ${message}`, 'error');
            const modal = document.getElementById('loading-modal');
            if (modal) {
                modal.classList.remove('hidden');
                document.getElementById('modal-title').textContent = '‚ö†Ô∏è Error';
                document.getElementById('modal-subtitle').textContent = message;
                const spinner = document.getElementById('loading-spinner');
                if (spinner) {
                    spinner.classList.remove('animate-spin');
                    spinner.className = 'text-6xl';
                    spinner.textContent = '‚ö†Ô∏è';
                }
            }
            updateConnectionStatus(false);
        };

        // ========== FILTERING ==========
        const extractMonth = (dateStr) => {
            const date = safeParsDate(dateStr);
            if (!date) return null;
            return date.toLocaleString('en-US', { year: 'numeric', month: 'short' });
        };

        const buildFilters = () => {
            const monthSet = new Set();
            [...appState.rawData, ...appState.loadingData].forEach(r => {
                const m = extractMonth(r.Date_Time || r.LoadingDate);
                if (m) monthSet.add(m);
            });
            populateFilter('month', Array.from(monthSet).sort());

            const flowSet = new Set();
            appState.rawData.forEach(r => { if (r.FLOW) flowSet.add(r.FLOW.trim()); });
            populateFilter('flow', Array.from(flowSet).sort());

            const transSet = new Set();
            [...appState.rawData, ...appState.loadingData].forEach(r => {
                if (r.Transporter) transSet.add(r.Transporter.trim());
            });
            populateFilter('transporter', Array.from(transSet).sort());
        };

        const populateFilter = (type, values) => {
            const list = document.getElementById(`list-${type}`);
            if (!list) return;
            const items = ['All', ...values];
            list.innerHTML = items.map(val => {
                const safe = sanitizeHTML(val);
                return `<div class="filter-item px-3 py-2 rounded-lg hover:bg-slate-100 cursor-pointer transition text-sm font-medium text-slate-700" data-type="${type}" data-value="${safe}">${safe}</div>`;
            }).join('');
        };

        const applyFilters = () => {
            return appState.rawData.filter(row => {
                const monthMatch = appState.filters.month === 'All' || extractMonth(row.Date_Time) === appState.filters.month;
                const flowMatch = appState.filters.flow === 'All' || (row.FLOW && row.FLOW.trim() === appState.filters.flow);
                const transMatch = appState.filters.transporter === 'All' || (row.Transporter && row.Transporter.trim() === appState.filters.transporter);
                return monthMatch && flowMatch && transMatch;
            });
        };

        // ========== TAB SWITCHING ==========
        const switchTab = (tab) => {
            if (appState.activeTab === tab) return;
            appState.activeTab = tab;
            log(`üîÑ Switching to ${tab} tab`);

            document.querySelectorAll('.nav-item').forEach(item => {
                if (item.id === `tab-${tab}`) item.classList.add('active');
                else item.classList.remove('active');
            });

            document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
            const activeContent = document.getElementById(`content-${tab}`);
            if (activeContent) activeContent.classList.remove('hidden');

            const titles = {
                weight: '‚öñÔ∏è Weight Analysis',
                shipment: 'üöö Shipment Operations',
                product: 'üì¶ Product & Customer',
                loading: '‚è±Ô∏è Loading Time',
                milkrun: 'üõª Milk Run'
            };
            document.getElementById('page-title').textContent = titles[tab] || '';

            redrawAll();
        };

        // ========== CHART DRAWING (SIMPLIFIED) ==========
        const redrawAll = () => {
            const filtered = applyFilters();
            
            if (appState.activeTab === 'weight') {
                drawWeightTab(filtered);
            } else if (appState.activeTab === 'shipment') {
                drawShipmentTab(filtered);
            } else if (appState.activeTab === 'product') {
                drawProductTab(filtered);
            } else if (appState.activeTab === 'loading') {
                drawLoadingTab(appState.loadingData);
            } else if (appState.activeTab === 'milkrun') {
                drawMilkrunTab(appState.milkrunData);
            }
        };

        const drawWeightTab = (data) => {
            const inData = data.filter(r => r.FLOW === 'IN');
            const outData = data.filter(r => r.FLOW === 'OUT');

            const sumIn = inData.reduce((s, r) => s + safeParseFloat(r.Weight), 0);
            const sumOut = outData.reduce((s, r) => s + safeParseFloat(r.Weight), 0);

            document.getElementById('sum-weight-in').textContent = (sumIn / 1000).toFixed(2);
            document.getElementById('sum-weight-out').textContent = (sumOut / 1000).toFixed(2);
            document.getElementById('sum-weight-total').textContent = ((sumIn + sumOut) / 1000).toFixed(2);

            if (typeof Chart !== 'undefined') {
                drawSimpleLineChart('chart-month-in', groupByMonth(inData), '#3b82f6');
                drawSimpleLineChart('chart-month-out', groupByMonth(outData), '#ef4444');
                drawSimpleLineChart('chart-day-in', groupByDay(inData), '#10b981');
                drawSimpleLineChart('chart-day-out', groupByDay(outData), '#f59e0b');
                drawCombinedBarChart('chart-month-combined', groupByMonth(inData), groupByMonth(outData));
            }
        };

        const drawShipmentTab = (data) => {
            const inData = data.filter(r => r.FLOW === 'IN');
            const outData = data.filter(r => r.FLOW === 'OUT');

            document.getElementById('sum-trips-in').textContent = inData.length;
            document.getElementById('sum-trips-out').textContent = outData.length;
            
            const avgIn = inData.length > 0 ? inData.reduce((s, r) => s + safeParseFloat(r.Weight), 0) / inData.length / 1000 : 0;
            const avgOut = outData.length > 0 ? outData.reduce((s, r) => s + safeParseFloat(r.Weight), 0) / outData.length / 1000 : 0;
            
            document.getElementById('avg-weight-in').textContent = avgIn.toFixed(2);
            document.getElementById('avg-weight-out').textContent = avgOut.toFixed(2);
        };

        const drawProductTab = (data) => {
            const inData = data.filter(r => r.FLOW === 'IN');
            const outData = data.filter(r => r.FLOW === 'OUT');

            const uniqueProducts = new Set(data.map(r => r.Product_Code)).size;
            const uniqueCustomers = new Set(data.map(r => r.Customer_Name)).size;
            const coverage = appState.skuData.length > 0 ? ((uniqueProducts / appState.skuData.length) * 100).toFixed(1) : 0;

            document.getElementById('sum-products').textContent = uniqueProducts;
            document.getElementById('sum-customers').textContent = uniqueCustomers;
            document.getElementById('coverage-pct').textContent = coverage + '%';
        };

        const drawLoadingTab = (data) => {
            if (data.length === 0) {
                document.getElementById('avg-loadtime').textContent = '00:00';
                document.getElementById('min-loadtime').textContent = '00:00';
                document.getElementById('max-loadtime').textContent = '00:00';
                document.getElementById('loading-records').textContent = '0';
                return;
            }

            const times = data.map(r => safeParseFloat(r.LoadingTime_DEC)).filter(t => t > 0);
            const avg = times.length > 0 ? times.reduce((a, b) => a + b, 0) / times.length : 0;
            const min = times.length > 0 ? Math.min(...times) : 0;
            const max = times.length > 0 ? Math.max(...times) : 0;

            document.getElementById('avg-loadtime').textContent = decToTime(avg);
            document.getElementById('min-loadtime').textContent = decToTime(min);
            document.getElementById('max-loadtime').textContent = decToTime(max);
            document.getElementById('loading-records').textContent = data.length;
        };

        const drawMilkrunTab = (data) => {
            const routes = new Set(data.map(r => r.Route)).size;
            const totalWeight = data.reduce((s, r) => s + safeParseFloat(r.WEIGHT_KG || 0), 0);
            const avgWeight = routes > 0 ? totalWeight / routes / 1000 : 0;
            const vehicles = new Set(data.map(r => r.Truck)).size;

            document.getElementById('milkrun-routes').textContent = routes;
            document.getElementById('milkrun-weight').textContent = (totalWeight / 1000).toFixed(2);
            document.getElementById('milkrun-avg').textContent = avgWeight.toFixed(2);
            document.getElementById('milkrun-vehicles').textContent = vehicles;
        };

        // Helper functions
        const groupByMonth = (data) => {
            const groups = {};
            data.forEach(r => {
                const month = extractMonth(r.Date_Time);
                if (!month) return;
                groups[month] = (groups[month] || 0) + safeParseFloat(r.Weight);
            });
            return groups;
        };

        const groupByDay = (data) => {
            const groups = {};
            data.forEach(r => {
                const date = safeParsDate(r.Date_Time);
                if (!date) return;
                const day = date.toISOString().split('T')[0];
                groups[day] = (groups[day] || 0) + safeParseFloat(r.Weight);
            });
            return groups;
        };

        const decToTime = (dec) => {
            const hours = Math.floor(dec);
            const minutes = Math.round((dec - hours) * 60);
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        };

        const drawSimpleLineChart = (id, groups, color) => {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const sorted = Object.entries(groups).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(e => e[0]);
            const dataVals = sorted.map(e => e[1] / 1000);

            const canvas = document.getElementById(id);
            if (!canvas || typeof Chart === 'undefined') return;

            try {
                activeCharts[id] = new Chart(canvas, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: dataVals,
                            borderColor: color,
                            backgroundColor: color + '20',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (val) => val.toFixed(1) + ' T' }
                            }
                        }
                    }
                });
            } catch (e) {
                log(`‚ùå Chart ${id} error: ${e.message}`, 'error');
            }
        };

        const drawCombinedBarChart = (id, inGroups, outGroups) => {
            if (activeCharts[id]) {
                activeCharts[id].destroy();
                delete activeCharts[id];
            }

            const allMonths = new Set([...Object.keys(inGroups), ...Object.keys(outGroups)]);
            const labels = Array.from(allMonths).sort();
            const inVals = labels.map(m => (inGroups[m] || 0) / 1000);
            const outVals = labels.map(m => (outGroups[m] || 0) / 1000);

            const canvas = document.getElementById(id);
            if (!canvas || typeof Chart === 'undefined') return;

            try {
                activeCharts[id] = new Chart(canvas, {
                    type: 'bar',
                    data: {
                        labels,
                        datasets: [
                            { label: 'IN', data: inVals, backgroundColor: '#3b82f6' },
                            { label: 'OUT', data: outVals, backgroundColor: '#ef4444' }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true },
                            datalabels: { display: false }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { callback: (val) => val.toFixed(1) + ' T' }
                            }
                        }
                    }
                });
            } catch (e) {
                log(`‚ùå Chart ${id} error: ${e.message}`, 'error');
            }
        };

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            log('üìÑ DOM loaded');

            // Filter buttons
            ['month', 'flow', 'transporter'].forEach(type => {
                const btn = document.getElementById(`filter-btn-${type}`);
                const menu = document.getElementById(`menu-${type}`);
                if (btn && menu) {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.filter-menu').forEach(m => {
                            if (m !== menu) m.classList.remove('active');
                        });
                        menu.classList.toggle('active');
                    });
                }
            });

            // Filter items
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-item')) {
                    const type = e.target.getAttribute('data-type');
                    const value = e.target.getAttribute('data-value');
                    appState.filters[type] = value;
                    document.getElementById(`label-${type}`).textContent = value;
                    document.getElementById(`menu-${type}`).classList.remove('active');
                    redrawAll();
                }
            });

            // Close menus
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.filter-menu') && !e.target.closest('[id^="filter-btn-"]')) {
                    document.querySelectorAll('.filter-menu').forEach(m => m.classList.remove('active'));
                }
            });

            // Wait for libraries
            const checkLibraries = () => {
                const chartReady = typeof Chart !== 'undefined';
                const supabaseReady = typeof window.supabase !== 'undefined';
                const supabaseClientReady = supabaseReady && typeof window.supabase.createClient === 'function';
                
                log(`üìö Library Check:`, 'info');
                log(`   Chart.js: ${chartReady ? '‚úÖ' : '‚ùå'}`, chartReady ? 'success' : 'error');
                log(`   Supabase: ${supabaseReady ? '‚úÖ' : '‚ùå'}`, supabaseReady ? 'success' : 'error');
                log(`   Supabase.createClient: ${supabaseClientReady ? '‚úÖ' : '‚ùå'}`, supabaseClientReady ? 'success' : 'error');
                
                if (chartReady && supabaseClientReady) {
                    log('‚úÖ All libraries loaded successfully!', 'success');
                    log('üöÄ Starting data fetch...', 'info');
                    fetchEverything();
                } else {
                    log('‚è≥ Waiting for libraries... retrying in 500ms', 'warning');
                    setTimeout(checkLibraries, 500);
                }
            };
            
            log('‚è∞ Waiting 1 second before checking libraries...', 'info');
            setTimeout(checkLibraries, 1000);
        });

        // Cleanup
        window.addEventListener('beforeunload', () => {
            Object.keys(activeCharts).forEach(key => {
                if (activeCharts[key]) activeCharts[key].destroy();
            });
        });
    </script>
</body>
</html>
