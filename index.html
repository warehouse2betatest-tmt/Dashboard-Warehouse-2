<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WH2 Dashboard - Warehouse Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'DM Sans', 'Sarabun', sans-serif;
            background: #fafafa;
            color: #1a1a1a;
            overflow-x: hidden; /* Prevent accidental horizontal scroll */
        }

        /* Top Navigation */
        .top-nav {
            background: white;
            border-bottom: 1px solid #e5e5e5;
            padding: 0 2rem;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .logo-accent {
            color: #ff6b35;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            gap: 0;
            background: white;
            padding: 0 2rem;
            border-bottom: 2px solid #f5f5f5;
            overflow-x: auto; /* Allow scroll on small screens */
            white-space: nowrap;
        }

        .tab-btn {
            padding: 1rem 1.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            color: #737373;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            color: #1a1a1a;
            background: #fafafa;
        }

        .tab-btn.active {
            color: #ff6b35;
            border-bottom-color: #ff6b35;
        }

        /* Main Content */
        .main-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .stat-card:hover {
            border-color: #d4d4d4;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }

        .stat-label {
            font-size: 13px;
            color: #737373;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1a1a1a;
        }

        .stat-unit {
            font-size: 14px;
            color: #a3a3a3;
            margin-left: 0.5rem;
        }

        /* Chart Cards */
        .chart-card {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 1.5rem;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); /* Adjusted min-width to prevent early wrapping */
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        /* Responsive Charts Grid Adjustment */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            .top-nav {
                padding: 0 1rem;
            }
            .main-container {
                padding: 1rem;
            }
        }

        /* Buttons */
        .btn-primary {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(255, 107, 53, 0.2);
        }

        .btn-primary:hover {
            background: #e55a2b;
            box-shadow: 0 4px 8px rgba(255, 107, 53, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
            padding: 0.625rem 1.25rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            border-color: #d4d4d4;
            background: #fafafa;
        }

        /* Filter Menu */
        .filter-menu {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 0.5rem;
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 0.5rem;
            min-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
        }

        .filter-menu.active {
            display: block;
            animation: fadeIn 0.2s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .filter-option {
            padding: 0.5rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            display: block;
            color: #4b5563;
        }

        .filter-option:hover {
            background: #f3f4f6;
            color: #1a1a1a;
        }

        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #f5f5f5;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online {
            background: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        .status-loading {
            background: #f59e0b;
            box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.2);
        }

        .status-error {
            background: #ef4444;
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.2);
        }

        /* Loading Modal */
        .loading-modal {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.8);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
        }

        .loading-modal.active {
            display: flex;
        }

        .loading-content {
            background: white;
            padding: 2.5rem;
            border-radius: 16px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #f3f4f6;
            text-align: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f4f6;
            border-top-color: #ff6b35;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #fafafa;
        }

        ::-webkit-scrollbar-thumb {
            background: #d4d4d4;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a3a3a3;
        }

        .tab-content {
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tab-content.active {
            display: block;
        }

        /* Accent Colors */
        .accent-orange { border-left: 4px solid #ff6b35; }
        .accent-blue { border-left: 4px solid #3b82f6; }
        .accent-navy { border-left: 4px solid #1e40af; }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="top-nav">
        <div class="logo">
            WH<span class="logo-accent">2</span> <span style="font-weight: 400; font-size: 16px; color: #737373; margin-left: 10px;">Intelligence</span>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
            <div class="status-badge">
                <div class="status-dot status-loading" id="status-indicator"></div>
                <span id="status-text">Connecting...</span>
            </div>
            <button class="btn-primary" onclick="fetchEverything()">
                <span style="margin-right: 5px;">↻</span> Refresh
            </button>
        </div>
    </nav>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-btn active" onclick="switchTab('weight')">Weight Analysis</button>
        <button class="tab-btn" onclick="switchTab('shipment')">Shipment</button>
        <button class="tab-btn" onclick="switchTab('product')">Products</button>
        <button class="tab-btn" onclick="switchTab('loading')">Loading Time</button>
        <button class="tab-btn" onclick="switchTab('milkrun')">Milk Run</button>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Filters -->
        <div style="display: flex; gap: 0.75rem; margin-bottom: 2rem; flex-wrap: wrap; align-items: center;" id="filters-container">
            <!-- Filters will be inserted here -->
            <span style="color: #9ca3af; font-size: 13px; margin-right: 0.5rem;">Filters:</span>
        </div>

        <!-- Weight Analysis Tab -->
        <div id="content-weight" class="tab-content active">
            <div class="stats-row">
                <div class="stat-card accent-orange">
                    <div class="stat-label">Weight Out</div>
                    <div class="stat-value"><span id="card-out-w">0.00</span><span class="stat-unit">Tons</span></div>
                </div>
                <div class="stat-card accent-blue">
                    <div class="stat-label">Weight In</div>
                    <div class="stat-value"><span id="card-in-w">0.00</span><span class="stat-unit">Tons</span></div>
                </div>
                <div class="stat-card accent-navy">
                    <div class="stat-label">Total Handling</div>
                    <div class="stat-value"><span id="card-total-w">0.00</span><span class="stat-unit">Tons</span></div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Weight by Shipment Type</div>
                    <div style="position: relative; height: 350px; width: 100%;">
                        <canvas id="chartWType"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Weight by Truck Type</div>
                    <div style="position: relative; height: 350px; width: 100%;">
                        <canvas id="chartWTruck"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Shipment Tab -->
        <div id="content-shipment" class="tab-content">
            <div class="stats-row">
                <div class="stat-card accent-orange">
                    <div class="stat-label">Shipping (Orders)</div>
                    <div class="stat-value" id="cnt-shipping">0</div>
                </div>
                <div class="stat-card accent-blue">
                    <div class="stat-label">Pickup Self (Orders)</div>
                    <div class="stat-value" id="cnt-pickup">0</div>
                </div>
                <div class="stat-card accent-navy">
                    <div class="stat-label">Inbound (Orders)</div>
                    <div class="stat-value" id="cnt-inbound">0</div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Orders by Truck Type</div>
                <div style="position: relative; height: 350px; width: 100%;">
                    <canvas id="chartCTruck"></canvas>
                </div>
            </div>
        </div>

        <!-- Product Tab -->
        <div id="content-product" class="tab-content">
            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Weight by Group Sale</div>
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="chartGroupSale"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Weight by Product Type</div>
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="chartProdType"></canvas>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Top 10 Products by Weight</div>
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #f5f5f5;">
                                <th style="text-align: left; padding: 1rem; font-weight: 700; font-size: 13px; color: #737373; text-transform: uppercase;">Material</th>
                                <th style="text-align: right; padding: 1rem; font-weight: 700; font-size: 13px; color: #737373; text-transform: uppercase;">Quantity</th>
                                <th style="text-align: right; padding: 1rem; font-weight: 700; font-size: 13px; color: #737373; text-transform: uppercase;">Weight (Tons)</th>
                            </tr>
                        </thead>
                        <tbody id="top-product-list">
                            <!-- Data will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Loading Time Tab -->
        <div id="content-loading" class="tab-content">
            <div class="stats-row">
                <div class="stat-card">
                    <div class="stat-label">Total Loaded Weight</div>
                    <div class="stat-value" id="loading-total-weight">0.00</div>
                    <div class="stat-unit">Tons</div>
                </div>
                <div class="stat-card accent-orange">
                    <div class="stat-label">Peak Day Weight</div>
                    <div class="stat-value" id="loading-peak-weight">0.00</div>
                    <div class="stat-unit">Tons</div>
                </div>
                <div class="stat-card accent-blue">
                    <div class="stat-label">Max Finish Time</div>
                    <div class="stat-value" id="loading-max-time">--:--</div>
                </div>
                <div class="stat-card accent-navy">
                    <div class="stat-label">Avg Finish Time</div>
                    <div class="stat-value" id="loading-avg-time">--:--</div>
                </div>
            </div>

            <div class="chart-card">
                <div class="chart-title">Daily Loading Performance (Weight vs Finish Time)</div>
                <div style="position: relative; height: 500px; width: 100%;">
                    <canvas id="chartLoadingTime"></canvas>
                </div>
            </div>
        </div>

        <!-- Milk Run Tab -->
        <div id="content-milkrun" class="tab-content">
            <div class="stats-row">
                <div class="stat-card accent-orange">
                    <div class="stat-label">Total Trips</div>
                    <div class="stat-value" id="mr-card-count">0</div>
                </div>
                <div class="stat-card accent-blue">
                    <div class="stat-label">Total Weight</div>
                    <div class="stat-value"><span id="mr-card-weight">0.00</span><span class="stat-unit">Tons</span></div>
                </div>
                <div class="stat-card accent-navy">
                    <div class="stat-label">Unique DOs</div>
                    <div class="stat-value" id="mr-card-do">0</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <div class="chart-title">Trips by Time Slot</div>
                    <div style="position: relative; height: 350px; width: 100%;">
                        <canvas id="chartMilkRunTime"></canvas>
                    </div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Depositor Performance</div>
                    <div style="position: relative; height: 350px; width: 100%;">
                        <canvas id="chartDepositorCombo"></canvas>
                    </div>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
                <div class="chart-card">
                    <div class="chart-title">Destinations</div>
                    <div id="list-check-cap" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Depositors</div>
                    <div id="list-depositor" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Details</div>
                    <div id="list-details" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
                <div class="chart-card">
                    <div class="chart-title">Truck Types</div>
                    <div id="list-tt" style="max-height: 300px; overflow-y: auto;"></div>
                </div>
            </div>

            <h3 style="margin: 2rem 0 1rem 0; font-size: 16px; font-weight: 700; color: #1a1a1a;">SAP Analysis</h3>
            <div id="sap-analysis-container" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;"></div>
        </div>
    </div>

    <!-- Loading Modal -->
    <div id="loading-modal" class="loading-modal">
        <div class="loading-content">
            <div class="spinner"></div>
            <div style="text-align: center; font-weight: 700; font-size: 18px; margin-bottom: 0.5rem; color: #1a1a1a;">Syncing Data</div>
            <div id="modal-status" style="text-align: center; color: #737373; font-size: 14px; margin-bottom: 1.5rem;">Initializing connection...</div>
            <div style="background: #f3f4f6; height: 6px; border-radius: 3px; overflow: hidden; width: 100%;">
                <div id="modal-progress" style="background: #ff6b35; height: 100%; width: 0%; transition: width 0.3s ease-out;"></div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        // Ensure Chart DataLabels is registered
        if (typeof ChartDataLabels !== 'undefined') {
            Chart.register(ChartDataLabels);
        }
        
        // Supabase Configuration
        const PROJECT_URL = 'https://gkkboducoidzusriylsq.supabase.co';
        const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdra2JvZHVjb2lkenVzcml5bHNxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5NTgwODEsImV4cCI6MjA4NTUzNDA4MX0.-wdysRXN-YGzAjQgi3mc50WY91VjsZJlXAe7a65MjXw';
        
        let _db = null;

        let masterRaw = { fg: [], load: [], wms: [], sap: [] };
        let activeCharts = {};
        let filters = { m: [], w: [], s: [], t: [], dep: null };

        const f2 = (v) => parseNum(v).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const getVal = (o, keys) => {
            if (!o) return null;
            if (!Array.isArray(keys)) keys = [keys];
            for (let k of keys) {
                if (o[k] !== undefined && o[k] !== null) return o[k];
                const rK = Object.keys(o).find(rk => rk.toLowerCase() === k.toLowerCase());
                if (rK) return o[rK];
            }
            return null;
        };

        const parseNum = (v) => {
            if (!v || v === '-') return 0;
            if (typeof v === 'string') return parseFloat(v.replace(/,/g, '')) || 0;
            return parseFloat(v) || 0;
        };

        const enrich = (data) => {
            return data.map(item => {
                const rawD = getVal(item, ['Date', 'Posting Date', 'Actual Date', 'Goods Issue Date']);
                let m = 'N/A', w = 'N/A';
                if (rawD) {
                    const d = new Date(rawD);
                    if (!isNaN(d)) {
                        m = `${["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][d.getMonth()]}-${d.getFullYear()}`;
                        const s = new Date(d.getFullYear(), 0, 1);
                        w = 'W' + Math.ceil((((d - s) / 86400000) + s.getDay() + 1) / 7);
                    }
                }
                item._m = getVal(item, ['Month']) || m;
                item._w = getVal(item, ['Week', 'สัปดาห์ที่']) || w;
                item._wgt = parseNum(getVal(item, ['Gross weight', 'Weight', 'Weight_Out']));
                item._qty = parseNum(getVal(item, ['Delivery quantity', 'Qty']));
                item._sloc = getVal(item, ['Sloc.']);
                item._stype = getVal(item, ['Shipment type', 'Shipment Type']);
                return item;
            });
        };

        async function fetchTable(name, key) {
            let from = 0; const step = 1000; let more = true;
            while (more) {
                const { data, error } = await _db.from(name).select('*').range(from, from + step - 1);
                if (error) { 
                    console.error(`Error fetching ${name}:`, error); 
                    // Don't break completely, just stop fetching this table
                    break; 
                }
                if (data && data.length > 0) {
                    masterRaw[key].push(...data);
                    from += step;
                    document.getElementById('modal-status').innerText = `Loading ${name}: ${masterRaw[key].length} records`;
                    if (data.length < step) more = false;
                } else more = false;
                
                // Small delay to prevent freezing UI
                await new Promise(r => setTimeout(r, 10));
            }
        }

        async function fetchEverything() {
            // Initialize Supabase if not already done
            if (!_db && window.supabase) {
                _db = window.supabase.createClient(PROJECT_URL, ANON_KEY);
            } else if (!_db) {
                console.error("Supabase library not loaded");
                return;
            }

            const modal = document.getElementById('loading-modal');
            const statusInd = document.getElementById('status-indicator');
            const statusText = document.getElementById('status-text');
            
            modal.classList.add('active');
            statusInd.className = 'status-dot status-loading';
            statusText.innerText = 'Syncing...';
            
            masterRaw = { fg: [], load: [], wms: [], sap: [] };

            try {
                // Sequential fetching to update progress bar accurately
                await fetchTable('FG In-Out', 'fg');
                document.getElementById('modal-progress').style.width = '25%';
                
                await fetchTable('LoadingTime', 'load');
                document.getElementById('modal-progress').style.width = '50%';
                
                await fetchTable('M_WMS', 'wms');
                document.getElementById('modal-progress').style.width = '75%';
                
                await fetchTable('M_SAP', 'sap');
                document.getElementById('modal-progress').style.width = '100%';

                // Process data
                document.getElementById('modal-status').innerText = 'Processing data...';
                
                masterRaw.fg = enrich(masterRaw.fg);
                masterRaw.load = enrich(masterRaw.load);
                masterRaw.wms = enrich(masterRaw.wms);
                masterRaw.sap = enrich(masterRaw.sap);

                statusInd.className = 'status-dot status-online';
                statusText.innerText = 'Online';

                initFilters();
                runEngine();
                
                // Small delay to show 100% completion
                setTimeout(() => {
                    modal.classList.remove('active');
                }, 500);

            } catch (e) {
                console.error(e);
                statusInd.className = 'status-dot status-error';
                statusText.innerText = 'Connection Failed';
                document.getElementById('modal-status').innerText = 'Error: ' + e.message;
                // Keep modal open for a bit so user sees error, then close or keep open
                setTimeout(() => {
                    alert('Error loading data: ' + e.message);
                    modal.classList.remove('active');
                }, 1000);
            }
        }

        function initFilters() {
            const sets = { m: new Set(), w: new Set(), s: new Set(), t: new Set() };
            [...masterRaw.fg, ...masterRaw.wms, ...masterRaw.load].forEach(r => {
                if (r._m && r._m !== 'N/A') sets.m.add(r._m);
                if (r._w && r._w !== 'N/A') sets.w.add(r._w);
                if (r._sloc) sets.s.add(r._sloc);
                if (r._stype) sets.t.add(r._stype);
            });

            const drop = (label, set, k) => {
                const v = Array.from(set).sort();
                if (v.length === 0) return '';
                return `
                    <div style="position: relative;">
                        <button class="btn-secondary" onclick="toggleFilter('${k}')" style="display: flex; align-items: center; justify-content: space-between; min-width: 120px;">
                            <span>${label} ${filters[k].length ? `(${filters[k].length})` : ''}</span>
                            <span style="font-size: 10px; margin-left: 8px;">▼</span>
                        </button>
                        <div id="filter-${k}" class="filter-menu">
                            ${v.map(val => `<label class="filter-option">
                                <input type="checkbox" value="${val}" onchange="toggleVal('${k}', '${val}')" ${filters[k].includes(val)?'checked':''} style="margin-right: 0.5rem; accent-color: #ff6b35;"> 
                                ${val}
                            </label>`).join('')}
                        </div>
                    </div>`;
            };

            document.getElementById('filters-container').innerHTML = 
                '<span style="color: #9ca3af; font-size: 13px; margin-right: 0.5rem; font-weight: 600;">FILTERS:</span>' +
                drop('Month', sets.m, 'm') +
                drop('Week', sets.w, 'w') +
                drop('Sloc', sets.s, 's') +
                drop('Type', sets.t, 't') +
                '<button class="btn-secondary" onclick="clearAllFilters()" style="color: #ef4444; border-color: #fecaca; margin-left: auto;">Reset</button>';
        }

        function toggleFilter(k) {
            const el = document.getElementById(`filter-${k}`);
            const isActive = el.classList.contains('active');
            
            // Close all first
            document.querySelectorAll('.filter-menu').forEach(e => {
                e.classList.remove('active');
            });
            
            // Toggle clicked
            if (!isActive) el.classList.add('active');
        }

        // Close filters when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.filter-menu') && !event.target.closest('.btn-secondary')) {
                document.querySelectorAll('.filter-menu').forEach(el => el.classList.remove('active'));
            }
        });

        function toggleVal(k, val) {
            const idx = filters[k].indexOf(val);
            if (idx >= 0) filters[k].splice(idx, 1); else filters[k].push(val);
            runEngine();
            // Don't re-init filters to keep dropdown open, just update button text
             // But simpler to just keep it open logic or re-render button text. 
             // For this MVP, we will just re-init button text logic if needed, but let's leave it simple.
             // Re-init filters causes dropdown to close. Let's just update the specific button text if we wanted perfection, 
             // but re-running initFilters is safest for sync.
             initFilters(); 
             // Re-open the dropdown
             setTimeout(() => document.getElementById(`filter-${k}`).classList.add('active'), 0);
        }

        function clearAllFilters() {
            filters = { m: [], w: [], s: [], t: [], dep: null };
            initFilters();
            runEngine();
        }

        function runEngine() {
            let d = masterRaw.fg;
            if (filters.m.length) d = d.filter(r => filters.m.includes(r._m));
            if (filters.w.length) d = d.filter(r => filters.w.includes(r._w));
            if (filters.s.length) d = d.filter(r => filters.s.includes(r._sloc));
            if (filters.t.length) d = d.filter(r => filters.t.includes(r._stype));

            renderWeight(d);
            renderShipment(d);
            renderProduct(d);
            renderLoading(d);

            let md = masterRaw.wms;
            // Apply date/week filters to WMS data too if possible (assuming they have _m and _w)
             if (filters.m.length) md = md.filter(r => filters.m.includes(r._m));
             if (filters.w.length) md = md.filter(r => filters.w.includes(r._w));

            if (filters.dep) md = md.filter(r => getVal(r, ['Depositor', 'depositor']) === filters.dep);
            renderMilkRun(md, masterRaw.sap);
        }

        function renderWeight(data) {
            let outW=0, inW=0, gT={}, gTr={};
            data.forEach(r => {
                const w = r._wgt; const t = r._stype || 'N/A';
                if (['จัดส่งให้ลูกค้า','ลูกค้ามารับเอง'].includes(t)) outW += w;
                else if (['รับสินค้าเข้า จาก PO','รับสินค้าเข้า','รับคืนสินค้า'].includes(t)) inW += w;
                gT[t] = (gT[t]||0) + w;
                const tr = getVal(r, ['Type Truck', 'Truck Type']) || 'Unknown'; gTr[tr] = (gTr[tr]||0) + w;
            });
            document.getElementById('card-out-w').innerText = f2(outW/1000);
            document.getElementById('card-in-w').innerText = f2(inW/1000);
            document.getElementById('card-total-w').innerText = f2((outW+inW)/1000);
            draw('chartWType', 'pie', gT, outW+inW, false);
            draw('chartWTruck', 'pie', gTr, outW+inW, false);
        }

        function renderShipment(data) {
            let s=0, p=0, i=0, gTr={};
            data.forEach(r => {
                const t = r._stype;
                if (t === 'จัดส่งให้ลูกค้า') s++;
                else if (t === 'ลูกค้ามารับเอง') p++;
                else if (t === 'รับสินค้าเข้า จาก PO') i++;
                const tr = getVal(r, ['Type Truck', 'Truck Type']) || 'Unknown';
                gTr[tr] = (gTr[tr]||0) + 1;
            });
            document.getElementById('cnt-shipping').innerText = f2(s);
            document.getElementById('cnt-pickup').innerText = f2(p);
            document.getElementById('cnt-inbound').innerText = f2(i);
            draw('chartCTruck', 'pie', gTr, data.length, true);
        }

        function renderProduct(data) {
            let gS={}, gP={}, gM={};
            data.forEach(r => {
                const w = r._wgt;
                gS[getVal(r, 'Group Sale')||'N/A'] = (gS[getVal(r, 'Group Sale')]||0) + w;
                gP[getVal(r, 'Product Type')||'N/A'] = (gP[getVal(r, 'Product Type')]||0) + w;
                const m = getVal(r, 'Material') || 'Unknown';
                if(!gM[m]) gM[m] = {w:0, q:0}; gM[m].w += w; gM[m].q += r._qty;
            });
            draw('chartGroupSale', 'bar', gS, 0, false);
            draw('chartProdType', 'bar', gP, 0, false);
            const top = Object.entries(gM).sort((a,b)=>b[1].w-a[1].w).slice(0, 10);
            document.getElementById('top-product-list').innerHTML = top.map(([k,v]) => `
                <tr style="border-bottom: 1px solid #f5f5f5;">
                    <td style="padding: 1rem; font-weight: 600; color: #1a1a1a;">${k}</td>
                    <td style="padding: 1rem; text-align: right; color: #737373;">${f2(v.q)}</td>
                    <td style="padding: 1rem; text-align: right; font-weight: 700; color: #1a1a1a;">${f2(v.w/1000)}</td>
                </tr>`).join('');
        }

        function renderLoading(data) {
            let tot=0, peak=0, maxT=0, sumT=0, cntT=0, dly={};
            data.forEach(r => {
                const d = getVal(r, 'Date') || 'N/A'; 
                const w = r._wgt; tot += w; 
                if(!dly[d]) dly[d] = {w:0, t:0}; dly[d].w += w;
                const tStr = getVal(r, 'Time Out');
                if (tStr && tStr.includes(':')) {
                    const p = tStr.split(':');
                    const v = parseInt(p[0]) + parseInt(p[1])/60;
                    if (v > dly[d].t) dly[d].t = v;
                }
            });
            Object.values(dly).forEach(v => { if(v.w>peak) peak=v.w; if(v.t>maxT) maxT=v.t; if(v.t>0){sumT+=v.t; cntT++;} });
            document.getElementById('loading-total-weight').innerText = f2(tot/1000); // Conv to Tons
            document.getElementById('loading-peak-weight').innerText = f2(peak/1000); // Conv to Tons
            const fT = (v) => { const h=Math.floor(v); const m=Math.round((v-h)*60); return `${h}:${m<10?'0'+m:m}`; };
            document.getElementById('loading-max-time').innerText = maxT>0?fT(maxT):'--:--';
            document.getElementById('loading-avg-time').innerText = cntT>0?fT(sumT/cntT):'--:--';
            
            const l = Object.keys(dly).sort();
            const ctx = document.getElementById('chartLoadingTime');
            if (activeCharts['load']) activeCharts['load'].destroy();
            
            const targetHours = 20.5;

            activeCharts['load'] = new Chart(ctx, {
                type: 'bar',
                data: { 
                    labels: l, 
                    datasets: [
                        { 
                            label: 'Max Finish Time (Hr)', 
                            data: l.map(i => dly[i].t), 
                            type: 'line', 
                            borderColor: '#ff6b35', 
                            pointBackgroundColor: l.map(i => dly[i].t > targetHours ? '#ef4444' : '#ff6b35'),
                            pointRadius: 4,
                            borderWidth: 2,
                            yAxisID: 'y1', 
                            tension: 0.3,
                            order: 1
                        },
                        { 
                            label: 'Target (20:30)', 
                            data: Array(l.length).fill(targetHours), 
                            type: 'line', 
                            borderColor: '#9ca3af', 
                            borderDash: [5, 5], 
                            pointRadius: 0, 
                            borderWidth: 1, 
                            yAxisID: 'y1',
                            order: 2 
                        },
                        { 
                            label: 'Daily Weight (Tons)', 
                            data: l.map(i => dly[i].w / 1000), 
                            backgroundColor: '#3b82f6', 
                            yAxisID: 'y', 
                            borderRadius: 4,
                            barPercentage: 0.6,
                            order: 3
                        }
                    ]
                },
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 12, family: 'DM Sans' }, padding: 15 } },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1a1a1a',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e5e5',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y;
                                    if (label.includes('Max') || label.includes('Target')) {
                                        const h = Math.floor(value);
                                        const m = Math.round((value - h) * 60);
                                        return `${label}: ${h}:${m < 10 ? '0' + m : m}`;
                                    }
                                    return `${label}: ${f2(value)} Tons`;
                                }
                            }
                        },
                        datalabels: { display: false }
                    },
                    scales: { 
                        y: { position: 'left', title: { display: true, text: 'Tons', font: { weight: '600' } }, grid: { borderDash: [2, 2] } },
                        y1: { 
                            position: 'right', 
                            min: 0, 
                            max: 24, 
                            title: { display: true, text: 'Hour of Day', font: { weight: '600' } }, 
                            grid: { display: false }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderMilkRun(wms, sap) {
            const tp = new Set(), dst = {}, dpt = {}, dtl = {}, tt = {}, st = { comp: {}, canc: {} };
            let tw = 0, tdo = 0;
            const perf = {};

            wms.forEach(r => {
                const id = getVal(r, ['ID Trip', 'IDTrip']) || Math.random();
                tp.add(id);
                const cap = getVal(r, ['Check Capacity', 'CheckCapacity']) || 'Unknown';
                const p = getVal(r, ['Depositor', 'Depositor']) || 'Unknown';
                const w = parseNum(getVal(r, ['Weight', 'Weight'])) / 1000;
                const d = parseInt(getVal(r, ['DO Count', 'DOCount']) || 0);
                const h = getVal(r, ['TT', 'TT'])||'N/A'; tt[h]=(tt[h]||0)+1;
                const rawDet = getVal(r, 'Details') || '';
                if(rawDet.includes(',')) { const parts=rawDet.split(','); if(parts[1]) dtl[parts[1].trim()]=(dtl[parts[1].trim()]||0)+1; }
                const tC = getVal(r, 'ช่วงเวลา Completed'); if(tC&&tC!=='-') st.comp[tC]=(st.comp[tC]||0)+1;
                const tA = getVal(r, 'ช่วงเวลา Cancel'); if(tA&&tA!=='-') st.canc[tA]=(st.canc[tA]||0)+1;
                if(!perf[p]) perf[p]={w:0, do:0}; perf[p].w+=w; perf[p].do+=d;
                dst[cap]=(dst[cap]||0)+1; dpt[p]=(dpt[p]||0)+1; tw+=w; tdo+=d;
            });
            
            document.getElementById('mr-card-count').innerText = f2(tp.size);
            document.getElementById('mr-card-weight').innerText = f2(tw);
            document.getElementById('mr-card-do').innerText = f2(tdo);
            
            const fill = (id, map) => {
                const s = Object.entries(map).sort((a,b)=>b[1]-a[1]);
                document.getElementById(id).innerHTML = s.map(([k,v]) => `
                    <div style="padding: 0.75rem; border-bottom: 1px solid #f5f5f5; display: flex; justify-content: space-between; align-items: center;">
                        <span style="font-weight: 500; color: #1a1a1a; font-size: 13px;">${k}</span>
                        <span style="font-weight: 700; color: #ff6b35; font-size: 14px;">${v}</span>
                    </div>`).join('');
            };
            fill('list-check-cap', dst); fill('list-depositor', dpt); fill('list-details', dtl); fill('list-tt', tt);

            const allSlots = Array.from(new Set([...Object.keys(st.comp), ...Object.keys(st.canc)])).sort();
            const slots = allSlots.filter(s => (st.comp[s] || 0) > 0 || (st.canc[s] || 0) > 0);
            
            const ctxT = document.getElementById('chartMilkRunTime');
            if (activeCharts['mrT']) activeCharts['mrT'].destroy();
            activeCharts['mrT'] = new Chart(ctxT, {
                type: 'bar',
                data: { labels: slots, datasets: [
                    { label: 'Completed', data: slots.map(s=>st.comp[s]||0), backgroundColor: '#3b82f6', borderRadius: 4 },
                    { label: 'Cancelled', data: slots.map(s=>st.canc[s]||0), backgroundColor: '#ff6b35', borderRadius: 4 }
                ]},
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top', labels: { font: { size: 12, family: 'DM Sans' }, padding: 15 } },
                        datalabels: { 
                            color: '#fff', 
                            font: { weight: '700', size: 11 }, 
                            formatter: (value) => value > 0 ? value : '',
                            display: true
                        }
                    },
                    scales: { 
                        x:{stacked:true, grid: {display: false}}, 
                        y:{stacked:true, beginAtZero: true}
                    } 
                }
            });

            const depL = Object.keys(perf).sort();
            const ctxD = document.getElementById('chartDepositorCombo');
            if (activeCharts['mrD']) activeCharts['mrD'].destroy();
            activeCharts['mrD'] = new Chart(ctxD, {
                type: 'bar',
                data: { labels: depL, datasets: [
                    { label: 'DO Count', data: depL.map(l=>perf[l].do), type:'line', borderColor:'#1e40af', yAxisID:'y1', pointRadius:4, borderWidth: 2 },
                    { label: 'Weight (Tons)', data: depL.map(l=>perf[l].w), backgroundColor: '#ff6b35', yAxisID:'y', borderRadius:4 }
                ]},
                options: { 
                    maintainAspectRatio: false, 
                    responsive: true,
                    plugins: { 
                        legend: { position: 'top', labels: { font: { size: 12, family: 'DM Sans' }, padding: 15 } },
                        datalabels: { display: false }
                    },
                    scales: { 
                        y: { position: 'left', title: {display: true, text: 'Weight (Tons)'}},
                        y1:{ position:'right', grid:{display:false}, title: {display: true, text: 'DO Count'} } 
                    }
                }
            });

            const sapG = {}; sap.forEach(r => { const s=getVal(r, ['Check Milk Run', 'CheckMilkRun'])||'Unknown'; sapG[s]=(sapG[s]||0)+1; });
            document.getElementById('sap-analysis-container').innerHTML = Object.entries(sapG).map(([k,v]) => `
                <div class="stat-card accent-orange" style="padding: 1rem;">
                    <div class="stat-label" style="font-size: 11px;">${k}</div>
                    <div class="stat-value" style="font-size: 24px;">${f2(v)}</div>
                </div>`).join('');
        }

        function draw(id, type, map, total, isC) {
            const ctx = document.getElementById(id); if (!ctx) return;
            if (activeCharts[id]) activeCharts[id].destroy();
            const s = Object.entries(map).sort((a,b)=>b[1]-a[1]);
            const l = s.map(x=>x[0]);
            const d = s.map(x=> isC ? x[1] : x[1]/1000);
            
            const colors = ['#ff6b35', '#3b82f6', '#1e40af', '#f59e0b', '#06b6d4', '#8b5cf6', '#10b981', '#ec4899'];

            activeCharts[id] = new Chart(ctx, {
                type, 
                data: { 
                    labels: l, 
                    datasets: [{ 
                        data: d, 
                        backgroundColor: colors, 
                        borderWidth: type==='pie' ? 2 : 0, 
                        borderColor: '#fff', 
                        borderRadius: type==='bar' ? 4 : 0 
                    }] 
                },
                options: {
                    indexAxis: type==='bar'?'y':'x',
                    maintainAspectRatio: false,
                    responsive: true,
                    plugins: { 
                        legend: { 
                            display: type==='pie', 
                            position: 'bottom',
                            labels: { 
                                font: { size: 12, family: 'DM Sans', weight: '500' },
                                padding: 15,
                                usePointStyle: true,
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const realTotal = isC ? total : total/1000;
                                            const pct = realTotal > 0 ? (value / realTotal * 100).toFixed(2) : 0;
                                            return {
                                                text: `${label}: ${f2(value)} (${pct}%)`,
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                hidden: false,
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.9)',
                            titleColor: '#1a1a1a',
                            bodyColor: '#4b5563',
                            borderColor: '#e5e5e5',
                            borderWidth: 1,
                        },
                        datalabels: { 
                            display: type==='pie',
                            color: '#1a1a1a',
                            font: { weight: '700', size: 11 },
                            backgroundColor: 'rgba(255,255,255,0.9)',
                            borderRadius: 4,
                            padding: 6,
                            formatter: (v) => {
                                const realTotal = isC ? total : total/1000;
                                const pct = realTotal > 0 ? (v / realTotal * 100).toFixed(2) : 0;
                                return pct > 2 ? `${pct}%` : '';
                            }
                        }
                    },
                    scales: {
                        x: { display: type==='bar' ? false : false, grid: { display: false } },
                        y: { display: type==='bar' ? true : false, grid: { display: false } }
                    }
                }
            });
        }

        function switchTab(name) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Find the specific button that was clicked if possible, otherwise use logic
            // Simple way: iterate all buttons, check onclick text or add ID. 
            // Better: use event.currentTarget
            if (event) {
                event.currentTarget.classList.add('active');
            }
            document.getElementById(`content-${name}`).classList.add('active');
        }

        // Start
        window.onload = function() {
            setTimeout(fetchEverything, 500); // Small delay to ensure libraries load
        };
    </script>
</body>
</html>
